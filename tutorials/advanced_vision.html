<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF8S7T56G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DF8S7T56G7');
    </script>
    <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Advanced olfaction: Navigating a complex odor plume" href="advanced_olfaction.html" /><link rel="prev" title="Head stabilization" href="head_stabilization.html" />
        <link rel="prefetch" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" as="image" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Connectome-constrained visual system model - NeuroMechFly documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NeuroMechFly documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">NeuroMechFly documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../neuromechfly.html">The NeuroMechFly Model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gallery/index.html">Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_3_forces.html">Estimating contact forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_4_climbing.html">Climbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_8_controller_comparison.html">Controller comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_9_visual_taxis.html">Visual taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_10_odour_taxis.html">Odour Taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_11_head_stabilization.html">Head stabilization on complex terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_12_multimodal_navigation.html">Multimodal navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_13_plume_navigation.html">Plume navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_14_fly_follow_fly.html">Fly chasing with a connectome constrained visual system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gym_basics_and_kinematic_replay.html">Interacting with NeuroMechFly</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpg_controller.html">Controlling locomotion with CPGs</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule_based_controller.html">Rule-based controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_controller.html">Overcome complex terrain with a hybrid controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="turning.html">Encapsulating custom code into Gym environments: A turning controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="vision_basics.html">Vision basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="olfaction_basics.html">Olfaction basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="path_integration.html">Path integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_stabilization.html">Head stabilization</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Connectome-constrained visual system model</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_olfaction.html">Advanced olfaction: Navigating a complex odor plume</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api_ref/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/mdp_specs.html">MDP Task Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/fly.html">Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/arena.html">Arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/state.html">State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/vision.html">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/olfaction.html">Olfaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/preprogrammed.html">Preprogrammed</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api_ref/examples/index.html">FlyGym Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of FlyGym Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/locomotion.html">Locomotion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/vision.html">Advanced Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/olfaction.html">Advanced Olfaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/path_integration.html">Path Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/head_stabilization.html">Head Stabilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/legacy.html">Legacy API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workshop.html">NeuroMechFly Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">NeuroMechFly Live and Outreach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/advanced_vision.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="connectome-constrained-visual-system-model">
<h1>Connectome-constrained visual system model<a class="headerlink" href="#connectome-constrained-visual-system-model" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Authors:</strong> Thomas Ka Chung Lam, Sibo Wang-Chen</p>
<p>The code presented in this notebook has been simplified and
restructured for display in a notebook format. A more complete and
better structured implementation can be found in the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/flygym/examples/">examples folder of
the FlyGym repository on
GitHub</a>.</p>
<p>This tutorial is available in <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> format in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/notebooks">notebooks folder of the FlyGym repository</a>.</p>
</div>
<p><strong>Summary</strong>: In this tutorial, we will (1) simulate two flies in the
same arena, and (2) integrate a connectome-constrained visual system
model <a class="reference external" href="https://doi.org/10.1038/s41586-024-07939-3">(Lappalainen et al.,
2024)</a>
into NeuroMechFly. Combining these, we will simulate a scenario where a
stationary fly observes another fly walking in front of it and examine
the responses of different neurons in the visual system.</p>
<section id="simulation-with-multiple-flies">
<h2>Simulation with multiple flies<a class="headerlink" href="#simulation-with-multiple-flies" title="Link to this heading">¶</a></h2>
<p>In the previous tutorial, we have used <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> to
control the walking fly at a high level of abstraction — instead of
specifying joint movements, we provide a 2D descending drive and rely on
the underlying CPG network and sensory feedback-based correction
mechanism to compute the appropriate joint actions. Details of this
controller was covered in <a class="reference external" href="https://neuromechfly.org/tutorials/turning.html">this
tutorial</a>. One
limitation of this design decision is that the controller is implemented
at the level of the Simulation (recall that <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code>
extends the <code class="docutils literal notranslate"><span class="pre">Simulation</span></code> class). Therefore, it is difficult to model
multiple flies, each driven by a hybrid turning controller, in a single
simulation.</p>
<p>To overcome this limitation, we can implement the core logic of the
hybrid turning controller at the level of the Fly instead (see <a class="reference external" href="https://neuromechfly.org/api_ref/examples/locomotion.html#hybrid-turning-fly">API
reference</a>).
Because we can have multiple Fly objects in the same Simulation, this
approach allows us to separately control multiple <code class="docutils literal notranslate"><span class="pre">HybridTurningFly</span></code>
instances. Let’s spawn two flies: a target fly that walks forward and an
observer fly that observes the target fly perpendicular to the target fly’s
direction of movement.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outputs/advanced_vision/&quot;</span><span class="p">)</span>
<span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym</span><span class="w"> </span><span class="kn">import</span> <span class="n">Camera</span><span class="p">,</span> <span class="n">Simulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.locomotion</span><span class="w"> </span><span class="kn">import</span> <span class="n">HybridTurningFly</span>

<span class="n">timestep</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">target_fly</span> <span class="o">=</span> <span class="n">HybridTurningFly</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">draw_corrections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timestep</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span>
    <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">spawn_orientation</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">observer_fly</span> <span class="o">=</span> <span class="n">HybridTurningFly</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;observer&quot;</span><span class="p">,</span>
    <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">enable_vision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">draw_corrections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timestep</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span>
    <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">spawn_orientation</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="c1"># setting head_stabilization_model to &quot;thorax&quot; will make actuate</span>
    <span class="c1"># neck joints according to actual thorax rotations (i.e., using ideal</span>
    <span class="c1"># head stabilization signals)</span>
    <span class="n">head_stabilization_model</span><span class="o">=</span><span class="s2">&quot;thorax&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="n">attachment_point</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
    <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_top_zoomout&quot;</span><span class="p">,</span>
    <span class="n">attachment_name</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="n">flies</span><span class="o">=</span><span class="p">[</span><span class="n">observer_fly</span><span class="p">,</span> <span class="n">target_fly</span><span class="p">],</span>
    <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span>
    <span class="n">timestep</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can control the movement of the flies separately by passing two sets
of actions, indexed by the fly names. In this example, we will keep the
observer fly stationary and make the target fly walk straight:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>

<span class="n">run_time</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># sec</span>

<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_time</span> <span class="o">/</span> <span class="n">timestep</span><span class="p">)):</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;observer&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># stand still</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># walk forward</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">cam</span><span class="o">.</span><span class="n">save_video</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;two_flies_walking.mp4&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5000/5000 [00:53&lt;00:00, 93.26it/s]
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/advanced_vision/two_flies_walking.mp4" controls="controls" style="max-width: 400px;"></video></section>
<section id="interfacing-neuromechfly-with-a-connectome-constrained-vision-model">
<h2>Interfacing NeuroMechFly with a connectome-constrained vision model<a class="headerlink" href="#interfacing-neuromechfly-with-a-connectome-constrained-vision-model" title="Link to this heading">¶</a></h2>
<p>So far, we have implemented various abstract, algorithmic controllers to
control a diverse range of behaviors in NeuroMechFly. Ultimately, to
gain insights into the real workings of the biological controller, one
would ideally build a controller with artificial neurons that can be
mapped to neuron subtypes in the real fly nervous system. This can, in
principle, be achieved by leveraging newly available brain and VNC
connectomics datasets (see the <a class="reference external" href="https://flywire.ai/">FlyWire</a> project
for the brain, and the
<a class="reference external" href="https://connectomics.hms.harvard.edu/project1">FANC</a> and
<a class="reference external" href="https://www.janelia.org/project-team/flyem/manc-connectome">MANC</a>
projects for the VNC).</p>
<p>To illustrate how this might be accomplished, we will interface
NeuroMechFly a recently established connectome-constrained neural
network model (<a class="reference external" href="https://doi.org/10.1038/s41586-024-07939-3">Lappalainen et al.,
2023</a>;
<a class="reference external" href="https://github.com/TuragaLab/flyvis">code</a>). This study has
constructed an artificial neural network (ANN) representing the retina,
lamina, medulla, lobula plate, and lobula of the fly visual system (see
figure below). The connectivity in this network is informed by the
connectome and, unlike typical ANNs, models biologically meaningful
variables such as voltage.</p>
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/advanced_vision/lappalainen_model_schematic.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/advanced_vision/lappalainen_model_schematic.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/advanced_vision/lappalainen_model_schematic.png?raw=true" style="width: 400px;" />
</a>
<p><em>Image from Lappalainen et al., 2024.</em></p>
<p>We will pass the visual experience of the simulated fly as inputs to
this pretrained model and simulate the activities of real neurons. For
this purpose, we have implemented a <code class="docutils literal notranslate"><span class="pre">RealisticVisionFly</span></code> class that
extends <code class="docutils literal notranslate"><span class="pre">HybridTurningFly</span></code>. Let’s initialize the simulation but
replace the observer fly with an instance of <code class="docutils literal notranslate"><span class="pre">RealisticVisionFly</span></code>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.vision</span><span class="w"> </span><span class="kn">import</span> <span class="n">RealisticVisionFly</span>

<span class="n">target_fly</span> <span class="o">=</span> <span class="n">HybridTurningFly</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
    <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">draw_corrections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timestep</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span>
    <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">spawn_orientation</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">observer_fly</span> <span class="o">=</span> <span class="n">RealisticVisionFly</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;observer&quot;</span><span class="p">,</span>
    <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">spawn_orientation</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">head_stabilization_model</span><span class="o">=</span><span class="s2">&quot;thorax&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="n">attachment_point</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
    <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_top_zoomout&quot;</span><span class="p">,</span>
    <span class="n">attachment_name</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span>
    <span class="n">flies</span><span class="o">=</span><span class="p">[</span><span class="n">observer_fly</span><span class="p">,</span> <span class="n">target_fly</span><span class="p">],</span>
    <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span>
    <span class="n">timestep</span><span class="o">=</span><span class="n">timestep</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can implement the main simulation loop as follows:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">viz_data_all</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obs_hist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">info_hist</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_time</span> <span class="o">/</span> <span class="n">timestep</span><span class="p">)):</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;observer&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># stand still</span>
            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># walk forward</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">obs_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">info_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="n">rendered_img</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">rendered_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">viz_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rendered_image&quot;</span><span class="p">:</span> <span class="n">rendered_img</span><span class="p">,</span>
            <span class="s2">&quot;vision_observation&quot;</span><span class="p">:</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">][</span><span class="s2">&quot;vision&quot;</span><span class="p">],</span>  <span class="c1"># raw visual observation</span>
            <span class="s2">&quot;nn_activities&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">][</span><span class="s2">&quot;nn_activities&quot;</span><span class="p">],</span>  <span class="c1"># neural activities</span>
        <span class="p">}</span>
        <span class="n">viz_data_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">viz_data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5000/5000 [09:20&lt;00:00,  8.92it/s]
</pre></div>
</div>
<p>From the “info” dictionary, we can get the “nn_activities” entry, which
is an extended dictionary containing the current activities of all
neurons simulated in the network. For a complete definition of what the
simulation returns in the observation and “info” dictionary, please
refer to the <a class="reference external" href="https://neuromechfly.org/api_ref/mdp_specs.html">MDP Task Specification
page</a> of the API
reference.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">][</span><span class="s2">&quot;nn_activities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dict_keys</span><span class="p">([</span><span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;R3&#39;</span><span class="p">,</span> <span class="s1">&#39;R4&#39;</span><span class="p">,</span> <span class="s1">&#39;R5&#39;</span><span class="p">,</span> <span class="s1">&#39;R6&#39;</span><span class="p">,</span> <span class="s1">&#39;R7&#39;</span><span class="p">,</span> <span class="s1">&#39;R8&#39;</span><span class="p">,</span> <span class="s1">&#39;L1&#39;</span><span class="p">,</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="s1">&#39;L3&#39;</span><span class="p">,</span> <span class="s1">&#39;L4&#39;</span><span class="p">,</span> <span class="s1">&#39;L5&#39;</span><span class="p">,</span> <span class="s1">&#39;Lawf1&#39;</span><span class="p">,</span> <span class="s1">&#39;Lawf2&#39;</span><span class="p">,</span> <span class="s1">&#39;Am&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;CT1(Lo1)&#39;</span><span class="p">,</span> <span class="s1">&#39;CT1(M10)&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi1&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi2&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi3&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi4&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi9&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi10&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi11&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi12&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi13&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi14&#39;</span><span class="p">,</span> <span class="s1">&#39;Mi15&#39;</span><span class="p">,</span> <span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">,</span> <span class="s1">&#39;T2a&#39;</span><span class="p">,</span> <span class="s1">&#39;T3&#39;</span><span class="p">,</span> <span class="s1">&#39;T4a&#39;</span><span class="p">,</span> <span class="s1">&#39;T4b&#39;</span><span class="p">,</span> <span class="s1">&#39;T4c&#39;</span><span class="p">,</span> <span class="s1">&#39;T4d&#39;</span><span class="p">,</span> <span class="s1">&#39;T5a&#39;</span><span class="p">,</span> <span class="s1">&#39;T5b&#39;</span><span class="p">,</span> <span class="s1">&#39;T5c&#39;</span><span class="p">,</span> <span class="s1">&#39;T5d&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm1&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm2&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm3&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm4&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm5Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm5a&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm5b&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm5c&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm9&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm16&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm20&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm28&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm30&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY3&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY4&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY5a&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY9&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY10&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY13&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY14&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY15&#39;</span><span class="p">,</span> <span class="s1">&#39;TmY18&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>As an example, we can access the activities of the T4a/b/c/d neurons,
which are known for encoding optical flow:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;T4a&quot;</span><span class="p">,</span> <span class="s2">&quot;T4b&quot;</span><span class="p">,</span> <span class="s2">&quot;T4c&quot;</span><span class="p">,</span> <span class="s2">&quot;T4d&quot;</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Take the cell activities of the right eye (index 1)</span>
    <span class="n">cell_activities</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">][</span><span class="s2">&quot;nn_activities&quot;</span><span class="p">][</span><span class="n">cell</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cell_activities</span> <span class="o">=</span> <span class="n">observer_fly</span><span class="o">.</span><span class="n">retina_mapper</span><span class="o">.</span><span class="n">flyvis_to_flygym</span><span class="p">(</span><span class="n">cell_activities</span><span class="p">)</span>

    <span class="c1"># Convert the values of 721 cells to a 2D image</span>
    <span class="n">viz_img</span> <span class="o">=</span> <span class="n">observer_fly</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">hex_pxls_to_human_readable</span><span class="p">(</span><span class="n">cell_activities</span><span class="p">)</span>
    <span class="n">viz_img</span><span class="p">[</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">ommatidia_id_map</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">imshow_obj</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">viz_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">imshow_obj</span><span class="p">,</span>
    <span class="n">cax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;retina_activities.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/advanced_vision/retina_activities.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/advanced_vision/retina_activities.png?raw=true" />
<p>We can also extract the whole time series of cell activities:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_cell_activities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;observer&quot;</span><span class="p">][</span><span class="s2">&quot;nn_activities_arr&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_cell_activities</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">45669</span><span class="p">)</span>
</pre></div>
</div>
<p>… where the shape is (num_timesteps, num_eyes=2,
num_cells_per_eye=45669).</p>
<p>To visualize this block data better, we have implemented a
<code class="docutils literal notranslate"><span class="pre">visualize_vision</span></code> function:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.vision.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">visualize_vision</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>  <span class="c1"># turn off interactive display of image</span>
<span class="n">visualize_vision</span><span class="p">(</span>
    <span class="n">video_path</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;two_flies_walking_vision.mp4&quot;</span><span class="p">,</span>
    <span class="n">retina</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">retina</span><span class="p">,</span>
    <span class="n">retina_mapper</span><span class="o">=</span><span class="n">observer_fly</span><span class="o">.</span><span class="n">retina_mapper</span><span class="p">,</span>
    <span class="n">viz_data_all</span><span class="o">=</span><span class="n">viz_data_all</span><span class="p">,</span>
    <span class="n">fps</span><span class="o">=</span><span class="n">cam</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>99%|█████████▊| 74/75 [01:26&lt;00:01,  1.21s/it]
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/advanced_vision/two_flies_walking_vision.mp4" controls="controls" style="max-width: 700px;"></video></section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="advanced_olfaction.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Advanced olfaction: Navigating a complex odor plume</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="head_stabilization.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Head stabilization</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Neuroengineering Laboratory, EPFL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NeLy-EPFL/flygym" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Connectome-constrained visual system model</a><ul>
<li><a class="reference internal" href="#simulation-with-multiple-flies">Simulation with multiple flies</a></li>
<li><a class="reference internal" href="#interfacing-neuromechfly-with-a-connectome-constrained-vision-model">Interfacing NeuroMechFly with a connectome-constrained vision model</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>