<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF8S7T56G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DF8S7T56G7');
    </script>
    <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Rule-based controller" href="rule_based_controller.html" /><link rel="prev" title="Interacting with NeuroMechFly" href="gym_basics_and_kinematic_replay.html" />
        <link rel="prefetch" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" as="image" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Controlling locomotion with CPGs - NeuroMechFly documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NeuroMechFly documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">NeuroMechFly documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../neuromechfly.html">The NeuroMechFly Model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gallery/index.html">Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_3_forces.html">Estimating contact forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_4_climbing.html">Climbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_8_controller_comparison.html">Controller comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_9_visual_taxis.html">Visual taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_10_odour_taxis.html">Odour Taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_11_head_stabilization.html">Head stabilization on complex terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_12_multimodal_navigation.html">Multimodal navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_13_plume_navigation.html">Plume navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_14_fly_follow_fly.html">Fly chasing with a connectome constrained visual system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gym_basics_and_kinematic_replay.html">Interacting with NeuroMechFly</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Controlling locomotion with CPGs</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule_based_controller.html">Rule-based controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_controller.html">Overcome complex terrain with a hybrid controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="turning.html">Encapsulating custom code into Gym environments: A turning controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="vision_basics.html">Vision basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="olfaction_basics.html">Olfaction basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="path_integration.html">Path integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_stabilization.html">Head stabilization</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_vision.html">Connectome-constrained visual system model</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_olfaction.html">Advanced olfaction: Navigating a complex odor plume</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api_ref/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/mdp_specs.html">MDP Task Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/fly.html">Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/arena.html">Arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/state.html">State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/vision.html">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/olfaction.html">Olfaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/preprogrammed.html">Preprogrammed</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api_ref/examples/index.html">FlyGym Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of FlyGym Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/locomotion.html">Locomotion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/vision.html">Advanced Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/olfaction.html">Advanced Olfaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/path_integration.html">Path Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/head_stabilization.html">Head Stabilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/legacy.html">Legacy API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workshop.html">NeuroMechFly Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">NeuroMechFly Live and Outreach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/cpg_controller.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="controlling-locomotion-with-cpgs">
<h1>Controlling locomotion with CPGs<a class="headerlink" href="#controlling-locomotion-with-cpgs" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Authors:</strong> Sibo Wang-Chen, Femke Hurtak</p>
<p>The code presented in this notebook has been simplified and
restructured for display in a notebook format. A more complete and
better structured implementation can be found in the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/flygym/examples/">examples folder of
the FlyGym repository on
GitHub</a>.</p>
<p>This tutorial is available in <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> format in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/notebooks">notebooks folder of the FlyGym repository</a>.</p>
</div>
<p><strong>Summary:</strong> In this tutorial, we will introduce the concept of Central
Pattern Generators (CPGs) and build a CPG-based model to control walking
of the simulated fly.</p>
<p>Central Pattern Generators (CPGs) are neural circuits that generate
rhythmic output without receiving rhythmic input (see review of CPGs in
insects by <a class="reference external" href="https://doi.org/10.1002/dneu.22738">Mantziaris et al,
2020</a>). CPGs have been identified
in various species as playing a crucial role in locomotion. Their
principles have also been adopted in the realm of robotic motor control
(see review by <a class="reference external" href="https://doi.org/10.1016/j.neunet.2008.03.014">Ijspeert,
2008</a>). It is
hypothesized that CPGs play a more important role in animals whose
locomotion is fast and therefore cannot process decentralized limb
sensory signals in time to adjust their movements (i.e., like
cockroaches running at ~1 m/s!).</p>
<p>In this tutorial, we will start by implementing an oscillator network.
Then, we will use this network to control the stepping of the legs by
mapping the phases of the oscillators to the phases of preprogrammed leg
stepping kinematics. Next, we will plug this oscillator-based controller
into NeuroMechFly to drive locomotion in the physics simulation.
Finally, we will add leg adhesion to the locomotor simulation.</p>
<section id="the-cpg-network">
<h2>The CPG network<a class="headerlink" href="#the-cpg-network" title="Link to this heading">¶</a></h2>
<p>Basic CPGs can be implemented as feedforward networks of oscillators—in
other words, the network behaves without taking into account sensory
feedback. Similar to the formulation from <a class="reference external" href="https://doi.org/10.1126/science.1138353">Ijspeert et al
(2007)</a>, the oscillator
network can be described by the following ordinary differential
equations (ODEs):</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\dot\theta_i = 2\pi\nu_i + \sum_{j} r_j w_{ij} \sin(\theta_j - \theta_i - \phi_{ij})\]</div>
</div>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\dot r_i = \alpha_i (R_i - r_i)\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\theta_i\)</span> and <span class="math notranslate nohighlight">\(r_i\)</span> are the current phase and
magnitude of the i-th oscillator. <span class="math notranslate nohighlight">\(R_i\)</span> is the maximum amplitude
of the i-th oscillator, and <span class="math notranslate nohighlight">\(\alpha_i\)</span> is a constant determining
the rate of convergence to synchrony. <span class="math notranslate nohighlight">\(w_{ij}\)</span> is the coupling
weight between the i-th and the j-th oscillator, and <span class="math notranslate nohighlight">\(\phi_{ij}\)</span>
is the phase bias between them. Intuitively, the first term of the first
equation maintains an intrinsic frequency for each oscillator; the
second term of the first equation keeps the oscillators synchronized
(i.e., maintains the phase differences between the oscillators), and the
second equation maintains the amplitudes of the oscillators.</p>
<p>To start, let’s write a function that computes <span class="math notranslate nohighlight">\(\dot\theta\)</span> and
<span class="math notranslate nohighlight">\(\dot r\)</span>. For explicitness, we will implement the CPG network
using only Python and NumPy (no <code class="docutils literal notranslate"><span class="pre">scipy.integrate</span></code>).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calculate_ddt</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given the current state variables theta, r and network parameters</span>
<span class="sd">    w, phi, nu, R, alpha, calculate the time derivatives of theta and r.&quot;&quot;&quot;</span>
    <span class="n">intrinsic_term</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">nu</span>
    <span class="n">phase_diff</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">theta</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">coupling_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase_diff</span> <span class="o">-</span> <span class="n">phi</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dtheta_dt</span> <span class="o">=</span> <span class="n">intrinsic_term</span> <span class="o">+</span> <span class="n">coupling_term</span>
    <span class="n">dr_dt</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtheta_dt</span><span class="p">,</span> <span class="n">dr_dt</span>
</pre></div>
</div>
<p>Next, let’s implement the CPG as a class. We will use <a class="reference external" href="https://en.wikipedia.org/wiki/Euler_method">Euler’s
method</a> to integrate the
ODE, but you can use any higher-order methods or libraries.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CPGNetwork</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">timestep</span><span class="p">,</span>
        <span class="n">intrinsic_freqs</span><span class="p">,</span>
        <span class="n">intrinsic_amps</span><span class="p">,</span>
        <span class="n">coupling_weights</span><span class="p">,</span>
        <span class="n">phase_biases</span><span class="p">,</span>
        <span class="n">convergence_coefs</span><span class="p">,</span>
        <span class="n">init_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">init_magnitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a CPG network consisting of N oscillators.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timestep : float</span>
<span class="sd">            The timestep of the simulation.</span>
<span class="sd">        intrinsic_freqs : np.ndarray</span>
<span class="sd">            The intrinsic frequencies of the oscillators, shape (N,).</span>
<span class="sd">        intrinsic_amps : np.ndarray</span>
<span class="sd">            The intrinsic amplitude of the oscillators, shape (N,).</span>
<span class="sd">        coupling_weights : np.ndarray</span>
<span class="sd">            The coupling weights between the oscillators, shape (N, N).</span>
<span class="sd">        phase_biases : np.ndarray</span>
<span class="sd">            The phase biases between the oscillators, shape (N, N).</span>
<span class="sd">        convergence_coefs : np.ndarray</span>
<span class="sd">            Coefficients describing the rate of convergence to oscillator</span>
<span class="sd">            intrinsic amplitudes, shape (N,).</span>
<span class="sd">        init_phases : np.ndarray, optional</span>
<span class="sd">            Initial phases of the oscillators, shape (N,). The phases are</span>
<span class="sd">            randomly initialized if not provided.</span>
<span class="sd">        init_magnitudes : np.ndarray, optional</span>
<span class="sd">            Initial magnitudes of the oscillators, shape (N,). The</span>
<span class="sd">            magnitudes are randomly initialized if not provided.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            The random seed to use for initializing the phases and</span>
<span class="sd">            magnitudes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span> <span class="o">=</span> <span class="n">intrinsic_freqs</span><span class="o">.</span><span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_freqs</span> <span class="o">=</span> <span class="n">intrinsic_freqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_amps</span> <span class="o">=</span> <span class="n">intrinsic_amps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coupling_weights</span> <span class="o">=</span> <span class="n">coupling_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_biases</span> <span class="o">=</span> <span class="n">phase_biases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence_coefs</span> <span class="o">=</span> <span class="n">convergence_coefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">init_phases</span><span class="p">,</span> <span class="n">init_magnitudes</span><span class="p">)</span>

        <span class="c1"># Check if the parameters have the right shape</span>
        <span class="k">assert</span> <span class="n">intrinsic_freqs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">,)</span>
        <span class="k">assert</span> <span class="n">coupling_weights</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">phase_biases</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">convergence_coefs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">,)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_phases</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">,)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_magnitudes</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Integrate the ODEs using Euler&#39;s method.&quot;&quot;&quot;</span>
        <span class="n">dtheta_dt</span><span class="p">,</span> <span class="n">dr_dt</span> <span class="o">=</span> <span class="n">calculate_ddt</span><span class="p">(</span>
            <span class="n">theta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">,</span>
            <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_magnitudes</span><span class="p">,</span>
            <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coupling_weights</span><span class="p">,</span>
            <span class="n">phi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_biases</span><span class="p">,</span>
            <span class="n">nu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_freqs</span><span class="p">,</span>
            <span class="n">R</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_amps</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence_coefs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_phases</span> <span class="o">+=</span> <span class="n">dtheta_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_magnitudes</span> <span class="o">+=</span> <span class="n">dr_dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_magnitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the phases and magnitudes of the oscillators.</span>
<span class="sd">        High magnitudes and unfortunate phases might cause physics error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">init_phases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_phases</span> <span class="o">=</span> <span class="n">init_phases</span>

        <span class="k">if</span> <span class="n">init_magnitudes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cpgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_magnitudes</span> <span class="o">=</span> <span class="n">init_magnitudes</span>
</pre></div>
</div>
<p>To demonstrate this network, let’s simulate a network of three
oscillators connected as follows:</p>
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/simple_cpg.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/simple_cpg.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/simple_cpg.png?raw=true" style="width: 500px;" />
</a>
<p>For the sake of illustration, let’s make them oscillate at an intrinsic
frequency of 1 and intrinsic amplitudes of 1.0, 1.1, 1.2. They are
coupled with a weight of 1 and phase differences of 120 degrees. We will
initialize the phases and magnitudes randomly.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intrinsic_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">intrinsic_amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>
<span class="n">coupling_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">phase_biases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">convergence_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">CPGNetwork</span><span class="p">(</span>
    <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
    <span class="n">intrinsic_freqs</span><span class="o">=</span><span class="n">intrinsic_freqs</span><span class="p">,</span>
    <span class="n">intrinsic_amps</span><span class="o">=</span><span class="n">intrinsic_amps</span><span class="p">,</span>
    <span class="n">coupling_weights</span><span class="o">=</span><span class="n">coupling_weights</span><span class="p">,</span>
    <span class="n">phase_biases</span><span class="o">=</span><span class="n">phase_biases</span><span class="p">,</span>
    <span class="n">convergence_coefs</span><span class="o">=</span><span class="n">convergence_coefs</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">num_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">/</span> <span class="n">network</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
<span class="n">phase_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">magnitude_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Simulate the network</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
    <span class="n">network</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">phase_hist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">curr_phases</span>
    <span class="n">magnitude_hist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">curr_magnitudes</span>
</pre></div>
</div>
<p>We can visualize the phases (wrapped to <span class="math notranslate nohighlight">\([0, 2\pi]\)</span>) and the
magnitudes of the oscillators over time. We observe that, after a brief
period of synchronization, the oscillators converge to a state where
they oscillate 1/3 of a cycle apart at their intrinsic frequencies and
amplitudes.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./outputs/cpg_controller&quot;</span><span class="p">)</span>
<span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span> <span class="o">*</span> <span class="n">network</span><span class="o">.</span><span class="n">timestep</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">phase_hist</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$2\pi$&quot;</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">magnitude_hist</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;simple_cpg_rollout.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/simple_cpg_rollout.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/simple_cpg_rollout.png?raw=true" />
<p>We have now built a CPG network. In the next section, we address how the
states of the CPGs can be used to drive locomotion.</p>
</section>
<section id="controlling-leg-stepping-with-cpgs">
<h2>Controlling leg stepping with CPGs<a class="headerlink" href="#controlling-leg-stepping-with-cpgs" title="Link to this heading">¶</a></h2>
<p>The state variables <span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(r\)</span> can be used to drive
locomotion at various levels of abstraction. This is a design choice
that the modeler should make depending on the scientific question being
considered. For example, in <a class="reference external" href="https://doi.org/10.1038/s41592-022-01466-7">Lobato-Rios et al
(2022)</a>, the CPG states
are used to calculate motor neuron activity
<span class="math notranslate nohighlight">\(M_i = r_i (1 + \sin(\theta_i))\)</span>, which is in turn used to drive a
muscle model. By contrast, <a class="reference external" href="https://doi.org/10.1126/science.1138353">Ijspeert et al
(2007)</a> uses a more abstract
control strategy — the CPG states directly control the target joint
<em>position</em> (i.e. angle) <span class="math notranslate nohighlight">\(x_i = r_i (1 + \cos(\theta_i))\)</span>. This
target position is then provided to a <a class="reference external" href="https://www.matthewpeterkelly.com/tutorials/pdControl/index.html">proportional-derivative (PD)
controller</a>
which actuates the joint.</p>
<p>Here, we will use an even higher-level control approach where each
oscillator controls the stepping of an entire leg (as opposed to a
joint). The phase of the CPG represents the phase of the step (i.e. how
far into the step the leg is), while the magnitude of the CPG represents
the magnitude of the step (i.e. how large the step is). We will use
experimentally recorded data to execute the individual steps. In other
words, we will extract the kinematics of a single step for each leg from
experimental behavior recordings and modify its magnitude (modulated by
<span class="math notranslate nohighlight">\(r\)</span>) and speed (modulated by <span class="math notranslate nohighlight">\(\theta\)</span>) so that the stepping
of the six legs is coordinated by the CPG network.</p>
<p>We will set the coupling parameters for locomotion using a “tripod
gait”: at each point in time, the fore and hind legs on one side and the
mid leg on the other side of the body are in stance, forming a stable
tripod-shaped structure; the other three legs are in swing. This is
illustrated in the figure below (left, figure adapted from <a class="reference external" href="https://doi.org/10.3389/fphys.2020.00135">Emanuel et
al, 2020</a>). The tripod gait
can be implemented using a CPG network shown on the right. We observe
that the legs that should <em>not</em> swing together are coupled with a phase
difference of 180 degrees, ensuring that they are out of phase once the
network is synchronized. We will use other parameters from the
<a class="reference external" href="https://www.nature.com/articles/s41592-024-02497-y.epdf?sharing_token=jK2FbKWL99-O28WNqrpXWNRgN0jAjWel9jnR3ZoTv0MjiFZczOI3_5wYVxbEbClrTuJzjKyEfhm2kIwso489-ypEsSqlyasWAEsBCvR9WU5poT-q2bblI6hCc7Zji6wb_jZjfXl7KWLbd2pgZTmWvk_ADQ6RuzlnHwvQyipMJzg%3D">NeuroMechFly v2
paper</a>.</p>
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/tripod_cpg.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/tripod_cpg.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/tripod_cpg.png?raw=true" style="width: 600px;" />
</a>
<p>As before, we will set up the CPG network, run the simulation, and plot
the time series of the state variables:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intrinsic_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span>
<span class="n">intrinsic_amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
<span class="n">phase_biases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">coupling_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_biases</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">convergence_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">CPGNetwork</span><span class="p">(</span>
    <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
    <span class="n">intrinsic_freqs</span><span class="o">=</span><span class="n">intrinsic_freqs</span><span class="p">,</span>
    <span class="n">intrinsic_amps</span><span class="o">=</span><span class="n">intrinsic_amps</span><span class="p">,</span>
    <span class="n">coupling_weights</span><span class="o">=</span><span class="n">coupling_weights</span><span class="p">,</span>
    <span class="n">phase_biases</span><span class="o">=</span><span class="n">phase_biases</span><span class="p">,</span>
    <span class="n">convergence_coefs</span><span class="o">=</span><span class="n">convergence_coefs</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Simulate the network</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">network</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
<span class="n">phase_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">magnitude_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_steps</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
    <span class="n">network</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">phase_hist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">curr_phases</span>
    <span class="n">magnitude_hist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">curr_magnitudes</span>

<span class="c1"># Visualize</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span> <span class="o">*</span> <span class="n">network</span><span class="o">.</span><span class="n">timestep</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">phase_hist</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$2\pi$&quot;</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">magnitude_hist</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;tripod_cpg_rollout.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/tripod_cpg_rollout.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/tripod_cpg_rollout.png?raw=true" />
<p>Now, let’s load the behavior kinematics data:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_data_path</span>

<span class="n">single_steps_path</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">get_data_path</span><span class="p">(</span><span class="s2">&quot;flygym&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;behavior/single_steps_untethered.pkl&quot;</span>
<span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">single_steps_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">single_steps_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>This gives us a dictionary containing joint angle time series for each
joint. We will check if they all have the same length. The steps should
be periodic, so we will also check if the first and last angles in the
time series are the same:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprogrammed_steps_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">single_steps_data</span><span class="p">[</span><span class="s2">&quot;joint_LFCoxa&quot;</span><span class="p">])</span>
<span class="n">preprogrammed_steps_timestep</span> <span class="o">=</span> <span class="n">single_steps_data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">][</span><span class="s2">&quot;timestep&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Preprogrammed steps have a length of </span><span class="si">{</span><span class="n">preprogrammed_steps_length</span><span class="si">}</span><span class="s2"> steps &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;at dt=</span><span class="si">{</span><span class="n">preprogrammed_steps_timestep</span><span class="si">}</span><span class="s2">s.&quot;</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">single_steps_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;joint_&quot;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">preprogrammed_steps_length</span>
        <span class="k">assert</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Preprogrammed</span> <span class="n">steps</span> <span class="n">have</span> <span class="n">a</span> <span class="n">length</span> <span class="n">of</span> <span class="mi">45</span> <span class="n">steps</span> <span class="n">at</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.003</span><span class="n">s</span><span class="o">.</span>
</pre></div>
</div>
<p>Now, for each leg <span class="math notranslate nohighlight">\(i\)</span>, let’s build a function <span class="math notranslate nohighlight">\(\Psi_i\)</span> such
that given the current stepping phase <span class="math notranslate nohighlight">\(\theta_i\)</span> of the leg,
<span class="math notranslate nohighlight">\(\Psi_i(\theta_i)\)</span> provides joint angles of all DoFs on leg
<span class="math notranslate nohighlight">\(i\)</span> based on the preprogrammed stepping kinematics. We will do
this by interpolation and normalize <span class="math notranslate nohighlight">\(\theta\)</span> to the range
<span class="math notranslate nohighlight">\([0, 2\pi)\)</span>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">CubicSpline</span>

<span class="n">legs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">side</span><span class="si">}{</span><span class="n">pos</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">side</span> <span class="ow">in</span> <span class="s2">&quot;LR&quot;</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="s2">&quot;FMH&quot;</span><span class="p">]</span>
<span class="n">dofs_per_leg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Coxa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Coxa_roll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Coxa_yaw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Femur&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Femur_roll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tibia&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">phase_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">preprogrammed_steps_length</span><span class="p">)</span>
<span class="n">psi_funcs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">legs</span><span class="p">:</span>
    <span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">single_steps_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;joint_</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">dof</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">dofs_per_leg</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">]</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">phase_grid</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bc_type</span><span class="o">=</span><span class="s2">&quot;periodic&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can then map the phase of the CPGs to the phase of the legs. Let’s
visualize three stepping cycles for each leg:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="n">joint_angles_by_leg</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">leg</span><span class="p">,</span> <span class="n">psi_func</span> <span class="ow">in</span> <span class="n">psi_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">joint_angles_by_leg</span><span class="p">[</span><span class="n">leg</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_func</span><span class="p">(</span><span class="n">theta_ts</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i_side</span><span class="p">,</span> <span class="n">side</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;LR&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;FMH&quot;</span><span class="p">):</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">side</span><span class="si">}{</span><span class="n">pos</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i_pos</span><span class="p">,</span> <span class="n">i_side</span><span class="p">]</span>
        <span class="n">psi_func</span> <span class="o">=</span> <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">]</span>
        <span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">joint_angles_by_leg</span><span class="p">[</span><span class="n">leg</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i_dof</span><span class="p">,</span> <span class="n">dof_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">):</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">dof_name</span> <span class="k">if</span> <span class="n">i_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_side</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_ts</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">[</span><span class="n">i_dof</span><span class="p">,</span> <span class="p">:],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_pos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">$\pi$&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">i_side</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;DoF angle ($\degree$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2"> leg&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;three_steps_phase_only.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/three_steps_phase_only.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/three_steps_phase_only.png?raw=true" />
<p>We can also modulate the amplitude of the steps using the magnitude
<span class="math notranslate nohighlight">\(r\)</span> of the CPGs. To do this, we take the difference of the joint
angles from the neutral positions and scale it by <span class="math notranslate nohighlight">\(r\)</span>. The final
joint positions are therefore <span class="math notranslate nohighlight">\(\Psi_0 + r(\Psi - \Psi_0)\)</span>. We will
use the beginnings of the preprogrammed steps (right before the start of
the swing) as the neutral positions.</p>
<p>Let’s repeat the previous exercise, but gradually ramp up the amplitude
from 0 to 1:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">r_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="c1">##### THIS SECTION HAS CHANGED #####</span>
<span class="n">joint_angles_by_leg</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">leg</span><span class="p">,</span> <span class="n">psi_func</span> <span class="ow">in</span> <span class="n">psi_funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">neutral_pos</span> <span class="o">=</span> <span class="n">psi_func</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">joint_angles_by_leg</span><span class="p">[</span><span class="n">leg</span><span class="p">]</span> <span class="o">=</span> <span class="n">neutral_pos</span> <span class="o">+</span> <span class="n">r_ts</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi_func</span><span class="p">(</span><span class="n">theta_ts</span><span class="p">)</span> <span class="o">-</span> <span class="n">neutral_pos</span><span class="p">)</span>
<span class="c1">####################################</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i_side</span><span class="p">,</span> <span class="n">side</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;LR&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i_pos</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;FMH&quot;</span><span class="p">):</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">side</span><span class="si">}{</span><span class="n">pos</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i_pos</span><span class="p">,</span> <span class="n">i_side</span><span class="p">]</span>
        <span class="n">psi_func</span> <span class="o">=</span> <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">]</span>
        <span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">joint_angles_by_leg</span><span class="p">[</span><span class="n">leg</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i_dof</span><span class="p">,</span> <span class="n">dof_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">):</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">dof_name</span> <span class="k">if</span> <span class="n">i_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i_side</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_ts</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">[</span><span class="n">i_dof</span><span class="p">,</span> <span class="p">:],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_pos</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">$\pi$&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">i_side</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;DoF angle ($\degree$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2"> leg&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;three_steps_amp_modulated.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/three_steps_amp_modulated.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/three_steps_amp_modulated.png?raw=true" />
<p>We have now built the individual elements of the controller:</p>
<ul class="simple">
<li><p>On the level of inter-leg coordination, the CPG network controls the
phase <span class="math notranslate nohighlight">\(\theta\)</span> of each leg of the magnitude <span class="math notranslate nohighlight">\(r\)</span> of its
steps.</p></li>
<li><p>On the level of per-leg kinematics, we find the corresponding joint
states at the phase <span class="math notranslate nohighlight">\(\theta\)</span> based on experimentally recorded
data, scaled by the amplitude <span class="math notranslate nohighlight">\(r\)</span>.</p></li>
</ul>
<p>In the next section, we will piece these components together and plug
them into the physics simulation.</p>
</section>
<section id="plugging-the-controller-into-the-simulation">
<h2>Plugging the controller into the simulation<a class="headerlink" href="#plugging-the-controller-into-the-simulation" title="Link to this heading">¶</a></h2>
<p>We will now put everything together and control the simulated fly using
the controller that we have designed. The following content assumes that
you have read the tutorial <a class="reference external" href="https://neuromechfly.org/tutorials/gym_basics_and_kinematic_replay.html">“Interacting with
NeuroMechFly”</a>.</p>
<p>We start by initializing the simulation:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fly</span><span class="p">,</span> <span class="n">ZStabilizedCamera</span><span class="p">,</span> <span class="n">SingleFlySimulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.preprogrammed</span><span class="w"> </span><span class="kn">import</span> <span class="n">all_leg_dofs</span>

<span class="n">run_time</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span><span class="n">init_pose</span><span class="o">=</span><span class="s2">&quot;stretch&quot;</span><span class="p">,</span> <span class="n">actuated_joints</span><span class="o">=</span><span class="n">all_leg_dofs</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">)</span>
<span class="n">cam</span> <span class="o">=</span> <span class="n">ZStabilizedCamera</span><span class="p">(</span>
    <span class="n">attachment_point</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span> <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_left&quot;</span><span class="p">,</span>
    <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">SingleFlySimulation</span><span class="p">(</span><span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span> <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
</pre></div>
</div>
<p>We will also initialize a CPG network:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intrinsic_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span>
<span class="n">intrinsic_amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
<span class="n">phase_biases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">coupling_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_biases</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">convergence_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

<span class="n">cpg_network</span> <span class="o">=</span> <span class="n">CPGNetwork</span><span class="p">(</span>
    <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
    <span class="n">intrinsic_freqs</span><span class="o">=</span><span class="n">intrinsic_freqs</span><span class="p">,</span>
    <span class="n">intrinsic_amps</span><span class="o">=</span><span class="n">intrinsic_amps</span><span class="p">,</span>
    <span class="n">coupling_weights</span><span class="o">=</span><span class="n">coupling_weights</span><span class="p">,</span>
    <span class="n">phase_biases</span><span class="o">=</span><span class="n">phase_biases</span><span class="p">,</span>
    <span class="n">convergence_coefs</span><span class="o">=</span><span class="n">convergence_coefs</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">swing_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">swing_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legs</span><span class="p">):</span>
    <span class="n">swing_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_steps_data</span><span class="p">[</span><span class="s2">&quot;swing_stance_time&quot;</span><span class="p">][</span><span class="s2">&quot;swing&quot;</span><span class="p">][</span><span class="n">leg</span><span class="p">]</span>
    <span class="n">swing_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_steps_data</span><span class="p">[</span><span class="s2">&quot;swing_stance_time&quot;</span><span class="p">][</span><span class="s2">&quot;stance&quot;</span><span class="p">][</span><span class="n">leg</span><span class="p">]</span>
<span class="n">swing_start</span> <span class="o">/=</span> <span class="n">preprogrammed_steps_length</span> <span class="o">*</span> <span class="n">preprogrammed_steps_timestep</span>
<span class="n">swing_start</span> <span class="o">*=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">swing_end</span> <span class="o">/=</span> <span class="n">preprogrammed_steps_length</span> <span class="o">*</span> <span class="n">preprogrammed_steps_timestep</span>
<span class="n">swing_end</span> <span class="o">*=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<span class="c1"># have the rest phase in between the swing and stance phase (as the data starts with swing initiation)</span>
<span class="n">psi_rest_phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">swing_start</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legs</span><span class="p">):</span>
    <span class="n">psi_rest_phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">swing_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Let’s run the simulation:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>

<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_time</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)):</span>
    <span class="n">cpg_network</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">joints_angles</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legs</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">](</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">psi_base</span> <span class="o">=</span> <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">](</span><span class="n">psi_rest_phases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">adjusted_psi</span> <span class="o">=</span> <span class="n">psi_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">psi</span> <span class="o">-</span> <span class="n">psi_base</span><span class="p">)</span> <span class="o">*</span> <span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_magnitudes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dof</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">,</span> <span class="n">adjusted_psi</span><span class="p">):</span>
            <span class="n">joints_angles</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;joint_</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">dof</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="n">action</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;joints&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">joints_angles</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">fly</span><span class="o">.</span><span class="n">actuated_joints</span><span class="p">])}</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">cam</span><span class="o">.</span><span class="n">save_video</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;cpg_controller.mp4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [00:18&lt;00:00, 549.74it/s]
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/cpg_controller/cpg_controller.mp4" controls="controls" style="max-width: 400px;"></video></section>
<section id="leg-adhesion">
<h2>Leg adhesion<a class="headerlink" href="#leg-adhesion" title="Link to this heading">¶</a></h2>
<p>Insects, including flies, have evolved highly specialized adhesive
structures to facilitate locomotion over complex 3D terrain. Substantial
normal forces (10–100 times body weight) and frictional forces emerge
from interactions between the adhesive pads and underlying substrates.
These allow insects to navigate 3D terrain with ease. Because we cannot
fully represent the physics underlying real, biological adhesion, we
added a more abstract leg adhesion to our model by injecting an
additional normal force to the pretarsus of each leg when it is in
contact with a substrate. This adhesive force increases the normal force
toward the object and the frictional force.</p>
<p>Despite the huge forces generated by adhesive pads, insects can still
lift their legs, seemingly with out effort. The mechanisms for lifting
off are not well understood in <em>Drosophila</em>. Therefore, we abstracted
the mechanisms used by other insects for lifting by turning adhesion
forces on during stance and off during swing phases. In the
preprogrammed stepping data, we have also indicated the start (in
seconds) of the swing and stance periods:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">single_steps_data</span><span class="p">[</span><span class="s2">&quot;swing_stance_time&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;swing&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;RH&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;LF&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;LM&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;LH&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
 <span class="s1">&#39;stance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;RF&#39;</span><span class="p">:</span> <span class="mf">0.051000000000000004</span><span class="p">,</span>
  <span class="s1">&#39;RM&#39;</span><span class="p">:</span> <span class="mf">0.048</span><span class="p">,</span>
  <span class="s1">&#39;RH&#39;</span><span class="p">:</span> <span class="mf">0.042</span><span class="p">,</span>
  <span class="s1">&#39;LF&#39;</span><span class="p">:</span> <span class="mf">0.051000000000000004</span><span class="p">,</span>
  <span class="s1">&#39;LM&#39;</span><span class="p">:</span> <span class="mf">0.048</span><span class="p">,</span>
  <span class="s1">&#39;LH&#39;</span><span class="p">:</span> <span class="mf">0.042</span><span class="p">}}</span>
</pre></div>
</div>
<p>Let’s write a function that, given the phases of the legs, return a
boolean mask indicating whether adhesion should be on (during stance) or
off (during swing):</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_adhesion_onoff</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">~</span><span class="p">((</span><span class="n">theta</span> <span class="o">&gt;</span> <span class="n">swing_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;</span> <span class="n">swing_end</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
<p>To illustrate this binary signal (low = off, during swing; high = on,
during stance):</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onoff_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">phase_grid</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phase_grid</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">onoff_signal</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_adhesion_onoff</span><span class="p">(</span><span class="n">phase_grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phase_grid</span><span class="p">,</span> <span class="n">onoff_signal</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">legs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi/2$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;3$\pi$/2&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$2\pi$&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Adhesion on/off&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;adhesion_signal.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/adhesion_signal.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/cpg_controller/adhesion_signal.png?raw=true" />
<p>We can rerun the NeuroMechFly simulation with adhesion enabled. The
parts of the code that have been changed are indicated with comments.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">run_time</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
    <span class="n">init_pose</span><span class="o">=</span><span class="s2">&quot;stretch&quot;</span><span class="p">,</span>
    <span class="n">actuated_joints</span><span class="o">=</span><span class="n">all_leg_dofs</span><span class="p">,</span>
    <span class="n">control</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cam</span> <span class="o">=</span> <span class="n">ZStabilizedCamera</span><span class="p">(</span><span class="n">attachment_point</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
    <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_left&quot;</span><span class="p">,</span>
    <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">SingleFlySimulation</span><span class="p">(</span><span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span> <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">cpg_network</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="n">ang</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_time</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)):</span>
    <span class="n">cpg_network</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">joints_angles</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legs</span><span class="p">):</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">](</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">psi_base</span> <span class="o">=</span> <span class="n">psi_funcs</span><span class="p">[</span><span class="n">leg</span><span class="p">](</span><span class="n">psi_rest_phases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">adjusted_psi</span> <span class="o">=</span> <span class="n">psi_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">psi</span> <span class="o">-</span> <span class="n">psi_base</span><span class="p">)</span> <span class="o">*</span> <span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_magnitudes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dof</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">,</span> <span class="n">adjusted_psi</span><span class="p">):</span>
            <span class="n">joints_angles</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;joint_</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">dof</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="n">adhesion_onoff</span> <span class="o">=</span> <span class="n">get_adhesion_onoff</span><span class="p">(</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">)</span>
    <span class="n">ang</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">joints_angles</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">fly</span><span class="o">.</span><span class="n">actuated_joints</span><span class="p">])</span>
    <span class="n">action</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;joints&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">joints_angles</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="n">fly</span><span class="o">.</span><span class="n">actuated_joints</span><span class="p">]),</span>
        <span class="c1">##### THIS LINE IS NEW #####</span>
        <span class="s2">&quot;adhesion&quot;</span><span class="p">:</span> <span class="n">adhesion_onoff</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="c1">############################</span>
    <span class="p">}</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">cam</span><span class="o">.</span><span class="n">save_video</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;cpg_controller_with_adhesion.mp4&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [00:26&lt;00:00, 384.60it/s]
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/cpg_controller/cpg_controller_with_adhesion.mp4" controls="controls" style="max-width: 400px;"></video><p>In summary, in this tutorial we have (1) implemented a Python class for
CPG networks, (2) used it to modulate the stepping of legs using
experimentally recorded data, (3) plugged this controller into the
NeuroMechFly embodiment, and (4) added leg adhesion to the simulation.
Note that the controller we built here is feedforward — that is,
mechanosensory feedback is not used by the controller (except the
position feedback in the PD controller for individual joints). In the
next tutorial, we will build a rule-based controller where leg
coordination is accomplished using sensory feedback in a more
distributed manner.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="rule_based_controller.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Rule-based controller</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="gym_basics_and_kinematic_replay.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Interacting with NeuroMechFly</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Neuroengineering Laboratory, EPFL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NeLy-EPFL/flygym" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Controlling locomotion with CPGs</a><ul>
<li><a class="reference internal" href="#the-cpg-network">The CPG network</a></li>
<li><a class="reference internal" href="#controlling-leg-stepping-with-cpgs">Controlling leg stepping with CPGs</a></li>
<li><a class="reference internal" href="#plugging-the-controller-into-the-simulation">Plugging the controller into the simulation</a></li>
<li><a class="reference internal" href="#leg-adhesion">Leg adhesion</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>