<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF8S7T56G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DF8S7T56G7');
    </script>
    <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Vision basics" href="vision_basics.html" /><link rel="prev" title="Overcome complex terrain with a hybrid controller" href="hybrid_controller.html" />
        <link rel="prefetch" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" as="image" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Encapsulating custom code into Gym environments: A turning controller - NeuroMechFly documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NeuroMechFly documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">NeuroMechFly documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../neuromechfly.html">The NeuroMechFly Model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gallery/index.html">Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_3_forces.html">Estimating contact forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_4_climbing.html">Climbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_8_controller_comparison.html">Controller comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_9_visual_taxis.html">Visual taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_10_odour_taxis.html">Odour Taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_11_head_stabilization.html">Head stabilization on complex terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_12_multimodal_navigation.html">Multimodal navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_13_plume_navigation.html">Plume navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_14_fly_follow_fly.html">Fly chasing with a connectome constrained visual system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gym_basics_and_kinematic_replay.html">Interacting with NeuroMechFly</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpg_controller.html">Controlling locomotion with CPGs</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule_based_controller.html">Rule-based controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_controller.html">Overcome complex terrain with a hybrid controller</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Encapsulating custom code into Gym environments: A turning controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="vision_basics.html">Vision basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="olfaction_basics.html">Olfaction basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="path_integration.html">Path integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_stabilization.html">Head stabilization</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_vision.html">Connectome-constrained visual system model</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_olfaction.html">Advanced olfaction: Navigating a complex odor plume</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api_ref/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/mdp_specs.html">MDP Task Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/fly.html">Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/arena.html">Arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/state.html">State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/vision.html">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/olfaction.html">Olfaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/preprogrammed.html">Preprogrammed</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api_ref/examples/index.html">FlyGym Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of FlyGym Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/locomotion.html">Locomotion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/vision.html">Advanced Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/olfaction.html">Advanced Olfaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/path_integration.html">Path Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/head_stabilization.html">Head Stabilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/legacy.html">Legacy API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workshop.html">NeuroMechFly Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">NeuroMechFly Live and Outreach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/turning.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="encapsulating-custom-code-into-gym-environments-a-turning-controller">
<h1>Encapsulating custom code into Gym environments: A turning controller<a class="headerlink" href="#encapsulating-custom-code-into-gym-environments-a-turning-controller" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Authors:</strong> Victor Alfred Stimpfling, Sibo Wang-Chen</p>
<p>The code presented in this notebook has been simplified and
restructured for display in a notebook format. A more complete and
better structured implementation can be found in the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/flygym/examples/">examples folder of
the FlyGym repository on
GitHub</a>.</p>
<p>This tutorial is available in <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> format in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/notebooks">notebooks folder of the FlyGym repository</a>.</p>
</div>
<p><strong>Summary:</strong> In this tutorial, we will demonstrate how one can build
controllers at different levels of abstraction by implementing Gym
environments encoding variable amounts of preprogrammed computation. As
an example, we will refactor the code we wrote in the <a class="reference external" href="https://neuromechfly.org/tutorials/hybrid_controller.html#building-a-hybrid-controller">hybrid controller
tutorial</a>
and implement turning by asymmetrically modulating the amplitude and
frequency of CPGs.</p>
<section id="gym-environments-and-mdp">
<h2>Gym environments and MDP<a class="headerlink" href="#gym-environments-and-mdp" title="Link to this heading">¶</a></h2>
<p>So far, we have interacted with the <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> class which
implements the <a class="reference external" href="https://gymnasium.farama.org/">Gym interface</a>: it has
an action space (input given by the user), an observation space (output
returned to the user), a <code class="docutils literal notranslate"><span class="pre">.step(...)</span></code> method, a <code class="docutils literal notranslate"><span class="pre">.reset(...)</span></code>
method, and a <code class="docutils literal notranslate"><span class="pre">.render(...)</span></code> method. The action and observation spaces
of <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> are as follows:</p>
<ul class="simple">
<li><p>Action space:</p>
<ul>
<li><p>“joints”: 42-dimensional real vector ∈ [0, 2π] indicating joint
angles (in default position control mode)</p></li>
<li><p>“adhesion”: 6-dimensional integer vector ∈ {0, 1} indicating
whether adhesion is turned on for each leg</p></li>
</ul>
</li>
<li><p>Observation space:</p>
<ul>
<li><p>“joints”: shape (3, 42) real array indicating joint angles (0th
row), velocities (1st row), and torques (2nd row)</p></li>
<li><p>“fly”: shape (4, 3) real array indicating fly xyz positions (0th
row), xyz velocities (1st row), yaw-pitch-roll angles (2nd row),
and yaw-pitch-roll velocities (3rd row)</p></li>
<li><p>“contact_forces”: shape (N, 3) - contact forces, in xyz
directions, of the N segments defined in
<code class="docutils literal notranslate"><span class="pre">contact_sensor_placements</span></code></p></li>
<li><p>“end_effectors”: shape (6, 3) - xyz positions of the six legs in
the order of LF, LM LH, RF, RM, RH</p></li>
<li><p>“fly_orientation”: shape (3,) - unit vector indicating the fly’s
heading orientation</p></li>
</ul>
</li>
</ul>
<p>The FlyGym package is designed to be expandable: the user can implement
their own Gym environments with different action and observation spaces
and implement different logics (e.g. preprogrammed premotor computation
and sensory processing). This is illustrated in the figure below:</p>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/mdp.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/mdp.png?raw=true" />
<p>In the hybrid controller that <a class="reference external" href="https://neuromechfly.org/tutorials/hybrid_controller.html#building-a-hybrid-controller">we have
implemented</a>,
the underlying CPG network and the correction mechanisms can be
considered the user-defined premotor computation (purple). The whole
controller can be considered the box indicating the Markov Decision
Process (MDP). Here, we will add a 2D descending signal that encodes
turning. The action and observation spaces of our MDP “box” are as
follows:</p>
<ul class="simple">
<li><p>Action space: a 2-dimensional real vector describing the velocity on
each side of the body. Although in principle the range of the
amplitude is unrestricted, its absolute value shouldn’t go far beyond
1 because otherwise the steps become very unrealistic.</p></li>
<li><p>Observation space: same as above (no sensory processing logic
indicated in cyan)</p></li>
</ul>
</section>
<section id="approach-for-turning">
<h2>Approach for turning<a class="headerlink" href="#approach-for-turning" title="Link to this heading">¶</a></h2>
<p>We will use a 2-dimensional representation of descending signals
<span class="math notranslate nohighlight">\([\delta_L, \delta_R] \in \mathbb{R}^2\)</span> to modulate the amplitude
and direction of the leg CPGs on each side of the body. Specifically, we
will modulate the intrinsic amplitude <span class="math notranslate nohighlight">\(R'\)</span> and intrinsic frequency
<span class="math notranslate nohighlight">\(\nu'\)</span> on each side by:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[R'(\delta) = |\delta|\]</div>
</div>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\nu_i'(\delta) = \begin{cases}
\nu_i   &amp; \text{if } \delta&gt;0\\
-\nu_i  &amp; \text{otherwise}
\end{cases}\end{split}\]</div>
</div>
<p>In other words, the magnitude of the descending signal controls the
amplitude of stepping (as a gain applied to the originally recorded step
size); the sign of the descending signal controls the direction of
stepping. Of course, this is a very simplified model of turning. Perhaps
the most unrealistic aspect of it is that it assumes that the step size
spans linearly from 0 to 1x the recorded “real” step size. This is an
area for future improvement.</p>
</section>
<section id="implementing-the-hybridturningcontroller-class">
<h2>Implementing the <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> class<a class="headerlink" href="#implementing-the-hybridturningcontroller-class" title="Link to this heading">¶</a></h2>
<p>A key idea of the Gym interface is that it allows users to encapsulate
the control logic in a Gym environment (a MDP), and expose only the
input and output (action and observation) to the controller. This is
achieved using <a class="reference external" href="https://www.w3schools.com/python/python_inheritance.asp">class
inheritance</a>
in Python. Briefly, it allows a new class (subclass or child class) to
inherit attributes and methods from an existing class (base class or
parent class), enabling code reuse and the creation of hierarchical
relationships between classes. Refer to the tutorial linked above to
familiarize yourself with this concept.</p>
<p>All Gym environments inherit from the <code class="docutils literal notranslate"><span class="pre">gymnasium.Env</span></code> class. You can
refer to <a class="reference external" href="https://gymnasium.farama.org/api/env/#gymnasium-env">the API reference of this
class</a> for a
full specification, or <a class="reference external" href="https://gymnasium.farama.org/tutorials/gymnasium_basics/environment_creation/">this
page</a>
for a tutorial on how to make your own custom environment. The
<code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> class we have used so far inherits from it and
therefore complies with its specifications. Here, we will build a
<code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> class that inherits from <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> to
provide a simplified interface to control turning via a 2D input space,
which can be interpreted as a descending code.</p>
<p>First, let’s do the necessary imports and define the default parameter
as before:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="kn">import</span> <span class="n">spaces</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gymnasium.utils.env_checker</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_env</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flygym</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fly</span><span class="p">,</span> <span class="n">ZStabilizedCamera</span><span class="p">,</span> <span class="n">SingleFlySimulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.locomotion</span><span class="w"> </span><span class="kn">import</span> <span class="n">PreprogrammedSteps</span><span class="p">,</span> <span class="n">CPGNetwork</span>


<span class="n">_tripod_phase_biases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">_tripod_coupling_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">_tripod_phase_biases</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>

<span class="n">_default_correction_vectors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &quot;leg pos&quot;: (Coxa, Coxa_roll, Coxa_yaw, Femur, Femur_roll, Tibia, Tarsus1)</span>
    <span class="c1"># unit: radian</span>
    <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">]),</span>
    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.015</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span>
    <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">]),</span>
<span class="p">}</span>

<span class="n">_default_correction_rates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;retraction&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">700</span><span class="p">),</span> <span class="s2">&quot;stumbling&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2200</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)}</span>
</pre></div>
</div>
<p>Now, we will define the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of our <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code>
class. The <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/blob/main/flygym/examples/locomotion/turning_controller.py">complete, functional class
definition</a>
can be found on our GitHub repository. You can import it with
<code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">flygym.examples.locomotion</span> <span class="pre">import</span> <span class="pre">HybridTurningController</span></code>.</p>
<p>We start with initializing the parent class by calling
<code class="docutils literal notranslate"><span class="pre">super().__init__(...)</span></code>. This basically calls the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> logic
of the parent <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> class using the specified parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HybridTurningController</span><span class="p">(</span><span class="n">NeuroMechFly</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fly</span><span class="p">:</span> <span class="n">Fly</span><span class="p">,</span>
        <span class="n">preprogrammed_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">intrinsic_freqs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">intrinsic_amps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">phase_biases</span><span class="o">=</span><span class="n">_tripod_phase_biases</span><span class="p">,</span>
        <span class="n">coupling_weights</span><span class="o">=</span><span class="n">_tripod_coupling_weights</span><span class="p">,</span>
        <span class="n">convergence_coefs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">init_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">init_magnitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stumble_segments</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">),</span>
        <span class="n">stumbling_force_threshold</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">correction_vectors</span><span class="o">=</span><span class="n">_default_correction_vectors</span><span class="p">,</span>
        <span class="n">correction_rates</span><span class="o">=</span><span class="n">_default_correction_rates</span><span class="p">,</span>
        <span class="n">amplitude_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
        <span class="n">draw_corrections</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_increment</span><span class="o">=</span><span class="mi">80</span><span class="o">/</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">retraction_persistence_duration</span><span class="o">=</span><span class="mi">20</span><span class="o">/</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">retraction_persistence_initiation_threshold</span><span class="o">=</span><span class="mi">20</span><span class="o">/</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Initialize core NMF simulation</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="o">...</span>
</pre></div>
</div>
<p>We can save the arguments as class attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="k">if</span> <span class="n">preprogrammed_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">preprogrammed_steps</span> <span class="o">=</span> <span class="n">PreprogrammedSteps</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">preprogrammed_steps</span> <span class="o">=</span> <span class="n">preprogrammed_steps</span>
<span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_freqs</span> <span class="o">=</span> <span class="n">intrinsic_freqs</span>
<span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_amps</span> <span class="o">=</span> <span class="n">intrinsic_amps</span>
<span class="bp">self</span><span class="o">.</span><span class="n">phase_biases</span> <span class="o">=</span> <span class="n">phase_biases</span>
<span class="bp">self</span><span class="o">.</span><span class="n">coupling_weights</span> <span class="o">=</span> <span class="n">coupling_weights</span>
<span class="bp">self</span><span class="o">.</span><span class="n">convergence_coefs</span> <span class="o">=</span> <span class="n">convergence_coefs</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stumble_segments</span> <span class="o">=</span> <span class="n">stumble_segments</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stumbling_force_threshold</span> <span class="o">=</span> <span class="n">stumbling_force_threshold</span>
<span class="bp">self</span><span class="o">.</span><span class="n">correction_vectors</span> <span class="o">=</span> <span class="n">correction_vectors</span>
<span class="bp">self</span><span class="o">.</span><span class="n">correction_rates</span> <span class="o">=</span> <span class="n">correction_rates</span>
<span class="bp">self</span><span class="o">.</span><span class="n">amplitude_range</span> <span class="o">=</span> <span class="n">amplitude_range</span>
<span class="bp">self</span><span class="o">.</span><span class="n">draw_corrections</span> <span class="o">=</span> <span class="n">draw_corrections</span>
<span class="bp">self</span><span class="o">.</span><span class="n">max_increment</span> <span class="o">=</span> <span class="n">max_increment</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
<span class="bp">self</span><span class="o">.</span><span class="n">retraction_persistence_duration</span> <span class="o">=</span> <span class="n">retraction_persistence_duration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
<span class="bp">self</span><span class="o">.</span><span class="n">retraction_persistence_initiation_threshold</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">retraction_persistence_initiation_threshold</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
<span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">retraction_persistence_counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="c1"># Define the joints that need to be inverted to</span>
<span class="c1"># mirror actions from left to right</span>
<span class="bp">self</span><span class="o">.</span><span class="n">right_leg_inversion</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Next, we need to override the action space of <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code>. This is
done by defining a new Gym space object. Gym provides an <a class="reference external" href="https://gymnasium.farama.org/api/spaces/">interface for
various space types</a>. An
non-exhaustive list includes <code class="docutils literal notranslate"><span class="pre">Box</span></code> for a possibly-bounded box in
<span class="math notranslate nohighlight">\(\mathbb{R}^n\)</span>, <code class="docutils literal notranslate"><span class="pre">Discrete</span></code> for a finite set of options, <code class="docutils literal notranslate"><span class="pre">Text</span></code>
for text, and various <a class="reference external" href="https://gymnasium.farama.org/api/spaces/composite/">composite
spaces</a> such as
<code class="docutils literal notranslate"><span class="pre">Dict</span></code>, <code class="docutils literal notranslate"><span class="pre">Tuple</span></code>, <code class="docutils literal notranslate"><span class="pre">Sequence</span></code>, <code class="docutils literal notranslate"><span class="pre">Graph</span></code>. Here, we will define the
descending space as a <code class="docutils literal notranslate"><span class="pre">Box</span></code> space. We won’t change the observation
space definition since we will return <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code>’s observation
as is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Define action and observation spaces</span>
<span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="o">*</span><span class="n">amplitude_range</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Then, we will initialize the CPG network that we defined <a class="reference external" href="https://neuromechfly.org/tutorials/cpg_controller.html">in the CPG
tutorial</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Initialize CPG network</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span> <span class="o">=</span> <span class="n">CPGNetwork</span><span class="p">(</span>
    <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
    <span class="n">intrinsic_freqs</span><span class="o">=</span><span class="n">intrinsic_freqs</span><span class="p">,</span>
    <span class="n">intrinsic_amps</span><span class="o">=</span><span class="n">intrinsic_amps</span><span class="p">,</span>
    <span class="n">coupling_weights</span><span class="o">=</span><span class="n">coupling_weights</span><span class="p">,</span>
    <span class="n">phase_biases</span><span class="o">=</span><span class="n">phase_biases</span><span class="p">,</span>
    <span class="n">convergence_coefs</span><span class="o">=</span><span class="n">convergence_coefs</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
<span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">init_phases</span><span class="p">,</span> <span class="n">init_magnitudes</span><span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<p>We will then initialize variables tracking the amount of retraction and
stumbling correction as we did in the <a class="reference external" href="https://neuromechfly.org/tutorials/hybrid_controller.html">hybrid controller
tutorial</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Initialize variables tracking the correction amount</span>
<span class="bp">self</span><span class="o">.</span><span class="n">retraction_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stumbling_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Finally, we will find the contact sensors for stumbling detection as we
did before. This time, we define it as a method of our new class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_find_stumbling_sensor_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">     </span><span class="sd">&quot;&quot;&quot;Find the indices of the sensors that are used for stumbling detection.&quot;&quot;&quot;</span>
     <span class="n">stumbling_sensors</span> <span class="o">=</span> <span class="p">{</span><span class="n">leg</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprogrammed_steps</span><span class="o">.</span><span class="n">legs</span><span class="p">}</span>
     <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sensor_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">contact_sensor_placements</span><span class="p">):</span>
         <span class="n">leg</span> <span class="o">=</span> <span class="n">sensor_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># sensor_name: e.g. &quot;Animat/LFTarsus1&quot;</span>
         <span class="n">segment</span> <span class="o">=</span> <span class="n">sensor_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>
         <span class="k">if</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stumble_segments</span><span class="p">:</span>
             <span class="n">stumbling_sensors</span><span class="p">[</span><span class="n">leg</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
     <span class="n">stumbling_sensors</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stumbling_sensors</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
     <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
         <span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stumble_segments</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stumbling_sensors</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
     <span class="p">):</span>
         <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
             <span class="s2">&quot;Contact detection must be enabled for all tibia, tarsus1, and tarsus2 &quot;</span>
             <span class="s2">&quot;segments for stumbling detection.&quot;</span>
         <span class="p">)</span>
     <span class="k">return</span> <span class="n">stumbling_sensors</span>
</pre></div>
</div>
<p>… and we can all it in <code class="docutils literal notranslate"><span class="pre">__init__</span></code>. This concludes the definition of
our <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Find stumbling sensors</span>
<span class="bp">self</span><span class="o">.</span><span class="n">stumbling_sensors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_stumbling_sensor_indices</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, we shall define the <code class="docutils literal notranslate"><span class="pre">reset</span></code> method of our
<code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> class. This involves resetting the
underlying <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> simulation — as before, we will call
<code class="docutils literal notranslate"><span class="pre">super().reset(...)</span></code> to drop in the reset method of the parent class.
Then, we will reset the CPG network and the stumbling amounts. Note that
the <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> argument is required to fully comply with the Gym API.
In general, this gives the user more flexibility to pass additional
arguments when initializing the Gym environment.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init_magnitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">init_phases</span><span class="p">,</span> <span class="n">init_magnitudes</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">retraction_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stumbling_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">info</span>
</pre></div>
</div>
<p>Now, we are ready to implement the most important <code class="docutils literal notranslate"><span class="pre">step</span></code> method. We
start by updating the intrinsic amplitudes and frequencies of the CPGs
as formulated above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Step the simulation forward one timestep.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    action : np.ndarray</span>
<span class="sd">        Array of shape (2,) containing descending signal encoding</span>
<span class="sd">        turning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># update CPG parameters</span>
    <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">action</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intrinsic_freqs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">freqs</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">freqs</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">intrinsic_amps</span> <span class="o">=</span> <span class="n">amps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">intrinsic_freqs</span> <span class="o">=</span> <span class="n">freqs</span>
</pre></div>
</div>
<p>We will once again use <code class="docutils literal notranslate"><span class="pre">super()</span></code> to call the <code class="docutils literal notranslate"><span class="pre">get_observation</span></code>
method of the parent <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># get current observation</span>
<span class="n">obs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_observation</span><span class="p">()</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Next, we check whether the condition is met for the retraction of any
leg. To do this, we define a helper method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_retraction_rule_find_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the index of the leg that needs to be retracted, or None</span>
<span class="sd">    if none applies.</span>
<span class="sd">    Retraction can be due to the activation of a rule or persistence.</span>
<span class="sd">    Every time the rule is active the persistence counter is set to 1. At every step the persistence</span>
<span class="sd">    counter is incremented. If the rule is still active it is again reset to 1 otherwise, it will</span>
<span class="sd">    be incremented until it reaches the persistence duration. At this point the persistence counter</span>
<span class="sd">    is reset to 0.&quot;&quot;&quot;</span>
    <span class="n">end_effector_z_pos</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;end_effectors&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">end_effector_z_pos_sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">end_effector_z_pos</span><span class="p">)</span>
    <span class="n">end_effector_z_pos_sorted</span> <span class="o">=</span> <span class="n">end_effector_z_pos</span><span class="p">[</span><span class="n">end_effector_z_pos_sorted_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">end_effector_z_pos_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end_effector_z_pos_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">leg_to_correct_retraction</span> <span class="o">=</span> <span class="n">end_effector_z_pos_sorted_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retraction_correction</span><span class="p">[</span><span class="n">leg_to_correct_retraction</span><span class="p">]</span>
            <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">retraction_persistence_initiation_threshold</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retraction_persistence_counter</span><span class="p">[</span><span class="n">leg_to_correct_retraction</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leg_to_correct_retraction</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">leg_to_correct_retraction</span>
</pre></div>
</div>
<p>… and call it in the <code class="docutils literal notranslate"><span class="pre">step</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Retraction rule: is any leg stuck in a gap and needing to be retracted?</span>
<span class="n">leg_to_correct_retraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retraction_rule_find_leg</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Next, we can step the CPG:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="bp">self</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Then, we write a loop to go through each of the legs. In this loop, we
update the correction amount for both the retraction rule and the
stumbling rule. As before, we assign the retraction rule priority. We
then calculate the target joint angles using the preprogrammed step
class and decide whether adhesion should be turned off for swinging:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="o">...</span>
<span class="n">joints_angles</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">adhesion_onoff</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preprogrammed_steps</span><span class="o">.</span><span class="n">legs</span><span class="p">):</span>
    <span class="c1"># update amount of retraction correction</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">i</span> <span class="o">==</span> <span class="n">leg_to_correct_retraction</span> <span class="ow">or</span> <span class="n">retraction_persistence_counter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="p">):</span>  <span class="c1"># lift leg</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">correction_rates</span><span class="p">[</span><span class="s2">&quot;retraction&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span>
        <span class="n">retraction_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">change_segment_color</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2">Tibia&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># condition no longer met, lower leg</span>
        <span class="n">decrement</span> <span class="o">=</span> <span class="n">correction_rates</span><span class="p">[</span><span class="s2">&quot;retraction&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span>
        <span class="n">retraction_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retraction_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">decrement</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">change_segment_color</span><span class="p">(</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2">Tibia&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># update amount of stumbling correction</span>
    <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;contact_forces&quot;</span><span class="p">][</span><span class="n">stumbling_sensors</span><span class="p">[</span><span class="n">leg</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">fly_orientation</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly_orientation&quot;</span><span class="p">]</span>
    <span class="c1"># force projection should be negative if against fly orientation</span>
    <span class="n">force_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">contact_forces</span><span class="p">,</span> <span class="n">fly_orientation</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">force_proj</span> <span class="o">&lt;</span> <span class="n">stumbling_force_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">correction_rates</span><span class="p">[</span><span class="s2">&quot;stumbling&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span>
        <span class="n">stumbling_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">change_segment_color</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2">Femur&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">decrement</span> <span class="o">=</span> <span class="n">correction_rates</span><span class="p">[</span><span class="s2">&quot;stumbling&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span>
        <span class="n">stumbling_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stumbling_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">decrement</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retraction_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">change_segment_color</span><span class="p">(</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}</span><span class="s2">Femur&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># retraction correction is prioritized</span>
    <span class="k">if</span> <span class="n">retraction_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">net_correction</span> <span class="o">=</span> <span class="n">retraction_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stumbling_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">net_correction</span> <span class="o">=</span> <span class="n">stumbling_correction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># get target angles from CPGs and apply correction</span>
    <span class="n">my_joints_angles</span> <span class="o">=</span> <span class="n">preprogrammed_steps</span><span class="o">.</span><span class="n">get_joint_angles</span><span class="p">(</span>
        <span class="n">leg</span><span class="p">,</span> <span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_magnitudes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">net_correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">net_correction</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_increment</span><span class="o">*</span><span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
        <span class="n">net_correction</span> <span class="o">*=</span> <span class="n">right_leg_inversion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">net_correction</span> <span class="o">*=</span> <span class="n">step_phase_multiplier</span><span class="p">[</span><span class="n">leg</span><span class="p">](</span>
        <span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">my_joints_angles</span> <span class="o">+=</span> <span class="n">net_correction</span> <span class="o">*</span> <span class="n">correction_vectors</span><span class="p">[</span><span class="n">leg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">joints_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_joints_angles</span><span class="p">)</span>

    <span class="c1"># get adhesion on/off signal</span>
    <span class="n">my_adhesion_onoff</span> <span class="o">=</span> <span class="n">preprogrammed_steps</span><span class="o">.</span><span class="n">get_adhesion_onoff</span><span class="p">(</span>
        <span class="n">leg</span><span class="p">,</span> <span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_phases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">all_net_corrections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_correction</span>

    <span class="n">adhesion_onoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_adhesion_onoff</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>This requires three helper methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_stumbling_rule_check_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">leg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the leg is stumbling, False otherwise.&quot;&quot;&quot;</span>
    <span class="c1"># update stumbling correction amounts</span>
    <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;contact_forces&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">stumbling_sensors</span><span class="p">[</span><span class="n">leg</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">fly_orientation</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly_orientation&quot;</span><span class="p">]</span>
    <span class="c1"># force projection should be negative if against fly orientation</span>
    <span class="n">force_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">contact_forces</span><span class="p">,</span> <span class="n">fly_orientation</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">force_proj</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stumbling_force_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_net_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retraction_correction</span><span class="p">,</span> <span class="n">stumbling_correction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retraction correction has priority.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">retraction_correction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">retraction_correction</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">stumbling_correction</span><span class="p">,</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_update_correction_amount</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">curr_amount</span><span class="p">,</span> <span class="n">correction_rates</span><span class="p">,</span> <span class="n">viz_segment</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update correction amount and color code leg segment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    condition : bool</span>
<span class="sd">        Whether the correction condition is met.</span>
<span class="sd">    curr_amount : float</span>
<span class="sd">        Current correction amount.</span>
<span class="sd">    correction_rates : tuple[float, float]</span>
<span class="sd">        Correction rates for increment and decrement.</span>
<span class="sd">    viz_segment : str</span>
<span class="sd">        Name of the segment to color code. If None, no color coding is</span>
<span class="sd">        done.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Updated correction amount.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>  <span class="c1"># lift leg</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">correction_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="n">new_amount</span> <span class="o">=</span> <span class="n">curr_amount</span> <span class="o">+</span> <span class="n">increment</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># condition no longer met, lower leg</span>
        <span class="n">decrement</span> <span class="o">=</span> <span class="n">correction_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
        <span class="n">new_amount</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">curr_amount</span> <span class="o">-</span> <span class="n">decrement</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">viz_segment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">change_segment_color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physics</span><span class="p">,</span> <span class="n">viz_segment</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_amount</span><span class="p">,</span> <span class="n">condition</span>
</pre></div>
</div>
<p>Finally, we build the action dictionary (recall from our discussion on
Gym spaces above — this is a composite <code class="docutils literal notranslate"><span class="pre">Dict</span></code> space) and call the
<code class="docutils literal notranslate"><span class="pre">step</span></code> method of the parent <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> class using it. This
concludes the definition of our <code class="docutils literal notranslate"><span class="pre">step</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">action</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;joints&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">joints_angles</span><span class="p">)),</span>
    <span class="s2">&quot;adhesion&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">adhesion_onoff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s import this class and instantiate it:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.locomotion</span><span class="w"> </span><span class="kn">import</span> <span class="n">HybridTurningController</span>

<span class="n">run_time</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">timestep</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
    <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">cam</span> <span class="o">=</span> <span class="n">ZStabilizedCamera</span><span class="p">(</span>
    <span class="n">attachment_point</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
    <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_top&quot;</span><span class="p">,</span>
    <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span>

<span class="n">nmf</span> <span class="o">=</span> <span class="n">HybridTurningController</span><span class="p">(</span>
    <span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span>
    <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span>
    <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In fact, we can use Gymnasium’s <code class="docutils literal notranslate"><span class="pre">env_checker</span></code> utility to check if our
<code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> class fully complies with the Gym API. To do this,
<code class="docutils literal notranslate"><span class="pre">env_checker</span></code> will reset our environment a few times with random
parameters and step it with random actions. It will then check if the
observations are as specified in the observation space definition. If no
exception is raised, we are in good shape.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_env</span><span class="p">(</span><span class="n">nmf</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.../gymnasium/utils/env_checker.py:247: UserWarning: [33mWARN: For Box action spaces, we recommend using a symmetric and normalized space (range=[-1, 1] or [0, 1]). See https://stable-baselines3.readthedocs.io/en/master/guide/rl_tips.html for more information.[0m
  logger.warn(
.../gymnasium/utils/env_checker.py:225: UserWarning: [33mWARN: A Box observation space minimum value is -infinity. This is probably too low.[0m
  logger.warn(
.../gymnasium/utils/env_checker.py:229: UserWarning: [33mWARN: A Box observation space maximum value is -infinity. This is probably too high.[0m
  logger.warn(
000/gymnasium/utils/env_checker.py:321: UserWarning: [33mWARN: Not able to test alternative render modes due to the environment not having a spec. Try instantialising the environment through gymnasium.make[0m
  logger.warn(
</pre></div>
</div>
<p>Let’s run the simulation, applying a steady [1.2, 0.2] turn throughout.
We will also record the magnitude of the CPGs over time.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">magnitude_hist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">nmf</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_time</span> <span class="o">/</span> <span class="n">nmf</span><span class="o">.</span><span class="n">timestep</span><span class="p">)):</span>
    <span class="n">curr_time</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">nmf</span><span class="o">.</span><span class="n">timestep</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">nmf</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">nmf</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">magnitude_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nmf</span><span class="o">.</span><span class="n">cpg_network</span><span class="o">.</span><span class="n">curr_magnitudes</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [00:28&lt;00:00, 356.59it/s]
</pre></div>
</div>
<p>Let’s visualize the time series of the CPG magnitudes. As expected,
three CPGs converge to a faster step while the others converge to a
smaller one.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./outputs/turning_controller&quot;</span><span class="p">)</span>
<span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">run_time</span><span class="p">,</span> <span class="n">nmf</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnitude_hist</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;CPG magnitude&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;turning_cpg_magnitude.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/turning_controller/turning_cpg_magnitude.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/turning_controller/turning_cpg_magnitude.png?raw=true" />
<p>Finally, let’s take a look at the video:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cam</span><span class="o">.</span><span class="n">save_video</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;hybrid_turning.mp4&quot;</span><span class="p">)</span>
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/turning_controller/hybrid_turning.mp4" controls="controls" style="max-width: 400px;"></video></section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="vision_basics.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Vision basics</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="hybrid_controller.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Overcome complex terrain with a hybrid controller</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Neuroengineering Laboratory, EPFL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NeLy-EPFL/flygym" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Encapsulating custom code into Gym environments: A turning controller</a><ul>
<li><a class="reference internal" href="#gym-environments-and-mdp">Gym environments and MDP</a></li>
<li><a class="reference internal" href="#approach-for-turning">Approach for turning</a></li>
<li><a class="reference internal" href="#implementing-the-hybridturningcontroller-class">Implementing the <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> class</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>