<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF8S7T56G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DF8S7T56G7');
    </script>
    <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Head stabilization" href="head_stabilization.html" /><link rel="prev" title="Olfaction basics" href="olfaction_basics.html" />
        <link rel="prefetch" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" as="image" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Path integration - NeuroMechFly documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NeuroMechFly documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">NeuroMechFly documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../neuromechfly.html">The NeuroMechFly Model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gallery/index.html">Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_3_forces.html">Estimating contact forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_4_climbing.html">Climbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_8_controller_comparison.html">Controller comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_9_visual_taxis.html">Visual taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_10_odour_taxis.html">Odour Taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_11_head_stabilization.html">Head stabilization on complex terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_12_multimodal_navigation.html">Multimodal navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_13_plume_navigation.html">Plume navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_14_fly_follow_fly.html">Fly chasing with a connectome constrained visual system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gym_basics_and_kinematic_replay.html">Interacting with NeuroMechFly</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpg_controller.html">Controlling locomotion with CPGs</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule_based_controller.html">Rule-based controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_controller.html">Overcome complex terrain with a hybrid controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="turning.html">Encapsulating custom code into Gym environments: A turning controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="vision_basics.html">Vision basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="olfaction_basics.html">Olfaction basics</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Path integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_stabilization.html">Head stabilization</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_vision.html">Connectome-constrained visual system model</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_olfaction.html">Advanced olfaction: Navigating a complex odor plume</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api_ref/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/mdp_specs.html">MDP Task Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/fly.html">Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/arena.html">Arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/state.html">State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/vision.html">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/olfaction.html">Olfaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/preprogrammed.html">Preprogrammed</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api_ref/examples/index.html">FlyGym Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of FlyGym Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/locomotion.html">Locomotion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/vision.html">Advanced Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/olfaction.html">Advanced Olfaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/path_integration.html">Path Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/head_stabilization.html">Head Stabilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/legacy.html">Legacy API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workshop.html">NeuroMechFly Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">NeuroMechFly Live and Outreach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/path_integration.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="path-integration">
<h1>Path integration<a class="headerlink" href="#path-integration" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Author:</strong> Sibo Wang-Chen</p>
<p>The code presented in this notebook has been simplified and
restructured for display in a notebook format. A more complete and better
structured implementation can be found in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/flygym/examples/">examples folder of the FlyGym repository on
GitHub</a>.</p>
<p>This tutorial is available in <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> format in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/notebooks">notebooks folder of the FlyGym repository</a>.</p>
</div>
<p><strong>Summary:</strong> In this tutorial, we will show how the position and heading
of the animal can be estimated by integrating mechanosensory signals, a
process known as path integration.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>In the previous tutorials, we have demonstrated how brain-level
processes can drive the motor system via <em>descending control</em>.
<em>Ascending</em> motor signals are a complement to descending information as
they convey information, often mechanosensory in nature, back to the
brain. Ascending signals are predicted to inform brain-level
action selection, motor planning, and sensory contextualization (see
<a class="reference external" href="https://doi.org/10.1038/s41593-023-01281-z">Chen et al., 2023</a>). In
this tutorial and the next, we will demonstrate how incorporating
ascending motor feedback signals allows us to model behaviors that are
critical to the animal’s survival and functioning.</p>
<p>Animals, including flies, estimate their own orientation and distance
traveled (“odometry”) to perform path integration when navigating the
world. A superb example of path integration was demonstrated in the desert
ant <em>Cataglyphis fortis</em> (see <a class="reference external" href="https://doi.org/10.1242/jeb.038570">review by Wolf,
2011</a>). While the ant takes an
exploratory outbound path in search of a food source, it can return to
the nest in a straight line. Furthermore, if the experimenter moves the
ant to a different location upon finding the food, the ant still takes
the “correct” path back to the nest, but starting from the location
where it has been “air dropped” (as shown below). These results show
that the ant must be using idiothetic cues, rather than sensory input,
to navigate — similar to how sailors used to navigate featureless oceans
by “dead reckoning.”</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_schematic.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_schematic.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_schematic.png?raw=true" style="width: 300px;" />
</a>
</figure>
<p>The fly <em>Drosophila melanogaster</em> also performs path integration,
especially when navigating to find food sources (see <a class="reference external" href="https://doi.org/10.1016/j.cub.2017.06.026">Kim &amp; Dickinson,
2017</a>, <a class="reference external" href="https://doi.org/10.1016/j.cub.2021.08.006">Behbahani et al.,
2021</a>). While the source
of the idiothetic cues are unknown, they may, in principle, be derived
using ascending proprioceptive and tactile signals from the legs and
motor system. As a demonstration, we will attempt to estimate the
changes in the fly’s orientation (shown below in green) and displacement
(shown below in purple) based on proprioceptive and tactile information.
By integrating these changes over time, we aim to reconstruct the path
of the fly in space (right).</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_integration.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_integration.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_integration.png?raw=true" style="width: 600px;" />
</a>
</figure>
</section>
<section id="the-algorithm">
<h2>The algorithm<a class="headerlink" href="#the-algorithm" title="Link to this heading">¶</a></h2>
<p>Having hand-waved at how we aim to accomplish path integration, we will
try to make our proposed algorithm more precise. We can partition our
task into two sub-problems:</p>
<ol class="arabic simple">
<li><p>How do we predict the changes in heading and forward displacement
from proprioception and tactile information?</p></li>
<li><p>With these estimated “deltas” in heading and forward displacement,
how do we integrate them to find the position?</p></li>
</ol>
<p>The first question can be tackled in the following way: for each leg, we
accumulate stride lengths by computing the forward translation of the
leg tip relative to the thorax when the leg is pushing. Proprioception
gives us the positions of the leg tips; tactile sensing tells us whether
the leg was in contact with the ground, which we use as a proxy to
detect leg pushing. Together, proprioception and tactile sensing allow
us to calculate the stride lengths. Then, we compute the differences and
sums of the left and right total stride lengths for each pair of legs
over a small time window. These left-right differences and their sums
are then used to predict the change in heading and forward displacement
respectively. We will use a simple linear regression model for this
purpose.</p>
<p>However, we have glossed over one important detail: to predict the
change in heading and forward displacement, we need the <em>changes</em> in the
cumulated left-right differences and sums. But to calculate these
changes, we must first define a <em>time scale</em>. This underlies our
solution to the second part of the problem. We record the cumulated
left-right differences and sums at every point in time during the
walking simulation. Then, for every time <span class="math notranslate nohighlight">\(t\)</span>, can compute the
changes in the left-right differences and sums from time <span class="math notranslate nohighlight">\(t-\tau\)</span>
(<span class="math notranslate nohighlight">\(\tau\)</span> being the time scale) to time <span class="math notranslate nohighlight">\(t\)</span>. If we use these
“delta differences” and “delta sums” to predict “delta heading” and
“delta forward displacement,” we can get the changes in heading and
forward displacement in the same time scale. Therefore, we can simply
re-normalize the predicted values by the time scale, and integrate the
position in 2D. This process can be shown in the following schematic:</p>
<figure class="align-default">
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_prediction.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_prediction.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_prediction.png?raw=true" style="width: 400px;" />
</a>
</figure>
<p>In the next sections, we will test this algorithm.</p>
</section>
<section id="collecting-walking-data">
<h2>Collecting walking data<a class="headerlink" href="#collecting-walking-data" title="Link to this heading">¶</a></h2>
<p>To train the models, we first need to collect data where the fly walks
in a trajectory similar to foraging desert ants. To this end, we will
construct a scenario in which the fly model performs random exploration
of a featureless environment. Here, the fly alternates between forward
walking and in-place turning. We will control turning in a Poisson
process with a rate <span class="math notranslate nohighlight">\(\lambda_\text{turn}=2\text{ s}^{-1}\)</span>. This
turning rate is quite high compared to the range of typical fly
behavior. This is to deliberately make path integration more difficult.
When the fly executes a turn, we will apply a fixed asymmetrical
descending drive of
<span class="math notranslate nohighlight">\([{\rm DN}_\text{inner}, {\rm DN}_\text{outer}]\)</span> which has the
following values:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\([{\rm DN}_\text{inner}, {\rm DN}_\text{outer}] = [-0.2, 1.0]\)</span>
for the tripod and tetrapod gaits</p></li>
<li><p><span class="math notranslate nohighlight">\([{\rm DN}_\text{inner}, {\rm DN}_\text{outer}] = [0.4, 1.0]\)</span>
for the wave gait</p></li>
</ul>
<p>These choices lead to qualitatively similar turning across gait types.
The direction of the turn is chosen at random. We will sample the
duration of the turn (and therefore the angle turned) from a normal
distribution <span class="math notranslate nohighlight">\(\mathcal{N}(0.4\text{ s}, 0.1\text{ s})\)</span>. The fly
receives no visual information — akin to navigating in the dark. We will
use the <a class="reference external" href="https://neuromechfly.org/tutorials/turning.html#implementing-the-hybridturningcontroller-class">hybrid turning
controller</a>,
but with the correction amounts set to 0 for simplicity.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flygym</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fly</span><span class="p">,</span> <span class="n">Camera</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.preprogrammed</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_cpg_biases</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.path_integration</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathIntegrationArenaFlat</span>
</pre></div>
</div>
<p>Let’s define the discrete walking states as an <code class="docutils literal notranslate"><span class="pre">Enum</span></code> class (see
<a class="reference external" href="https://docs.python.org/3/howto/enum.html">this tutorial</a> for more
information on Enum if you are not familiar with it, but this is not
required).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WalkingState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">FORWARD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">TURN_LEFT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">TURN_RIGHT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">STOP</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Next, we will define a random exploration controller that controls the
switch between straight walking and turning in a Poisson process, as
discussed above. We will implement this controller as a class with a
<code class="docutils literal notranslate"><span class="pre">.step</span></code> method, which returns the next state and the corresponding
descending drives. Note that this controller is detached from the
physics simulation — it only tells us which walking state the simulated
fly <em>should</em> be in in the next step.</p>
<p>In a Poisson process, the cumulative distribution function of the
exponential distribution is</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[F(x) = 1 - e^{-\lambda x}\]</div>
</div>
<p>Therefore, the probability that the transition will happen within the
next <span class="math notranslate nohighlight">\(\Delta t\)</span> seconds is</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[P(T_{\rm turn} \leq {\rm d} t) = 1 - e^{-\lambda \Delta t}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\Delta t\)</span> is the simulation time step and
<span class="math notranslate nohighlight">\(T_{\rm turn}\)</span> is the time until the next transition to turning.
As a result, we will change the state to turning if and only if a scalar
uniformly randomly sampled from 0 to 1 is greater than
<span class="math notranslate nohighlight">\(e^{-\lambda \Delta t}\)</span>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RandomExplorationController</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This controller drives a random exploration: the fly transitions</span>
<span class="sd">    between forward walking and turning in a Poisson process. When the fly</span>
<span class="sd">    turns, the turn direction is chosen randomly and the turn duration is</span>
<span class="sd">    drawn from a normal distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">forward_dn_drive</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">left_turn_dn_drive</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span>
        <span class="n">right_turn_dn_drive</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4</span><span class="p">),</span>
        <span class="n">turn_duration_mean</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
        <span class="n">turn_duration_std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">lambda_turn</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">init_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dt : float</span>
<span class="sd">            Time step of the simulation.</span>
<span class="sd">        forward_dn_drive : tuple[float, float], optional</span>
<span class="sd">            DN drives for forward walking, by default (1.0, 1.0).</span>
<span class="sd">        left_turn_dn_drive : tuple[float, float], optional</span>
<span class="sd">            DN drives for turning left, by default (-0.4, 1.2).</span>
<span class="sd">        right_turn_dn_drive : tuple[float, float], optional</span>
<span class="sd">            DN drives for turning right, by default (1.2, -0.4).</span>
<span class="sd">        turn_duration_mean : float, optional</span>
<span class="sd">            Mean of the turn duration distribution in seconds, by default</span>
<span class="sd">            0.4.</span>
<span class="sd">        turn_duration_std : float, optional</span>
<span class="sd">            Standard deviation of the turn duration distribution in</span>
<span class="sd">            seconds, by default 0.1.</span>
<span class="sd">        lambda_turn : float, optional</span>
<span class="sd">            Rate of the Poisson process for turning, by default 1.0.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Random seed, by default 0.</span>
<span class="sd">        init_time : float, optional</span>
<span class="sd">            Initial time, in seconds, during which the fly walks straight,</span>
<span class="sd">            by default 0.1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_time</span> <span class="o">=</span> <span class="n">init_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span><span class="p">:</span> <span class="n">WalkingState</span> <span class="o">=</span> <span class="n">WalkingState</span><span class="o">.</span><span class="n">FORWARD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curr_turn_duration</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># DN drives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn_drives</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">WalkingState</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">forward_dn_drive</span><span class="p">),</span>
            <span class="n">WalkingState</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">left_turn_dn_drive</span><span class="p">),</span>
            <span class="n">WalkingState</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">right_turn_dn_drive</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Turning related parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_duration_mean</span> <span class="o">=</span> <span class="n">turn_duration_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn_duration_std</span> <span class="o">=</span> <span class="n">turn_duration_std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_turn</span> <span class="o">=</span> <span class="n">lambda_turn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the fly&#39;s walking state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WalkingState</span>
<span class="sd">            The next state of the fly.</span>
<span class="sd">        tuple[float, float]</span>
<span class="sd">            The next DN drives.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Upon spawning, just walk straight for a bit (init_time) for things to settle</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="k">return</span> <span class="n">WalkingState</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dn_drives</span><span class="p">[</span><span class="n">WalkingState</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">]</span>

        <span class="c1"># Forward -&gt; turn transition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span> <span class="o">==</span> <span class="n">WalkingState</span><span class="o">.</span><span class="n">FORWARD</span><span class="p">:</span>
            <span class="c1"># exponential function defining how likely it is that transition will NOT</span>
            <span class="c1"># happen in the next time step</span>
            <span class="n">p_nochange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_turn</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">p_nochange</span><span class="p">:</span>
                <span class="c1"># decide turn duration and direction</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curr_turn_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">turn_duration_mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">turn_duration_std</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">WalkingState</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">,</span> <span class="n">WalkingState</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curr_state_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span>

        <span class="c1"># Turn -&gt; forward transition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span> <span class="ow">in</span> <span class="p">(</span><span class="n">WalkingState</span><span class="o">.</span><span class="n">TURN_LEFT</span><span class="p">,</span> <span class="n">WalkingState</span><span class="o">.</span><span class="n">TURN_RIGHT</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_state_start_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curr_turn_duration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span> <span class="o">=</span> <span class="n">WalkingState</span><span class="o">.</span><span class="n">FORWARD</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curr_state_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dn_drives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span><span class="p">]</span>
</pre></div>
</div>
<p>As discussed, we will use the hybrid turning controller that we have
implemented previously. However, still missing from the
<code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> class is the ability to find the coordinates
of the leg tips (or any point at all) in the reference frame of the fly.
We will now extend <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code> to a new
<code class="docutils literal notranslate"><span class="pre">PathIntegrationController</span></code> class that has a
<code class="docutils literal notranslate"><span class="pre">.absolute_to_relative_pos</span></code> method that does exactly this. We will add
a <code class="docutils literal notranslate"><span class="pre">&quot;stride_diff_unmasked&quot;</span></code> key to the observation that records how
much the leg tips have shifted from the previous simulation time step.
More precisely, for each leg,</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{stride_diff_unmasked}[i] =
    \text{rel_leg_tip_pos}[i] - \text{rel_leg_tip_pos}[i - 1]\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\text{rel_leg_tip_pos}[i]\)</span> is the position of the tip of
this leg at the <span class="math notranslate nohighlight">\(i\)</span>-th step.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.locomotion</span><span class="w"> </span><span class="kn">import</span> <span class="n">HybridTurningController</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PathIntegrationController</span><span class="p">(</span><span class="n">HybridTurningController</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper of ``HybridTurningController`` that records variables that</span>
<span class="sd">    are used to perform path integration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_end_effector_pos</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_stride_lengths_hist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heading_estimate_hist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_estimate_hist</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as ``HybridTurningController.step``, but also records the</span>
<span class="sd">        stride for each leg (i.e., how much the leg tip has moved in the</span>
<span class="sd">        fly&#39;s egocentric frame since the last step) in the observation</span>
<span class="sd">        space under the key &quot;stride_diff_unmasked&quot;. Note that this</span>
<span class="sd">        calculation does not take into account whether the &quot;stride&quot; is</span>
<span class="sd">        actually made during a power stroke (i.e., stance phase); it only</span>
<span class="sd">        reports the change in end effector positions in an &quot;unmasked&quot;</span>
<span class="sd">        manner. The user should post-process it using the contact mask as a</span>
<span class="sd">        part of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

        <span class="c1"># Calculate stride since last step for each leg</span>
        <span class="n">ee_pos_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">absolute_to_relative_pos</span><span class="p">(</span>
            <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;end_effectors&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly_orientation&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_end_effector_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ee_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ee_pos_rel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ee_diff</span> <span class="o">=</span> <span class="n">ee_pos_rel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_end_effector_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_end_effector_pos</span> <span class="o">=</span> <span class="n">ee_pos_rel</span>
        <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;stride_diff_unmasked&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ee_diff</span>

        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">absolute_to_relative_pos</span><span class="p">(</span>
        <span class="n">pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">base_pos</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">heading</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">base_pos</span>
        <span class="n">heading</span> <span class="o">=</span> <span class="n">heading</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">heading</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">heading</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rot_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">angle</span><span class="p">)]]</span>
        <span class="p">)</span>
        <span class="n">pos_rotated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">,</span> <span class="n">rot_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos_rotated</span>
</pre></div>
</div>
<p>Now, we are ready to write a <code class="docutils literal notranslate"><span class="pre">run_simulation</span></code> function that interfaces
the state switching controller with the physics-embedded NeuroMechFly
simulation:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">running_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="n">gait</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tripod&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
        <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
        <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">arena</span> <span class="o">=</span> <span class="n">PathIntegrationArenaFlat</span><span class="p">()</span>

    <span class="n">cam_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mode&quot;</span><span class="p">:</span><span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
        <span class="s2">&quot;euler&quot;</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s2">&quot;fovy&quot;</span><span class="p">:</span><span class="mi">60</span>
        <span class="p">}</span>

    <span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span>
        <span class="n">attachment_point</span><span class="o">=</span><span class="n">arena</span><span class="o">.</span><span class="n">root_element</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
        <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;birdeye_cam&quot;</span><span class="p">,</span>
        <span class="n">timestamp_text</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">camera_parameters</span><span class="o">=</span><span class="n">cam_params</span>
    <span class="p">)</span>

    <span class="n">sim</span> <span class="o">=</span> <span class="n">PathIntegrationController</span><span class="p">(</span>
        <span class="n">phase_biases</span><span class="o">=</span><span class="n">get_cpg_biases</span><span class="p">(</span><span class="n">gait</span><span class="p">),</span>
        <span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span>
        <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">,</span>
        <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span>
        <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">correction_rates</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;retraction&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;stumbling&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)},</span>
    <span class="p">)</span>

    <span class="n">random_exploration_controller</span> <span class="o">=</span> <span class="n">RandomExplorationController</span><span class="p">(</span>
        <span class="n">dt</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
        <span class="n">lambda_turn</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
        <span class="n">forward_dn_drive</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">left_turn_dn_drive</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">gait</span> <span class="o">==</span> <span class="s2">&quot;wave&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">right_turn_dn_drive</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span> <span class="k">if</span> <span class="n">gait</span> <span class="o">==</span> <span class="s2">&quot;wave&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">obs_hist</span><span class="p">,</span> <span class="n">info_hist</span><span class="p">,</span> <span class="n">action_hist</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">_real_heading_buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">running_time</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)):</span>
        <span class="n">walking_state</span><span class="p">,</span> <span class="n">dn_drive</span> <span class="o">=</span> <span class="n">random_exploration_controller</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">action_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dn_drive</span><span class="p">)</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dn_drive</span><span class="p">)</span>

        <span class="c1"># Get real heading</span>
        <span class="n">orientation_x</span><span class="p">,</span> <span class="n">orientation_y</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly_orientation&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">real_heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">orientation_y</span><span class="p">,</span> <span class="n">orientation_x</span><span class="p">)</span>
        <span class="n">_real_heading_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">real_heading</span><span class="p">)</span>

        <span class="n">obs_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">info_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="c1"># Save data if output_dir is provided</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;sim_data.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;obs_hist&quot;</span><span class="p">:</span> <span class="n">obs_hist</span><span class="p">,</span>
                <span class="s2">&quot;info_hist&quot;</span><span class="p">:</span> <span class="n">info_hist</span><span class="p">,</span>
                <span class="s2">&quot;action_hist&quot;</span><span class="p">:</span> <span class="n">action_hist</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s run a 1-second simulation and plot the fly’s trajectory:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outputs/path_integration/&quot;</span><span class="p">)</span>
<span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">run_simulation</span><span class="p">(</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">running_time</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gait</span><span class="o">=</span><span class="s2">&quot;tripod&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [00:36&lt;00:00, 270.96it/s]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;sim_data.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]])</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trajectory&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x position (mm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y position (mm)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;trajectory_sample_1s.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/trajectory_sample_1s.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/trajectory_sample_1s.png?raw=true" />
</figure>
<p>We can also plot the recorded shifts in leg tip positions relative to
the fly’s thorax:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stride_diff_unmasked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;stride_diff_unmasked&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stride_diff_unmasked</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span> <span class="s2">&quot;Middle&quot;</span><span class="p">,</span> <span class="s2">&quot;Hind&quot;</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">left_ts</span> <span class="o">=</span> <span class="n">stride_diff_unmasked</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">right_ts</span> <span class="o">=</span> <span class="n">stride_diff_unmasked</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">left_ts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">right_ts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;x offset (mm)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg_pair</span><span class="si">}</span><span class="s2"> legs&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;ee_shift_1s.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/ee_shift_1s.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/ee_shift_1s.png?raw=true" />
</figure>
<p>This plot shows the time series of the change in the x position (along
the anterior-posterior axis) of the leg tips from the previous time
step. Note that the values can be both positive and negative. This is
because we are simply reporting the shift in the claw positions without
taking into account whether the legs are in stance or swing yet.</p>
<p>In the NeuroMechFly v2 paper, we ran 15 trials with different random
seeds for each of the three gaits: tripod gait, tetrapod gait, and wave
gait. Each trial was 20 seconds long. In this tutorial, we will use only
5 trials for the tripod gait. We have uploaded the simulation data of
all trials to a SFTP server. Instead of running these simulations
yourself (which would take roughly 20 minutes on a machine with 5+
cores), you can simply download the data by running the following code
block:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO. We are working with our IT team to set up a gateway to share these data publicly</span>
<span class="c1"># in a secure manner. We aim to update this by the end of June. Please reach out to us</span>
<span class="c1"># by email in the meantime.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exploration_data_dir</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;Data/flygym_demo_data/path_integration/random_exploration/&quot;</span>
<span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">exploration_data_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
        <span class="s2">&quot;Pregenerated simulation data not found. Please download it from &quot;</span>
        <span class="s2">&quot;https://zenodo.org/records/14890040&quot;</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OK] Pregenerated simulation data found. Ready to proceed.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">OK</span><span class="p">]</span> <span class="n">Pregenerated</span> <span class="n">simulation</span> <span class="n">data</span> <span class="n">found</span><span class="o">.</span> <span class="n">Ready</span> <span class="n">to</span> <span class="n">proceed</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="extracting-input-and-target-variables-from-simulation-data">
<h2>Extracting input and target variables from simulation data<a class="headerlink" href="#extracting-input-and-target-variables-from-simulation-data" title="Link to this heading">¶</a></h2>
<p>Let’s start by loading basic information — time series of end effector
positions, ground contact forces, descending drives, fly orientation,
and fly position — from the simulation data files.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_trial_data</span><span class="p">(</span><span class="n">trial_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load simulation data from trial.</span>
<span class="sd">    The difference between ``load_trial_data`` and ``extract_variables`` is</span>
<span class="sd">    that the former loads the raw data from the trial (i.e., physics</span>
<span class="sd">    simulation). The latter extracts variables from these raw data subject</span>
<span class="sd">    to additional parameters such as time scale. For each trial, we only</span>
<span class="sd">    call ``load_trial_data`` once, but we may call ``extract_variables``</span>
<span class="sd">    multiple times with different parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trial_dir : Path</span>
<span class="sd">        Path to the directory containing the trial data saved in</span>
<span class="sd">        ``exploration.run_simulation``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[str, np.ndarray]</span>
<span class="sd">        Dictionary containing the following keys, each mapping to a time</span>
<span class="sd">        series saved as a numpy array:</span>
<span class="sd">        * &quot;end_effector_pos_diff&quot;: End effector positions.</span>
<span class="sd">        * &quot;contact_force&quot;: Contact forces.</span>
<span class="sd">        * &quot;dn_drive&quot;: DN drives.</span>
<span class="sd">        * &quot;fly_orientation_xy&quot;: Fly orientation in the form of a unit vector</span>
<span class="sd">          on the xy plane.</span>
<span class="sd">        * &quot;fly_orientation_angle&quot;: Fly orientation in the form of an angle</span>
<span class="sd">          in radians.</span>
<span class="sd">        * &quot;fly_pos&quot;: Fly position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">trial_dir</span> <span class="o">/</span> <span class="s2">&quot;sim_data.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">obs_hist</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]</span>

    <span class="c1"># End effector positions</span>
    <span class="n">end_effector_pos_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;stride_diff_unmasked&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="c1"># Contact forces</span>
    <span class="n">contact_force_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;contact_forces&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>
    <span class="n">contact_force_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">contact_force_ts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># calc force magnitude</span>
    <span class="n">contact_force_ts</span> <span class="o">=</span> <span class="n">contact_force_ts</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># total per leg</span>

    <span class="c1"># Fly position</span>
    <span class="n">fly_pos_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Heading</span>
    <span class="n">fly_orientation_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly_orientation&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>
    <span class="n">fly_orientation_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
        <span class="n">fly_orientation_xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">fly_orientation_xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Clear RAM right away manually to avoid memory fragmentation</span>
    <span class="k">del</span> <span class="n">sim_data</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">:</span> <span class="n">end_effector_pos_diff</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;contact_force&quot;</span><span class="p">:</span> <span class="n">contact_force_ts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;fly_orientation_xy&quot;</span><span class="p">:</span> <span class="n">fly_orientation_xy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;fly_orientation_angle&quot;</span><span class="p">:</span> <span class="n">fly_orientation_angle</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;fly_pos&quot;</span><span class="p">:</span> <span class="n">fly_pos_ts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trial_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_trials</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading trial </span><span class="si">{</span><span class="n">seed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">num_trials</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">trial_dir</span> <span class="o">=</span> <span class="n">exploration_data_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;seed=</span><span class="si">{</span><span class="n">seed</span><span class="si">}</span><span class="s2">_gait=tripod&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_trial_data</span><span class="p">(</span><span class="n">trial_dir</span><span class="p">)</span>
    <span class="n">trial_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loading</span> <span class="n">trial</span> <span class="mi">1</span> <span class="n">of</span> <span class="mf">5.</span><span class="o">..</span>
<span class="n">Loading</span> <span class="n">trial</span> <span class="mi">2</span> <span class="n">of</span> <span class="mf">5.</span><span class="o">..</span>
<span class="n">Loading</span> <span class="n">trial</span> <span class="mi">3</span> <span class="n">of</span> <span class="mf">5.</span><span class="o">..</span>
<span class="n">Loading</span> <span class="n">trial</span> <span class="mi">4</span> <span class="n">of</span> <span class="mf">5.</span><span class="o">..</span>
<span class="n">Loading</span> <span class="n">trial</span> <span class="mi">5</span> <span class="n">of</span> <span class="mf">5.</span><span class="o">..</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trial_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dict_keys</span><span class="p">([</span><span class="s1">&#39;end_effector_pos_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;contact_force&#39;</span><span class="p">,</span> <span class="s1">&#39;fly_orientation_xy&#39;</span><span class="p">,</span> <span class="s1">&#39;fly_orientation_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;fly_pos&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>We will perform some sanity tests on the data. As before, we can
visualize the per-step change in end effector (leg tip) positions over 1
second of simulation, but this time in 2D:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span> <span class="s2">&quot;Middle&quot;</span><span class="p">,</span> <span class="s2">&quot;Hind&quot;</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">][</span><span class="mi">10000</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">][</span><span class="mi">10000</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">][</span><span class="mi">10000</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">][</span><span class="mi">10000</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg_pair</span><span class="si">}</span><span class="s2"> leg tips&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x offset (mm)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y offset (mm)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;ee_shift_2d.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/ee_shift_2d.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/ee_shift_2d.png?raw=true" />
</figure>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;contact_force&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg_pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span> <span class="s2">&quot;Middle&quot;</span><span class="p">,</span> <span class="s2">&quot;Hind&quot;</span><span class="p">]):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;contact_force&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;contact_force&quot;</span><span class="p">][:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg_pair</span><span class="si">}</span><span class="s2"> leg contact force&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Force (mN)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;ee_contact_force.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/ee_contact_force.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/ee_contact_force.png?raw=true" />
</figure>
<p>From the contact force time series, we can observe that:</p>
<ol class="arabic simple">
<li><p>There are roughly 6 groups of non-zero blocks per time series. These
are the 6 stance phases per line over the period of 0.5 seconds (the
CPG frequency is 12 Hz).</p></li>
<li><p>The two sides are not necessarily symmetrical. This is because the
fly might turn during walking.</p></li>
<li><p>The hind leg has a lower signal-to-noise ratio than the front and
middle legs.</p></li>
</ol>
<p>Next, we will inspect the fly’s orientation and position:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">unwrapped_heading</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fly_orientation_angle&quot;</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">unwrapped_heading</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Heading ($^\circ$)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fly heading&quot;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fly_pos&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;fly_pos&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x position (mm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y position (mm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fly trajectory&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;heading_and_trajectory.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/heading_and_trajectory.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/heading_and_trajectory.png?raw=true" />
</figure>
<p>Recall the algorithm that we have proposed. To train the models, we need
to collect the following <em>input</em> variables to the model:</p>
<ul class="simple">
<li><p>Difference in the left-right <em>sum</em> of cumulated stride lengths,
<code class="docutils literal notranslate"><span class="pre">stride_total_diff_lrsum</span></code></p></li>
<li><p>Difference in the left-right <em>difference</em> of cumulated stride
lengths, <code class="docutils literal notranslate"><span class="pre">stride_total_diff_lrdiff</span></code></p></li>
</ul>
<p>… and the following <em>target</em> variables (i.e., what the models are
supposed to predict):</p>
<ul class="simple">
<li><p>Difference in the fly’s heading, <code class="docutils literal notranslate"><span class="pre">heading_diff</span></code></p></li>
<li><p>Difference in the fly’s total forward displacement,
<code class="docutils literal notranslate"><span class="pre">forward_disp_total_diff</span></code></p></li>
</ul>
<p>There are two things to note here:</p>
<ol class="arabic simple">
<li><p>We have not implemented the calculation of stride lengths yet;
<code class="docutils literal notranslate"><span class="pre">stride_diff_unmasked</span></code> is only the shift of the leg tip position
from one time step to the next.</p></li>
<li><p>As discussed in the Algorithm section, the differences above are
calculated over a predefined time scale <span class="math notranslate nohighlight">\(\tau\)</span>.</p></li>
</ol>
<p>To calculate the cumulated stride lengths given
<code class="docutils literal notranslate"><span class="pre">stride_diff_unmasked</span></code>, we need to mask it with a boolean time series
indicating whether the leg is “pushing” (as opposed to swinging) before
taking the cumulative sum. More precisely,</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{gather*}
    \text{stride_total}[0] = 0 \\
    \text{stride_total}[i] = \text{stride_total}[i - 1] +
        \big( \text{mask}[i] \cdot \text{ stride_diff_unmasked}[i] \big)
    \quad \text{for } i &gt; 0
\end{gather*}\end{split}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\text{mask}[i]\)</span> is a boolean indicating whether the leg is
in the power stroke (push). In our example, we will use the ground
contact force to determine if the leg is in contact with the floor. If
it is, then the leg is executing a power stroke. We will use a threshold
of 0.5 mN, 1 mN, and 3mN for the front, middle, and hind legs
respectively.</p>
<p>Once we have the cumulative stride lengths for each leg, we can
calculate how it changes over the predefined time scale <span class="math notranslate nohighlight">\(\tau\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{stride_total_diff}[i] =
    \text{stride_total}[i] - \text{stride_total}[i - \text{window_len}]\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\text{window_len} = \tau / \Delta t\)</span> is the number of
simulation steps over the time scale <span class="math notranslate nohighlight">\(\tau\)</span>.</p>
<p>With this, we can finally calculate the changes in the left-right sum
and left-right difference of cumulative stride lengths for each leg pair
over time:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    \text{stride_total_diff_lrsum}[i] &amp;=
        \text{stride_total_diff}_\text{left}[i] +
        \text{stride_total_diff}_\text{right}[i] \\
    \text{stride_total_diff_lrdiff}[i] &amp;=
        \text{stride_total_diff}_\text{left}[i] -
        \text{stride_total_diff}_\text{right}[i] \\
\end{align*}\end{split}\]</div>
</div>
<p>Having extracted the <em>input</em> variables, we will next extract the target
<em>output</em> variables: the changes in the fly’s heading and forward
displacement over the same time scale.</p>
<p>Calculating the change in the fly’s heading is straightforward: for each
simulation step <span class="math notranslate nohighlight">\(i\)</span>,</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{heading_diff}[i] = \text{heading}[i] - \text{heading}[i - \text{window_len}]
\quad \text{wrapped to $[-\pi, \pi)$}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\text{heading}\)</span> is the heading angle.</p>
<p>To calculate the change in the fly’s forward displacement, we first have to
accumulate the forward displacement from one step to the next over the
whole simulation. We will call this variable
<span class="math notranslate nohighlight">\(\text{forward_disp}\)</span>. This sounds simply like the total travel
distance, but the critical difference is that at the scale of single
simulation steps, we discard lateral movements. Then, similar to the
change in heading, we can simply calculate the cumulative forward
displacement over the time period of <span class="math notranslate nohighlight">\(\tau\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{gather*}
    \text{forward_disp}[0] = 0, \\
    \text{forward_disp}[i] =
        \text{forward_disp}[i - 1] + \text{d_forward_disp}[i]
    \quad\text{for } i &gt; 0
\end{gather*}\end{split}\]</div>
</div>
<p>where</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\text{d_forward_disp}[i] = (\overrightarrow{\text{position}}[i] -
        \overrightarrow{\text{position}}[i - 1]) \cdot
        \begin{bmatrix}
            \cos(\text{heading}[i])\\
            \sin(\text{heading}[i])
        \end{bmatrix}\end{split}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\overrightarrow{\text{position}}[i]\)</span> is the fly’s vector
position (x-y) at simulation step <span class="math notranslate nohighlight">\(i\)</span>.</p>
<p>With this, the change in total forward displacement is:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{forward_disp_diff}[i] =
    \text{forward_disp}[i] -
    \text{forward_disp}[i - \text{window_len}]\]</div>
</div>
<p>Let’s implement a function that extracts these variables:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extract_variables</span><span class="p">(</span>
    <span class="n">trial_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">time_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">contact_force_thr</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract variables used for path integration from trial data.</span>
<span class="sd">    The difference between ``load_trial_data`` and ``extract_variables`` is</span>
<span class="sd">    that the former loads the raw data from the trial (i.e., physics</span>
<span class="sd">    simulation). The latter extracts variables from these raw data subject</span>
<span class="sd">    to additional parameters such as time scale. For each trial, we only</span>
<span class="sd">    call ``load_trial_data`` once, but we may call ``extract_variables``</span>
<span class="sd">    multiple times with different parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trial_data : dict[str, np.ndarray]</span>
<span class="sd">        Dictionary containing trial data.</span>
<span class="sd">    time_scale : float</span>
<span class="sd">        Time scale for path integration.</span>
<span class="sd">    contact_force_thr : tuple[float, float, float]</span>
<span class="sd">        Thresholds for contact forces. These are used to determine whether</span>
<span class="sd">        a leg is in contact with the ground.</span>
<span class="sd">    dt : float, optional</span>
<span class="sd">        Time step of the physics simulation in the trial, by default 1e-4.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_scale</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="c1"># contact force thresholds: (3,) -&gt; (6,), for both sides</span>
    <span class="n">contact_force_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">contact_force_thr</span><span class="p">,</span> <span class="o">*</span><span class="n">contact_force_thr</span><span class="p">])</span>

    <span class="c1"># Mechanosensory signal ==========</span>
    <span class="c1"># Calculate total stride (Σstride) for each side</span>
    <span class="n">stride_left</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">][:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># (L, 3)</span>
    <span class="n">stride_right</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;end_effector_pos_diff&quot;</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># (L, 3)</span>
    <span class="n">contact_mask</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;contact_force&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">contact_force_thr</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (L, 6)</span>
    <span class="n">stride_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">stride_left</span> <span class="o">*</span> <span class="n">contact_mask</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">stride_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">stride_right</span> <span class="o">*</span> <span class="n">contact_mask</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:])</span>
    <span class="n">stride_total_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">stride_left</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">stride_total_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">stride_right</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Calculate difference in Σstride over proprioceptive time window (ΔΣstride)</span>
    <span class="n">stride_total_diff_left</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">stride_total_left</span><span class="p">[</span><span class="n">window_len</span><span class="p">:]</span> <span class="o">-</span> <span class="n">stride_total_left</span><span class="p">[:</span><span class="o">-</span><span class="n">window_len</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">stride_total_diff_right</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">stride_total_right</span><span class="p">[</span><span class="n">window_len</span><span class="p">:]</span> <span class="o">-</span> <span class="n">stride_total_right</span><span class="p">[:</span><span class="o">-</span><span class="n">window_len</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Calculate sum and difference in ΔΣstride over two sides</span>
    <span class="n">stride_total_diff_lrsum</span> <span class="o">=</span> <span class="n">stride_total_diff_left</span> <span class="o">+</span> <span class="n">stride_total_diff_right</span>
    <span class="n">stride_total_diff_lrdiff</span> <span class="o">=</span> <span class="n">stride_total_diff_left</span> <span class="o">-</span> <span class="n">stride_total_diff_right</span>

    <span class="c1"># Change in locomotion state (heading &amp; displacement) ==========</span>
    <span class="c1"># Calculate change in fly orientation over proprioceptive time window (Δheading)</span>
    <span class="n">fly_orientation_xy</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_orientation_xy&quot;</span><span class="p">]</span>
    <span class="n">fly_orientation_angle</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_orientation_angle&quot;</span><span class="p">]</span>
    <span class="n">heading_diff</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">fly_orientation_angle</span><span class="p">[</span><span class="n">window_len</span><span class="p">:]</span> <span class="o">-</span> <span class="n">fly_orientation_angle</span><span class="p">[:</span><span class="o">-</span><span class="n">window_len</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">heading_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">heading_diff</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># wrap to [-π, π]</span>

    <span class="c1"># Same for displacement projected in the direction of fly&#39;s heading</span>
    <span class="c1"># Use projection formula: proj_v(u) = (u · v) / (v · v) * v where v is the fly&#39;s</span>
    <span class="c1"># heading vector and u is the change in position</span>
    <span class="n">fly_disp_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_pos&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fly_orientation_xy_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">fly_orientation_xy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fly_orientation_xy_unit</span> <span class="o">=</span> <span class="n">fly_orientation_xy</span> <span class="o">/</span> <span class="n">fly_orientation_xy_norm</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">udotv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fly_disp_xy</span> <span class="o">*</span> <span class="n">fly_orientation_xy_unit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vdotv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fly_orientation_xy_unit</span> <span class="o">*</span> <span class="n">fly_orientation_xy_unit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">forward_disp_mag</span> <span class="o">=</span> <span class="n">udotv</span> <span class="o">/</span> <span class="n">vdotv</span>
    <span class="n">forward_disp_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">forward_disp_mag</span><span class="p">)</span>
    <span class="n">forward_disp_total_diff</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">forward_disp_total</span><span class="p">[</span><span class="n">window_len</span><span class="p">:]</span> <span class="o">-</span> <span class="n">forward_disp_total</span><span class="p">[:</span><span class="o">-</span><span class="n">window_len</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;stride_total_diff_lrsum&quot;</span><span class="p">:</span> <span class="n">stride_total_diff_lrsum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;stride_total_diff_lrdiff&quot;</span><span class="p">:</span> <span class="n">stride_total_diff_lrdiff</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;heading_diff&quot;</span><span class="p">:</span> <span class="n">heading_diff</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;forward_disp_total_diff&quot;</span><span class="p">:</span> <span class="n">forward_disp_total_diff</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Let’s use this function to extract the input and target variables at a
time scale of 0.32 s using a contact force threshold of 0.5 mN, 1 mN,
and 3 mN for the front, middle, and hind legs respectively:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_scale</span> <span class="o">=</span> <span class="mf">0.32</span>
<span class="n">contact_force_thr</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">extracted_variables</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">extract_variables</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_scale</span><span class="p">,</span> <span class="n">contact_force_thr</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">trial_data</span>
<span class="p">]</span>
</pre></div>
</div>
<p>We are trying to predict the change in forward displacement from the
changes in left-right sums, and the change in heading from the
left-right differences. Let’s plot these variable in one trial to decide
if these are qualitatively good predictors:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext_vars</span> <span class="o">=</span> <span class="n">extracted_variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">t_grid_trim</span> <span class="o">=</span> <span class="n">t_grid</span><span class="p">[</span><span class="o">-</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrsum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span> <span class="s2">&quot;Middle&quot;</span><span class="p">,</span> <span class="s2">&quot;Hind&quot;</span><span class="p">]):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">t_grid_trim</span><span class="p">,</span>
        <span class="o">-</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrsum&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ΔL-R sum (</span><span class="si">{</span><span class="n">leg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid_trim</span><span class="p">,</span>
    <span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;forward_disp_total_diff&quot;</span><span class="p">],</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Δforward displacement&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Length (mm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Δforward displacement predictors and target&quot;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;Front&quot;</span><span class="p">,</span> <span class="s2">&quot;Middle&quot;</span><span class="p">,</span> <span class="s2">&quot;Hind&quot;</span><span class="p">]):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">t_grid_trim</span><span class="p">,</span>
        <span class="o">-</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrdiff&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ΔL-R difference (</span><span class="si">{</span><span class="n">leg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid_trim</span><span class="p">,</span>
    <span class="o">-</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;heading_diff&quot;</span><span class="p">],</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Δheading&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Length (mm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Δheading predictors and target&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;pathint_predictors_and_target.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_predictors_and_target.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/pathint_predictors_and_target.png?raw=true" />
</figure>
<p>We observe that the inputs (blue, orange, and green lines) indeed seem
to be good predictors of the target (black lines). Next, we will train
the prediction models based on our proposed algorithm.</p>
</section>
<section id="training-models-to-predict-changes-in-locomotor-state">
<h2>Training models to predict changes in locomotor state<a class="headerlink" href="#training-models-to-predict-changes-in-locomotor-state" title="Link to this heading">¶</a></h2>
<p>Once the input and target variables have been extracted, training the
models themselves is relatively easy. As discussed, we will train two
linear models to predict the changes in forward displacement and heading
using changes in the left-right sums and differences in cumulative
stride lengths:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    \text{heading_diff_pred}[i] &amp;=
        \sum_{pos\in\{\text{front}, \text{middle}, \text{hind}\}}
            \big(
                k_{pos}^{({\rm h})} \cdot \text{stride_total_diff_lrsum}_{pos}[i]
            \big) + b^{({\rm h})} \\
    \text{forward_disp_diff_pred}[i] &amp;=
        \sum_{pos\in\{\text{front}, \text{middle}, \text{hind}\}}
            \big(
                k_{pos}^{({\rm fd})} \cdot \text{stride_total_diff_lrdiff}_{pos}[i]
            \big) + b^{({\rm fd})} \\
\end{align*}\end{split}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\text{heading_diff_pred}\)</span> and
<span class="math notranslate nohighlight">\(\text{forward_disp_diff_pred}\)</span> are the model’s predictions of
<span class="math notranslate nohighlight">\(\text{heading_diff}\)</span> and <span class="math notranslate nohighlight">\(\text{forward_disp_diff}\)</span>;
<span class="math notranslate nohighlight">\(k_{pos}^{({\rm h})}\)</span>, <span class="math notranslate nohighlight">\(b^{({\rm h})}\)</span>,
<span class="math notranslate nohighlight">\(k_{pos}^{({\rm fd})}\)</span>, and <span class="math notranslate nohighlight">\(b^{({\rm fd})}\)</span> are the
parameters to be fitted. While we are using all three pairs of legs in
this example, a different set of legs can be used instead.</p>
<p>Recall that we have 5 trials per gait type. We will concatenate the
first 4 trials to form the training set, and then use the last trial for
testing.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stride_total_diff_lrsum_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrsum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext_vars</span> <span class="ow">in</span> <span class="n">extracted_variables</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">stride_total_diff_lrdiff_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrdiff&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext_vars</span> <span class="ow">in</span> <span class="n">extracted_variables</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">heading_diff_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;heading_diff&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext_vars</span> <span class="ow">in</span> <span class="n">extracted_variables</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">forward_disp_total_diff_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">ext_vars</span><span class="p">[</span><span class="s2">&quot;forward_disp_total_diff&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ext_vars</span> <span class="ow">in</span> <span class="n">extracted_variables</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
<span class="p">)</span>
<span class="n">stride_total_diff_lrsum_test</span> <span class="o">=</span> <span class="n">extracted_variables</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;stride_total_diff_lrsum&quot;</span><span class="p">]</span>
<span class="n">stride_total_diff_lrdiff_test</span> <span class="o">=</span> <span class="n">extracted_variables</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;stride_total_diff_lrdiff&quot;</span><span class="p">]</span>
<span class="n">heading_diff_test</span> <span class="o">=</span> <span class="n">extracted_variables</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;heading_diff&quot;</span><span class="p">]</span>
<span class="n">forward_disp_total_diff_test</span> <span class="o">=</span> <span class="n">extracted_variables</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s2">&quot;forward_disp_total_diff&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Then, we will train the linear models using the <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code>
class from scikit-learn.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fit_1d_linear_model</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">LinearRegression</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">r2</span>


<span class="n">heading_model</span><span class="p">,</span> <span class="n">heading_model_r2</span> <span class="o">=</span> <span class="n">fit_1d_linear_model</span><span class="p">(</span>
    <span class="n">stride_total_diff_lrdiff_train</span><span class="p">,</span> <span class="n">heading_diff_train</span>
<span class="p">)</span>
<span class="n">fwd_disp_model</span><span class="p">,</span> <span class="n">fwd_disp_model_r2</span> <span class="o">=</span> <span class="n">fit_1d_linear_model</span><span class="p">(</span>
    <span class="n">stride_total_diff_lrsum_train</span><span class="p">,</span> <span class="n">forward_disp_total_diff_train</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Δheading model:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  coefficients (front, middle, hind legs): </span><span class="si">{</span><span class="n">heading_model</span><span class="o">.</span><span class="n">coef_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  intercept: </span><span class="si">{</span><span class="n">heading_model</span><span class="o">.</span><span class="n">intercept_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  r2 score (training set): </span><span class="si">{</span><span class="n">heading_model_r2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Δforward displacement model:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  coefficients (front, middle, hind legs): </span><span class="si">{</span><span class="n">fwd_disp_model</span><span class="o">.</span><span class="n">coef_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  intercept: </span><span class="si">{</span><span class="n">fwd_disp_model</span><span class="o">.</span><span class="n">intercept_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  r2 score (training set): </span><span class="si">{</span><span class="n">fwd_disp_model_r2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Δheading</span> <span class="n">model</span><span class="p">:</span>
  <span class="n">coefficients</span> <span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">hind</span> <span class="n">legs</span><span class="p">):</span> <span class="p">[</span><span class="mf">0.24994847</span> <span class="mf">0.18084855</span> <span class="mf">0.02075428</span><span class="p">]</span>
  <span class="n">intercept</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.006393308751285076</span>
  <span class="n">r2</span> <span class="n">score</span> <span class="p">(</span><span class="n">training</span> <span class="nb">set</span><span class="p">):</span> <span class="mf">0.961056459682645</span>
<span class="n">Δforward</span> <span class="n">displacement</span> <span class="n">model</span><span class="p">:</span>
  <span class="n">coefficients</span> <span class="p">(</span><span class="n">front</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">hind</span> <span class="n">legs</span><span class="p">):</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5035825</span>  <span class="o">-</span><span class="mf">0.3369246</span>   <span class="mf">0.00302732</span><span class="p">]</span>
  <span class="n">intercept</span><span class="p">:</span> <span class="mf">0.49183177947998047</span>
  <span class="n">r2</span> <span class="n">score</span> <span class="p">(</span><span class="n">training</span> <span class="nb">set</span><span class="p">):</span> <span class="mf">0.9717244581507696</span>
</pre></div>
</div>
</section>
<section id="integrating-changes-in-locomotor-state-to-estimate-position">
<h2>Integrating changes in locomotor state to estimate position<a class="headerlink" href="#integrating-changes-in-locomotor-state-to-estimate-position" title="Link to this heading">¶</a></h2>
<p>Now that we have built models that can estimate the changes in heading
and forward displacement, we will integrate these changes to estimate
the fly’s location in space. To do this, we essentially reverse the
process of extracting the change signals: whereas previously we have
taken the per-step changes in cumulative stride lengths as an estimation
of instantaneous changes, we will now sum these changes as an
approximation of continuous integration.</p>
<p>More formally, from the model-predicted change in heading,
<span class="math notranslate nohighlight">\(\text{heading_diff_pred}\)</span>, the estimated heading can be given
by</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\text{heading_pred}[i] =
    \sum_{i'=0}^i \frac{\text{heading_diff_pred}[i']}{\text{window_len}}\]</div>
</div>
<p>where, once again, <span class="math notranslate nohighlight">\(\text{window_len} = \tau / \Delta t\)</span> is the
number of simulation steps over the time scale <span class="math notranslate nohighlight">\(\tau\)</span>.</p>
<p>To obtain the estimated position vector,
<span class="math notranslate nohighlight">\(\overrightarrow{\text{position_pred}}\)</span>, we have to take into
account the fact that the change in <em>forward</em> displacement must be
integrated in the direction of the fly’s instantaneous heading:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\overrightarrow{\text{position_pred}}[i] =
    \sum_{i'=0}^i \frac{\text{fwd_disp_diff_pred}[i']}{\text{window_len}}
    \begin{bmatrix}
        \cos(\text{heading_pred}[i'])\\
        \sin(\text{heading_pred}[i'])
    \end{bmatrix}\end{split}\]</div>
</div>
<p>We will now implement this integration logic:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>


<span class="k">def</span><span class="w"> </span><span class="nf">path_integrate</span><span class="p">(</span>
    <span class="n">trial_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">heading_model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">displacement_model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">time_scale</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">contact_force_thr</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform path integration on trial data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trial_data : dict[str, np.ndarray]</span>
<span class="sd">        Dictionary containing trial data.</span>
<span class="sd">    heading_model : Callable</span>
<span class="sd">        Model for predicting change in heading.</span>
<span class="sd">    displacement_model : Callable</span>
<span class="sd">        Model for predicting change in displacement.</span>
<span class="sd">    time_scale : float</span>
<span class="sd">        Time scale for path integration.</span>
<span class="sd">    contact_force_thr : tuple[float, float, float]</span>
<span class="sd">        Thresholds for contact forces. These are used to determine whether</span>
<span class="sd">        a leg is in contact with the ground.</span>
<span class="sd">    dt : float</span>
<span class="sd">        Time step of the physics simulation in the trial.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[str, np.ndarray]</span>
<span class="sd">        Dictionary containing the following keys:</span>
<span class="sd">        * &quot;heading_pred&quot;: Predicted heading.</span>
<span class="sd">        * &quot;heading_actual&quot;: Actual heading.</span>
<span class="sd">        * &quot;pos_pred&quot;: Predicted position.</span>
<span class="sd">        * &quot;pos_actual&quot;: Actual position.</span>
<span class="sd">        * &quot;heading_diff_pred&quot;: Predicted change in heading.</span>
<span class="sd">        * &quot;heading_diff_actual&quot;: Actual change in heading.</span>
<span class="sd">        * &quot;displacement_diff_pred&quot;: Predicted change in displacement.</span>
<span class="sd">        * &quot;displacement_diff_actual&quot;: Actual change in displacement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_scale</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">extract_variables</span><span class="p">(</span>
        <span class="n">trial_data</span><span class="p">,</span> <span class="n">time_scale</span><span class="o">=</span><span class="n">time_scale</span><span class="p">,</span> <span class="n">contact_force_thr</span><span class="o">=</span><span class="n">contact_force_thr</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span>
    <span class="p">)</span>

    <span class="c1"># Integrate heading</span>
    <span class="n">heading_diff_pred</span> <span class="o">=</span> <span class="n">heading_model</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrdiff&quot;</span><span class="p">])</span>
    <span class="n">heading_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">heading_diff_pred</span> <span class="o">/</span> <span class="n">window_len</span><span class="p">)</span>
    <span class="c1"># Path int. not performed when not enough data is available. Start from the real</span>
    <span class="c1"># heading at the moment when path int. actually starts.</span>
    <span class="n">hx_start</span><span class="p">,</span> <span class="n">hy_start</span> <span class="o">=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_orientation_xy&quot;</span><span class="p">][</span><span class="n">window_len</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">real_heading_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">hy_start</span><span class="p">,</span> <span class="n">hx_start</span><span class="p">)</span>
    <span class="n">heading_pred</span> <span class="o">+=</span> <span class="n">real_heading_start</span>

    <span class="c1"># Integrate displacement</span>
    <span class="n">displacement_diff_pred</span> <span class="o">=</span> <span class="n">displacement_model</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;stride_total_diff_lrsum&quot;</span><span class="p">])</span>
    <span class="n">displacement_diff_x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">heading_pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">displacement_diff_pred</span>
    <span class="n">displacement_diff_y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">heading_pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">displacement_diff_pred</span>
    <span class="n">pos_x_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">displacement_diff_x_pred</span> <span class="o">/</span> <span class="n">window_len</span><span class="p">)</span>
    <span class="n">pos_y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">displacement_diff_y_pred</span> <span class="o">/</span> <span class="n">window_len</span><span class="p">)</span>
    <span class="n">pos_x_pred</span> <span class="o">+=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_pos&quot;</span><span class="p">][</span><span class="n">window_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pos_y_pred</span> <span class="o">+=</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_pos&quot;</span><span class="p">][</span><span class="n">window_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">pos_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pos_x_pred</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">pos_y_pred</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Pad with NaN where prediction not available</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">window_len</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">heading_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">padding</span><span class="p">,</span> <span class="n">heading_pred</span><span class="p">])</span>
    <span class="n">pos_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">window_len</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">pos_pred</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">heading_diff_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">padding</span><span class="p">,</span> <span class="n">heading_diff_pred</span><span class="p">])</span>
    <span class="n">heading_diff_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">padding</span><span class="p">,</span> <span class="n">variables</span><span class="p">[</span><span class="s2">&quot;heading_diff&quot;</span><span class="p">]])</span>
    <span class="n">displacement_diff_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">padding</span><span class="p">,</span> <span class="n">displacement_diff_pred</span><span class="p">])</span>
    <span class="n">displacement_diff_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span><span class="n">padding</span><span class="p">,</span> <span class="n">variables</span><span class="p">[</span><span class="s2">&quot;forward_disp_total_diff&quot;</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;heading_pred&quot;</span><span class="p">:</span> <span class="n">heading_pred</span><span class="p">,</span>
        <span class="s2">&quot;heading_actual&quot;</span><span class="p">:</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_orientation_angle&quot;</span><span class="p">],</span>
        <span class="s2">&quot;pos_pred&quot;</span><span class="p">:</span> <span class="n">pos_pred</span><span class="p">,</span>
        <span class="s2">&quot;pos_actual&quot;</span><span class="p">:</span> <span class="n">trial_data</span><span class="p">[</span><span class="s2">&quot;fly_pos&quot;</span><span class="p">],</span>
        <span class="s2">&quot;heading_diff_pred&quot;</span><span class="p">:</span> <span class="n">heading_diff_pred</span><span class="p">,</span>
        <span class="s2">&quot;heading_diff_actual&quot;</span><span class="p">:</span> <span class="n">heading_diff_actual</span><span class="p">,</span>
        <span class="s2">&quot;displacement_diff_pred&quot;</span><span class="p">:</span> <span class="n">displacement_diff_pred</span><span class="p">,</span>
        <span class="s2">&quot;displacement_diff_actual&quot;</span><span class="p">:</span> <span class="n">displacement_diff_actual</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>We can run this function on the last trial, which has been reserved for
testing:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_integration_res</span> <span class="o">=</span> <span class="n">path_integrate</span><span class="p">(</span>
    <span class="n">trial_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
    <span class="n">heading_model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>  <span class="c1"># this is LinearRegression&#39;s method for making prediction</span>
    <span class="n">fwd_disp_model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>  <span class="c1"># &quot;</span>
    <span class="n">time_scale</span><span class="p">,</span>
    <span class="n">contact_force_thr</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>… and inspect the time series of predicted vs. actual changes in heading
and forward displacement on this test dataset.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;heading_diff_actual&quot;</span><span class="p">]),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;heading_diff_pred&quot;</span><span class="p">]),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Δheading ($^\circ$)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;displacement_diff_actual&quot;</span><span class="p">]),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;displacement_diff_pred&quot;</span><span class="p">]),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Δfwd. disp. (mm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;path_integration_diff.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_diff.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_diff.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_diff.png?raw=true" style="width: 500px;" />
</a>
</figure>
<p>Similarly, we can plot the integrated estimation of heading and total
forward displacement:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;heading_actual&quot;</span><span class="p">])),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;heading_pred&quot;</span><span class="p">]),</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Heading ($^\circ$)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fwd_disp_total_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;displacement_diff_actual&quot;</span><span class="p">])</span>
<span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_scale</span> <span class="o">/</span> <span class="mf">1e-4</span><span class="p">)</span>
<span class="n">fwd_disp_total_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;displacement_diff_pred&quot;</span><span class="p">])</span>
<span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_scale</span> <span class="o">/</span> <span class="mf">1e-4</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">fwd_disp_total_actual</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">t_grid</span><span class="p">,</span>
    <span class="n">fwd_disp_total_pred</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative fwd. disp. (mm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;path_integration_cumulative.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_cumulative.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_cumulative.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_cumulative.png?raw=true" style="width: 500px;" />
</a>
</figure>
<p>Finally, we can plot the estimated and true trajectories of the fly:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;pos_actual&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;pos_actual&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;pos_pred&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="n">path_integration_res</span><span class="p">[</span><span class="s2">&quot;pos_pred&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x position (mm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y position (mm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;path_integration_trajectory.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default">
<a class="reference internal image-reference" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_trajectory.png?raw=true"><img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_trajectory.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/path_integration/path_integration_trajectory.png?raw=true" style="width: 500px;" />
</a>
</figure>
<p>We can observe that, although the model gives excellent predictions in
heading and forward displacement, small errors in heading can lead to
larger errors in the final position estimation. This is simply due to
the fact that walking straight in a slightly wrong direction amplifies
the error in the estimated position. Therefore, while path integration
based solely on idiothetic cues is possible, calibration of the
integrator based on sensory inputs appears to be critical.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="head_stabilization.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Head stabilization</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="olfaction_basics.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Olfaction basics</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Neuroengineering Laboratory, EPFL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NeLy-EPFL/flygym" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Path integration</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#the-algorithm">The algorithm</a></li>
<li><a class="reference internal" href="#collecting-walking-data">Collecting walking data</a></li>
<li><a class="reference internal" href="#extracting-input-and-target-variables-from-simulation-data">Extracting input and target variables from simulation data</a></li>
<li><a class="reference internal" href="#training-models-to-predict-changes-in-locomotor-state">Training models to predict changes in locomotor state</a></li>
<li><a class="reference internal" href="#integrating-changes-in-locomotor-state-to-estimate-position">Integrating changes in locomotor state to estimate position</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>