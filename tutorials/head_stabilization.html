<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF8S7T56G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DF8S7T56G7');
    </script>
    <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Connectome-constrained visual system model" href="advanced_vision.html" /><link rel="prev" title="Path integration" href="path_integration.html" />
        <link rel="prefetch" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" as="image" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Head stabilization - NeuroMechFly documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NeuroMechFly documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">NeuroMechFly documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../neuromechfly.html">The NeuroMechFly Model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gallery/index.html">Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_3_forces.html">Estimating contact forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_4_climbing.html">Climbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_8_controller_comparison.html">Controller comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_9_visual_taxis.html">Visual taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_10_odour_taxis.html">Odour Taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_11_head_stabilization.html">Head stabilization on complex terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_12_multimodal_navigation.html">Multimodal navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_13_plume_navigation.html">Plume navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_14_fly_follow_fly.html">Fly chasing with a connectome constrained visual system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gym_basics_and_kinematic_replay.html">Interacting with NeuroMechFly</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpg_controller.html">Controlling locomotion with CPGs</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule_based_controller.html">Rule-based controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_controller.html">Overcome complex terrain with a hybrid controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="turning.html">Encapsulating custom code into Gym environments: A turning controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="vision_basics.html">Vision basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="olfaction_basics.html">Olfaction basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="path_integration.html">Path integration</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Head stabilization</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_vision.html">Connectome-constrained visual system model</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_olfaction.html">Advanced olfaction: Navigating a complex odor plume</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api_ref/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/mdp_specs.html">MDP Task Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/fly.html">Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/arena.html">Arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/state.html">State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/vision.html">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/olfaction.html">Olfaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/preprogrammed.html">Preprogrammed</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api_ref/examples/index.html">FlyGym Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of FlyGym Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/locomotion.html">Locomotion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/vision.html">Advanced Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/olfaction.html">Advanced Olfaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/path_integration.html">Path Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/head_stabilization.html">Head Stabilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/legacy.html">Legacy API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workshop.html">NeuroMechFly Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">NeuroMechFly Live and Outreach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/head_stabilization.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="head-stabilization">
<h1>Head stabilization<a class="headerlink" href="#head-stabilization" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Author:</strong> Sibo Wang-Chen</p>
<p>The code presented in this notebook has been simplified and
restructured for display in a notebook format. A more complete and
better structured implementation can be found in the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/flygym/examples/">examples folder of
the FlyGym repository on
GitHub</a>.</p>
<p>This tutorial is available in <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> format in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/notebooks">notebooks folder of the FlyGym repository</a>.</p>
</div>
<p><strong>Summary:</strong> In this tutorial, we will use mechanosensory information to
correct for self motion in closed loop. We will train an internal model
that predicts the appropriate neck actuation signals, based on leg joint
angles and ground contacts, to minimize head rotations during walking.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>In the <a class="reference external" href="https://neuromechfly.org/tutorials/path_integration.html">previous
tutorial</a>,
we demonstrated how one can integrate ascending mechanosensory
information to estimate the fly’s position. In this tutorial, we will
demonstrate another way in which the fly uses ascending motor signals to
complete the sensorimotor control loop.</p>
<p>In flies, head stabilization has been shown to be used to compensate for
body pitch and roll (<a class="reference external" href="https://doi.org/10.1242/jeb.066910">Kress &amp; Egelhaaf,
2012</a>) during locomotion. It is
thought that these stabilizing movements may be informed by leg sensory
feedback signals (<a class="reference external" href="https://doi.org/10.1007/978-3-319-95972-6_20">Gollin &amp; Dürr,
2018</a>). To explore head
stabilization in our embodied model, we will design a controller in
which leg joint angles (i.e., proprioceptive signals, 6 legs × 7 degrees
of freedom per leg) and ground contacts (i.e., tactile signals, 6 legs)
are given as inputs to a multilayer perceptron (MLP). This model, in
turn, predicts the appropriate head roll and pitch required to cancel
visual rotations caused by the animal’s own body movements during
walking. We will use these signals to actuate the neck joint and aim to
dampen head rotation. This approach is illustrated as follows:</p>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_schematic.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_schematic.png?raw=true" />
</section>
<section id="collecting-training-data">
<h2>Collecting training data<a class="headerlink" href="#collecting-training-data" title="Link to this heading">¶</a></h2>
<p>We start by running short simulations of walking while recording joint
angles, ground contacts, and head rotations. This will give us a set of
input-output pairs to use as training data. To run the simulations, we
implement the following function:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dm_control.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">transformations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dm_control.rl.control</span><span class="w"> </span><span class="kn">import</span> <span class="n">PhysicsError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flygym</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fly</span><span class="p">,</span> <span class="n">ZStabilizedCamera</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.arena</span><span class="w"> </span><span class="kn">import</span> <span class="n">FlatTerrain</span><span class="p">,</span> <span class="n">BlocksTerrain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.preprogrammed</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_cpg_biases</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.locomotion</span><span class="w"> </span><span class="kn">import</span> <span class="n">HybridTurningController</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span>
    <span class="n">gait</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tripod&quot;</span><span class="p">,</span>
    <span class="n">terrain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;flat&quot;</span><span class="p">,</span>
    <span class="n">spawn_xy</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">dn_drive</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">sim_duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">enable_rendering</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">live_display</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate locomotion and collect proprioceptive information to train</span>
<span class="sd">    a neural network for head stabilization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gait : str, optional</span>
<span class="sd">        The type of gait for the fly. Choose from [&#39;tripod&#39;, &#39;tetrapod&#39;,</span>
<span class="sd">        &#39;wave&#39;]. Defaults to &quot;tripod&quot;.</span>
<span class="sd">    terrain : str, optional</span>
<span class="sd">        The type of terrain for the fly. Choose from [&#39;flat&#39;, &#39;blocks&#39;].</span>
<span class="sd">        Defaults to &quot;flat&quot;.</span>
<span class="sd">    spawn_xy : tuple[float, float], optional</span>
<span class="sd">        The x and y coordinates of the fly&#39;s spawn position. Defaults to</span>
<span class="sd">        (0, 0).</span>
<span class="sd">    dn_drive : tuple[float, float], optional</span>
<span class="sd">        The DN drive values for the left and right wings. Defaults to</span>
<span class="sd">        (1, 1).</span>
<span class="sd">    sim_duration : float, optional</span>
<span class="sd">        The duration of the simulation in seconds. Defaults to 0.5.</span>
<span class="sd">    enable_rendering: bool, optional</span>
<span class="sd">        If True, enables rendering. Defaults to False.</span>
<span class="sd">    live_display : bool, optional</span>
<span class="sd">        If True, enables live display. Defaults to False.</span>
<span class="sd">    output_dir : Path, optional</span>
<span class="sd">        The directory to which output files are saved. Defaults to None.</span>
<span class="sd">    pbar : bool, optional</span>
<span class="sd">        If True, enables progress bar. Defaults to False.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised when an unknown terrain type is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">enable_rendering</span><span class="p">)</span> <span class="ow">and</span> <span class="n">live_display</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot enable live display without rendering.&quot;</span><span class="p">)</span>

    <span class="c1"># Set up arena</span>
    <span class="k">if</span> <span class="n">terrain</span> <span class="o">==</span> <span class="s2">&quot;flat&quot;</span><span class="p">:</span>
        <span class="n">arena</span> <span class="o">=</span> <span class="n">FlatTerrain</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">terrain</span> <span class="o">==</span> <span class="s2">&quot;blocks&quot;</span><span class="p">:</span>
        <span class="n">arena</span> <span class="o">=</span> <span class="n">BlocksTerrain</span><span class="p">(</span><span class="n">height_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown terrain type: </span><span class="si">{</span><span class="n">terrain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Set up simulation</span>
    <span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
        <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">draw_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">detect_flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
        <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">spawn_xy</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cam</span> <span class="o">=</span> <span class="n">ZStabilizedCamera</span><span class="p">(</span><span class="n">attachment_point</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
        <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_left&quot;</span><span class="p">,</span>
        <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">HybridTurningController</span><span class="p">(</span>
        <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">,</span>
        <span class="n">phase_biases</span><span class="o">=</span><span class="n">get_cpg_biases</span><span class="p">(</span><span class="n">gait</span><span class="p">),</span>
        <span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span>
        <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span>
        <span class="n">timestep</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Main simulation loop</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">obs_hist</span><span class="p">,</span> <span class="n">info_hist</span><span class="p">,</span> <span class="n">action_hist</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">dn_drive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dn_drive</span><span class="p">)</span>
    <span class="n">physics_error</span><span class="p">,</span> <span class="n">fly_flipped</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">trange</span> <span class="k">if</span> <span class="n">pbar</span> <span class="k">else</span> <span class="nb">range</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sim_duration</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)):</span>
        <span class="n">action_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dn_drive</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">dn_drive</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PhysicsError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Physics error detected!&quot;</span><span class="p">)</span>
            <span class="n">physics_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">enable_rendering</span><span class="p">:</span>
            <span class="n">rendered_img</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get necessary angles</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">thorax</span><span class="p">)</span><span class="o">.</span><span class="n">xquat</span>
        <span class="n">quat_inv</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">quat_inv</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">quat_to_euler</span><span class="p">(</span><span class="n">quat_inv</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;roll&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;yaw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span>

        <span class="n">obs_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">info_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;flip&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flip detected!&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Live display</span>
        <span class="k">if</span> <span class="n">enable_rendering</span> <span class="ow">and</span> <span class="n">live_display</span> <span class="ow">and</span> <span class="n">rendered_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;rendered_img&quot;</span><span class="p">,</span> <span class="n">rendered_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Save data if output_dir is provided</span>
    <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_rendering</span><span class="p">:</span>
            <span class="n">cam</span><span class="o">.</span><span class="n">save_video</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;rendering.mp4&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;sim_data.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;obs_hist&quot;</span><span class="p">:</span> <span class="n">obs_hist</span><span class="p">,</span>
                <span class="s2">&quot;info_hist&quot;</span><span class="p">:</span> <span class="n">info_hist</span><span class="p">,</span>
                <span class="s2">&quot;action_hist&quot;</span><span class="p">:</span> <span class="n">action_hist</span><span class="p">,</span>
                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;fly_flipped&quot;</span><span class="p">:</span> <span class="n">fly_flipped</span><span class="p">,</span>
                    <span class="s2">&quot;physics_error&quot;</span><span class="p">:</span> <span class="n">physics_error</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>With this function, we will run a short simulation using the descending
drive [1.0, 1.0] to walk straight:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outputs/head_stabilization/&quot;</span><span class="p">)</span>
<span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">run_simulation</span><span class="p">(</span>
    <span class="n">gait</span><span class="o">=</span><span class="s2">&quot;tripod&quot;</span><span class="p">,</span>
    <span class="n">terrain</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span>
    <span class="n">spawn_xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">dn_drive</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">sim_duration</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">enable_rendering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">live_display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;tripod_flat_train_set_1.00_1.00&quot;</span><span class="p">,</span>
    <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5000/5000 [00:14&lt;00:00, 338.80it/s]
</pre></div>
</div>
<p>As a sanity check, we can plot the trajectory of the fly:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;tripod_flat_train_set_1.00_1.00/sim_data.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">sim_data_flat</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;fly&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">sim_data_flat</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">trajectory</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trajectory&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Origin&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x position (mm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y position (mm)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_trajectory_sample.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_trajectory_sample.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_trajectory_sample.png?raw=true" />
<p>We can also plot the time series of the variables that we are interested
in, namely:</p>
<ul class="simple">
<li><p><strong>Joint angles</strong> of all leg degrees of freedom (DoFs), 7 real values
per leg per step</p></li>
<li><p><strong>Leg contact</strong> mask, 1 Boolean value per leg per step</p></li>
<li><p>The appropriate neck <strong>roll</strong> needed to cancel out body rotation, 1
real value per step</p></li>
<li><p>The appropriate neck <strong>pitch</strong> needed to cancel out body rotation, 1
real value per step</p></li>
</ul>
<p>Note that we do not correct for rotation on the yaw axis. This is to
avoid delineating unintended body oscillation the from intentional
turning — a task outside the scope of this tutorial.</p>
<p>To get the leg contacts, we will use a contact force threshold of 0.5 mN
for the front legs, 1 mN for the middle legs, and 3 mN for the hind legs
— as was the case in the path integration tutorial.</p>
<p>To get the appropriate neck roll and pitch needed to cancel out body
rotations, we will take the <strong>quaternion</strong> representing the thorax
rotation, invert it, and convert it to <strong>Euler angles</strong>. Quaternions are
a mathematical concept used to represent rotations in three dimensions.
They avoid some of the pitfalls of other rotation representations, such
as gimbal lock. However, quaternions are less intuitive to interpret and
their elements do not directly correspond to the axes on the fly body.
Therefore, we convert the inverted angles to Euler angles with more
familiar axes of rotation (pitch, roll, yaw). More information about
representation of 3D rotation can be found on <a class="reference external" href="https://en.wikipedia.org/wiki/Rotation_formalisms_in_three_dimensions">this Wikipedia
article</a>.</p>
<p>For simplicity of visualization, we will only plot the legs on the left
side:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>

<span class="n">dofs_per_leg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ThC pitch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ThC roll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ThC yaw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CTr pitch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CTr roll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FTi pitch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TiTa pitch&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">contact_force_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>  <span class="c1"># LF LM LH RF RM RH</span>


<span class="k">def</span><span class="w"> </span><span class="nf">visualize_trial_data</span><span class="p">(</span><span class="n">obs_hist</span><span class="p">,</span> <span class="n">info_hist</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_hist</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e-4</span>

    <span class="c1"># Extract joint angles</span>
    <span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;joints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">])</span>

    <span class="c1"># Extract ground contact</span>
    <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;contact_forces&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_hist</span><span class="p">])</span>
    <span class="c1"># get magnitude from xyz vector:</span>
    <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">contact_forces</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># sum over 6 segments per leg (contact sensing enabled for tibia and 5 tarsal segments):</span>
    <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">contact_forces</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">contact_mask</span> <span class="o">=</span> <span class="n">contact_forces</span> <span class="o">&gt;=</span> <span class="n">contact_force_thr</span>

    <span class="c1"># Extract head rotation</span>
    <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roll&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_hist</span><span class="p">])</span>
    <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_hist</span><span class="p">])</span>

    <span class="c1"># Visualize</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Legs</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">leg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;Left front leg&quot;</span><span class="p">,</span> <span class="s2">&quot;Left middle leg&quot;</span><span class="p">,</span> <span class="s2">&quot;Left hind leg&quot;</span><span class="p">]):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Plot joint angles</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">):</span>
            <span class="n">dof_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">joint_angles</span><span class="p">[:,</span> <span class="n">dof_idx</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">leg</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Joint angle ($^\circ$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">])</span>
        <span class="c1"># Plot ground contact</span>
        <span class="n">bool_ts</span> <span class="o">=</span> <span class="n">contact_mask</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">diff_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bool_ts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bool_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">diff_ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">bool_ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">diff_ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">upedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diff_ts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">downedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diff_ts</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">up</span><span class="p">,</span> <span class="n">down</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">upedges</span><span class="p">,</span> <span class="n">downedges</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
                <span class="n">t_grid</span><span class="p">[</span><span class="n">up</span><span class="p">],</span>
                <span class="n">t_grid</span><span class="p">[</span><span class="n">down</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ground contact&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>

    <span class="c1"># Leg legends</span>
    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">):</span>
        <span class="n">legend_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">dof</span><span class="p">))</span>
    <span class="n">legend_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ground contact&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span>
        <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="c1"># Head movement</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">roll</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Head roll&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;midnightblue&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">pitch</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Head pitch&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;saddlebrown&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Head movement&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Angle ($^\circ$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>

    <span class="c1"># Head legends</span>
    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;midnightblue&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">),</span>
        <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;saddlebrown&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pitch&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span>
        <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">visualize_trial_data</span><span class="p">(</span>
    <span class="n">sim_data_flat</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">],</span>
    <span class="n">sim_data_flat</span><span class="p">[</span><span class="s2">&quot;info_hist&quot;</span><span class="p">],</span>
    <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_flat_terrain_ts_sample.png&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_flat_terrain_ts_sample.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_flat_terrain_ts_sample.png?raw=true" />
<p>We observe that, after about 0.1 seconds of transient response, we can
indeed see the gait cycles from the input variables.</p>
<p>If we run another simulation over rugged terrain, the body oscillations
appear more dramatic:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">run_simulation</span><span class="p">(</span>
    <span class="n">gait</span><span class="o">=</span><span class="s2">&quot;tripod&quot;</span><span class="p">,</span>
    <span class="n">terrain</span><span class="o">=</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span>
    <span class="n">spawn_xy</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">dn_drive</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">sim_duration</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">enable_rendering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">live_display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;tripod_blocks_train_set_1.00_1.00&quot;</span><span class="p">,</span>
    <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5000/5000 [00:21&lt;00:00, 235.63it/s]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;tripod_blocks_train_set_1.00_1.00/sim_data.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">sim_data_blocks</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">visualize_trial_data</span><span class="p">(</span>
    <span class="n">sim_data_blocks</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">],</span>
    <span class="n">sim_data_blocks</span><span class="p">[</span><span class="s2">&quot;info_hist&quot;</span><span class="p">],</span>
    <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_blocks_terrain_ts_sample.png&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_blocks_terrain_ts_sample.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_blocks_terrain_ts_sample.png?raw=true" />
</section>
<section id="training-an-internal-model-to-control-neck-actuation">
<h2>Training an internal model to control neck actuation<a class="headerlink" href="#training-an-internal-model-to-control-neck-actuation" title="Link to this heading">¶</a></h2>
<p>In the previous section, we have extracted the ascending sensory signals
and the target motor outputs that are the model’s inputs and outputs.
Now, we will train a multilayer perceptron (MLP) that predicts the
appropriate neck actuation signals using this ascending mechanosensory
information. We will split this task into three technical steps:</p>
<ol class="arabic simple">
<li><p>Implementing a custom PyTorch dataset class to feed our data, through
a dataloader, into the model</p></li>
<li><p>Defining an MLP with three hidden layers</p></li>
<li><p>Training the MLP using the data we have gathered and the data
pipeline that we will have developed</p></li>
</ol>
<section id="implementing-a-custom-pytorch-dataset">
<h3>Implementing a custom PyTorch dataset<a class="headerlink" href="#implementing-a-custom-pytorch-dataset" title="Link to this heading">¶</a></h3>
<p>When training any machine learning or statistical model, it is often
desired to normalize or standardize the input. We will start by
implementing a <code class="docutils literal notranslate"><span class="pre">JointAngleScaler</span></code> class to do standardize joint angle
data (subtract mean, divide by standard deviation). This class can be
initialized in one of two ways:</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">.from_data</span></code> method that calculates the mean and standard
deviation from a given dataset.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">.from_params</span></code> method that uses given user-specified mean and and
standard deviation.</p></li>
</ol>
<p>This way, we can compute the mean and standard deviation from one trial
and use the same parameters on all datasets.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JointAngleScaler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for standardizing joint angles (i.e., using mean and standard</span>
<span class="sd">    deviation.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : np.ndarray</span>
<span class="sd">        The mean values used for scaling.</span>
<span class="sd">    std : np.ndarray</span>
<span class="sd">        The standard deviation values used for scaling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a JointAngleScaler instance from joint angle data. The mean</span>
<span class="sd">        and standard deviation values are calculated from the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_angles : np.ndarray</span>
<span class="sd">            The joint angle data. The shape should be (n_samples, n_joints)</span>
<span class="sd">            where n_samples is, for example, the length of a time series of</span>
<span class="sd">            joint angles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointAngleScaler</span>
<span class="sd">            A JointAngleScaler instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">joint_angles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">joint_angles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scaler</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_params</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mean</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">std</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a JointAngleScaler instance from predetermined mean and</span>
<span class="sd">        standard deviation values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mean : np.ndarray</span>
<span class="sd">            The mean values. The shape should be (n_joints,).</span>
<span class="sd">        std : np.ndarray</span>
<span class="sd">            The standard deviation values. The shape should be (n_joints,).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointAngleScaler</span>
<span class="sd">            A JointAngleScaler instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span>
        <span class="k">return</span> <span class="n">scaler</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scale the given joint angles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_angles : np.ndarray</span>
<span class="sd">            The joint angles to be scaled. The shape should be (n_samples,</span>
<span class="sd">            n_joints) where n_samples is, for example, the length of a time</span>
<span class="sd">            series of joint angles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The scaled joint angles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">joint_angles</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">std</span>
</pre></div>
</div>
<p>Then, we will construct a PyTorch dataset class. This class can be seen
as an “adapter”: on one side, it interfaces the specifics of our data
(data structure, format, etc.); on the other side, it outputs what
PyTorch models expect, so that the neural network can work with it. See
<a class="reference external" href="https://pytorch.org/tutorials/beginner/data_loading_tutorial.html">this tutorial from
Pytorch</a>
for more details on the Dataset interface.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>


<span class="k">class</span><span class="w"> </span><span class="nc">WalkingDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PyTorch Dataset class for walking data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim_data_file : Path</span>
<span class="sd">        The path to the simulation data file.</span>
<span class="sd">    contact_force_thr : tuple[float, float, float], optional</span>
<span class="sd">        The threshold values for contact forces, by default (0.5, 1, 3).</span>
<span class="sd">    joint_angle_scaler : Optional[Callable], optional</span>
<span class="sd">        A callable object used to scale joint angles, by default None.</span>
<span class="sd">    ignore_first_n : int, optional</span>
<span class="sd">        The number of initial data points to ignore, by default 200.</span>
<span class="sd">    joint_mask : Optional, optional</span>
<span class="sd">        A mask to apply on joint angles, by default None.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    gait : str</span>
<span class="sd">        The type of gait.</span>
<span class="sd">    terrain : str</span>
<span class="sd">        The type of terrain.</span>
<span class="sd">    subset : str</span>
<span class="sd">        The subset of the data, i.e., &quot;train&quot; or &quot;test&quot;.</span>
<span class="sd">    dn_drive : str</span>
<span class="sd">        The DN drive used to generate the data.</span>
<span class="sd">    contact_force_thr : np.ndarray</span>
<span class="sd">        The threshold values for contact forces.</span>
<span class="sd">    joint_angle_scaler : Callable</span>
<span class="sd">        The callable object used to scale joint angles.</span>
<span class="sd">    ignore_first_n : int</span>
<span class="sd">        The number of initial data points to ignore.</span>
<span class="sd">    joint_mask : Optional</span>
<span class="sd">        The mask applied on joint angles. This is used to zero out certain</span>
<span class="sd">        DoFs to evaluate which DoFs are likely more important for head</span>
<span class="sd">        stabilization.</span>
<span class="sd">    contains_fly_flip : bool</span>
<span class="sd">        Indicates if the simulation data contains fly flip errors.</span>
<span class="sd">    contains_physics_error : bool</span>
<span class="sd">        Indicates if the simulation data contains physics errors.</span>
<span class="sd">    roll_pitch_ts : np.ndarray</span>
<span class="sd">        The optimal roll and pitch correction angles. The shape is</span>
<span class="sd">        (n_samples, 2).</span>
<span class="sd">    joint_angles : np.ndarray</span>
<span class="sd">        The scaled joint angle time series. The shape is (n_samples,</span>
<span class="sd">        n_joints).</span>
<span class="sd">    contact_mask : np.ndarray</span>
<span class="sd">        The contact force mask (i.e., 1 if leg touching the floor, 0</span>
<span class="sd">        otherwise). The shape is (n_samples, 6).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_data_file</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">contact_force_thr</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">joint_angle_scaler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_first_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">joint_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">trial_name</span> <span class="o">=</span> <span class="n">sim_data_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span>
        <span class="n">gait</span><span class="p">,</span> <span class="n">terrain</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dn_left</span><span class="p">,</span> <span class="n">dn_right</span> <span class="o">=</span> <span class="n">trial_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gait</span> <span class="o">=</span> <span class="n">gait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terrain</span> <span class="o">=</span> <span class="n">terrain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn_drive</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dn_left</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dn_right</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_force_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">contact_force_thr</span><span class="p">,</span> <span class="o">*</span><span class="n">contact_force_thr</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_angle_scaler</span> <span class="o">=</span> <span class="n">joint_angle_scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_first_n</span> <span class="o">=</span> <span class="n">ignore_first_n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_mask</span> <span class="o">=</span> <span class="n">joint_mask</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sim_data_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sim_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contains_fly_flip</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">][</span><span class="s2">&quot;fly_flipped&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contains_physics_error</span> <span class="o">=</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">][</span><span class="s2">&quot;physics_error&quot;</span><span class="p">]</span>

        <span class="c1"># Extract the roll and pitch angles</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;roll&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;info_hist&quot;</span><span class="p">]])</span>
        <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;info_hist&quot;</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_pitch_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roll_pitch_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_pitch_ts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_first_n</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># Extract joint angles and scale them</span>
        <span class="n">joint_angles_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;joints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_angle_scaler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joint_angle_scaler</span> <span class="o">=</span> <span class="n">JointAngleScaler</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">joint_angles_raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_angle_scaler</span><span class="p">(</span><span class="n">joint_angles_raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_first_n</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># Extract contact forces</span>
        <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;contact_forces&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">sim_data</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">contact_forces</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># magnitude</span>
        <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">contact_forces</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># sum per leg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">contact_forces</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_force_thr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_first_n</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_pitch_ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">joint_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_angles</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">joint_angles</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;roll_pitch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">roll_pitch_ts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="s2">&quot;joint_angles&quot;</span><span class="p">:</span> <span class="n">joint_angles</span><span class="p">,</span>
            <span class="s2">&quot;contact_mask&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>We can test the joint angle scaler and dataset classes using our trial
simulation:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;joints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">sim_data_flat</span><span class="p">[</span><span class="s2">&quot;obs_hist&quot;</span><span class="p">]])</span>
<span class="n">joint_scaler</span> <span class="o">=</span> <span class="n">JointAngleScaler</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span><span class="n">joint_angles</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">WalkingDataset</span><span class="p">(</span>
    <span class="n">sim_data_file</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;tripod_flat_train_set_1.00_1.00/sim_data.pkl&quot;</span><span class="p">,</span>
    <span class="n">joint_angle_scaler</span><span class="o">=</span><span class="n">joint_scaler</span><span class="p">,</span>
    <span class="n">ignore_first_n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_joint_angle_scaler_params.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">joint_scaler</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">joint_scaler</span><span class="o">.</span><span class="n">std</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s plot the joint angles for the left front leg again, but using the
dataset as an iterator instead of the output returned by
<code class="docutils literal notranslate"><span class="pre">run_simulation</span></code>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e-4</span>
<span class="n">joint_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;joint_angles&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dofs_per_leg</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_grid</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span>
    <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Standardized joint angle (AU)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_joint_angles_scaled.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_joint_angles_scaled.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_joint_angles_scaled.png?raw=true" />
<p>We observe that the joint angles now share a mean of 0 (black line) and
standard deviation of 1 (gray shade).</p>
<p>We can further use the PyTorch dataloader to fetch data in batches. This
is useful for training the MLP in the next step. As an example, we can
create a dataset that gives us a shuffled batch of 32 samples at a time:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">example_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">example_loader</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\t</span><span class="s2">shape: </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roll_pitch</span>  <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">joint_angles</span>        <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">42</span><span class="p">])</span>
<span class="n">contact_mask</span>        <span class="n">shape</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="defining-an-mlp">
<h3>Defining an MLP<a class="headerlink" href="#defining-an-mlp" title="Link to this heading">¶</a></h3>
<p>Having implemented the data pipeline, we will now define the model
itself. We will use <a class="reference external" href="https://lightning.ai/docs/pytorch/stable/">PyTorch
Lightning</a>, a framework
built on top of PyTorch that simplifies checkpointing (saving snapshots
of model parameters during training), logging, etc.</p>
<p>In brief, our <code class="docutils literal notranslate"><span class="pre">ThreeLayerMLP</span></code> class, implemented below, consists of
the following:</p>
<ul class="simple">
<li><p>An <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method that creates three hidden layers and a
<code class="docutils literal notranslate"><span class="pre">R2Score</span></code> object that calculates the <span class="math notranslate nohighlight">\(R^2\)</span> score.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">forward</span></code> method that implements the forward pass of the neural
network — a process where we traverse layers in the network to
calculate values of the output layer based on the input. In our case,
we simply apply the three hidden layers sequentially, with a
Rectified Linear Unit (ReLU) activation function at the end of the
first two layers. Based on this method, PyTorch will automatically
implement the backward pass — a process in gradient-based
optimization algorithms where, after the forward pass, the gradients
for parameters in all layers are traced, starting from the gradient
of the loss on the outputs (i.e., last layer).</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">configure_optimizer</span></code> method that sets up the optimizer — in our
case an <a class="reference external" href="https://arxiv.org/abs/1412.6980">Adam optimizer</a> with a
learning rate of 0.001.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">training_step</span></code> method that defines the operation to be conducted
for each training step (i.e. every time the model receives a new
batch of training data). Here, we concatenate the joint angles and
leg contact masks into a single input block, run the forward pass (we
can simply call the module itself on in the input for this), and
calculate the MSE loss. Then, we log the loss as <em>training loss</em> and
return it. PyTorch Lightning will do the backpropagation for us.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">validation_step</span></code> method that defines what the model should do
every time a batch of validation data is received. Similar to
<code class="docutils literal notranslate"><span class="pre">training_step</span></code>, we run the forward pass, but this time we
calculate the <span class="math notranslate nohighlight">\(R^2\)</span> scores in addition to the MSE loss. Lastly,
we log the <span class="math notranslate nohighlight">\(R^2\)</span> and MSE metrics accordingly.</p></li>
</ul>
<p>For more information on implementing a PyTorch Lightning module, see
<a class="reference external" href="https://lightning.ai/courses/deep-learning-fundamentals/overview-organizing-your-code-with-pytorch-lightning/5-2-training-a-multilayer-perceptron-using-the-lightning-trainer/">this
tutorial</a>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchmetrics.regression</span><span class="w"> </span><span class="kn">import</span> <span class="n">R2Score</span>


<span class="n">pl</span><span class="o">.</span><span class="n">seed_everything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ThreeLayerMLP</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A PyTorch Lightning module for a three-layer MLP that predicts the</span>
<span class="sd">    head roll and pitch correction angles based on proprioception and</span>
<span class="sd">    tactile information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">input_size</span> <span class="o">=</span> <span class="mi">42</span> <span class="o">+</span> <span class="mi">6</span>
        <span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="n">output_size</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2_score</span> <span class="o">=</span> <span class="n">R2Score</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass through the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : torch.Tensor</span>
<span class="sd">            The input tensor. The shape should be (n_samples, 42 + 6)</span>
<span class="sd">            where 42 is the number of joint angles and 6 is the number of</span>
<span class="sd">            contact masks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use the Adam optimizer.&quot;&quot;&quot;</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Training step of the PyTorch Lightning module.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;joint_angles&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;contact_mask&quot;</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;roll_pitch&quot;</span><span class="p">]</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;train_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validation step of the PyTorch Lightning module.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;joint_angles&quot;</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;contact_mask&quot;</span><span class="p">]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;roll_pitch&quot;</span><span class="p">]</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">r2_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_hat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">r2_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_hat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2_roll</span><span class="p">,</span> <span class="n">r2_pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;val_r2_roll&quot;</span><span class="p">,</span> <span class="n">r2_roll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;val_r2_pitch&quot;</span><span class="p">,</span> <span class="n">r2_pitch</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span> <span class="n">Seed</span> <span class="nb">set</span> <span class="n">to</span> <span class="mi">0</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">fabric</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span><span class="n">Seed</span> <span class="nb">set</span> <span class="n">to</span> <span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="training-the-model">
<h3>Training the model<a class="headerlink" href="#training-the-model" title="Link to this heading">¶</a></h3>
<p>Having implemented the data pipeline and defined the model, we will now
train the model. We have pre-generated 126 simulation trials, including
11 training trials and 10 testing trials with different descending
drives, for each of the three gait patterns (tripod gait, tetrapod gait,
and wave gait), and for flat and blocks terrain types. Of these, we
exclude one simulation (wave gait, blocks terrain, test set, DN drives
[0.58, 1.14]) because the fly flipped while walking. You can download
this dataset by running the code block below.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO. We are working with our IT team to set up a gateway to share these data publicly</span>
<span class="c1"># in a secure manner. We aim to update this by the end of June, 2024. Please reach out</span>
<span class="c1"># to us by email in the meantime.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulation_data_dir</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;Data/flygym_demo_data/head_stabilization/random_exploration/&quot;</span>
<span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">simulation_data_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
        <span class="s2">&quot;Pregenerated simulation data not found. Please download it from TODO.&quot;</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OK] Pregenerated simulation data found. Ready to proceed.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">OK</span><span class="p">]</span> <span class="n">Pregenerated</span> <span class="n">simulation</span> <span class="n">data</span> <span class="n">found</span><span class="o">.</span> <span class="n">Ready</span> <span class="n">to</span> <span class="n">proceed</span><span class="o">.</span>
</pre></div>
</div>
<p>Let’s generate a <code class="docutils literal notranslate"><span class="pre">WalkingDataset</span></code> object (implemented above) for each
training trial and concatenate them.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConcatDataset</span>

<span class="n">dataset_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">gait</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tripod&quot;</span><span class="p">,</span> <span class="s2">&quot;tetrapod&quot;</span><span class="p">,</span> <span class="s2">&quot;wave&quot;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">terrain</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="s2">&quot;blocks&quot;</span><span class="p">]:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">simulation_data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gait</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">terrain</span><span class="si">}</span><span class="s2">_train_set_*&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading </span><span class="si">{</span><span class="n">gait</span><span class="si">}</span><span class="s2"> gait, </span><span class="si">{</span><span class="n">terrain</span><span class="si">}</span><span class="s2"> terrain...&quot;</span><span class="p">)</span>
        <span class="n">dn_drives</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dn_drive</span> <span class="ow">in</span> <span class="n">dn_drives</span><span class="p">:</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gait</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">terrain</span><span class="si">}</span><span class="s2">_train_set_</span><span class="si">{</span><span class="n">dn_drive</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">simulation_data_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim</span><span class="si">}</span><span class="s2">/sim_data.pkl&quot;</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">WalkingDataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">joint_angle_scaler</span><span class="o">=</span><span class="n">joint_scaler</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">joint_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>  <span class="c1"># use all joints</span>
            <span class="n">dataset_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
<span class="n">concat_train_set</span> <span class="o">=</span> <span class="n">ConcatDataset</span><span class="p">(</span><span class="n">dataset_list</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training dataset size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loading</span> <span class="n">tripod</span> <span class="n">gait</span><span class="p">,</span> <span class="n">flat</span> <span class="n">terrain</span><span class="o">...</span>
<span class="n">Loading</span> <span class="n">tripod</span> <span class="n">gait</span><span class="p">,</span> <span class="n">blocks</span> <span class="n">terrain</span><span class="o">...</span>
<span class="n">Loading</span> <span class="n">tetrapod</span> <span class="n">gait</span><span class="p">,</span> <span class="n">flat</span> <span class="n">terrain</span><span class="o">...</span>
<span class="n">Loading</span> <span class="n">tetrapod</span> <span class="n">gait</span><span class="p">,</span> <span class="n">blocks</span> <span class="n">terrain</span><span class="o">...</span>
<span class="n">Loading</span> <span class="n">wave</span> <span class="n">gait</span><span class="p">,</span> <span class="n">flat</span> <span class="n">terrain</span><span class="o">...</span>
<span class="n">Loading</span> <span class="n">wave</span> <span class="n">gait</span><span class="p">,</span> <span class="n">blocks</span> <span class="n">terrain</span><span class="o">...</span>
<span class="n">Training</span> <span class="n">dataset</span> <span class="n">size</span><span class="p">:</span> <span class="mi">4800</span>
</pre></div>
</div>
<p>The size is as expected: (3 gaits × 2 terrain types × 11 DN
combinations) × (0.5 seconds of simulation / 0.0001 seconds per step –
200 transient steps excluded) = 976,800 samples in total.</p>
<p>We will further divide the training set into the training set a
validation set at a ratio of 4:1:</p>
<ul class="simple">
<li><p>The training set is used to optimize the parameters of the model.</p></li>
<li><p>The validation set is used to check if the model has been overfitted.</p></li>
<li><p>The testing set is held out throughout the entire training procedure.
It consists of trials simulated using a different set of descending
drives and is only used to report the final out-of-sample performance
of the model.</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">random_split</span>

<span class="n">train_ds</span><span class="p">,</span> <span class="n">val_ds</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">concat_train_set</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
</pre></div>
</div>
<p>As demonstrated above, we will create dataloaders for the training and
validation sets to load the data in batches:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1028</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we will set up a logger to keep track of the training progress,
a checkpoint callback that saves snapshots of model parameters while
training, and a trainer object to orchestrate the training procedure:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">CSVLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">rmtree</span>

<span class="n">log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">log_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">rmtree</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;demo_trial&quot;</span><span class="p">)</span>
<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
    <span class="n">dirpath</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;models/checkpoints&quot;</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">{epoch:02d}</span><span class="s2">-</span><span class="si">{val_loss:.2f}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">save_top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Save only the best checkpoint</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>  <span class="c1"># `min` for minimizing the validation loss</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ThreeLayerMLP</span><span class="p">()</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">checkpoint_callback</span><span class="p">],</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">check_val_every_n_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span> <span class="n">GPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">used</span><span class="p">:</span> <span class="kc">False</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">rank_zero</span><span class="p">:</span><span class="n">GPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">used</span><span class="p">:</span> <span class="kc">False</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">TPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="mi">0</span> <span class="n">TPU</span> <span class="n">cores</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">rank_zero</span><span class="p">:</span><span class="n">TPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="mi">0</span> <span class="n">TPU</span> <span class="n">cores</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">IPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="mi">0</span> <span class="n">IPUs</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">rank_zero</span><span class="p">:</span><span class="n">IPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="mi">0</span> <span class="n">IPUs</span>
<span class="n">INFO</span><span class="p">:</span> <span class="n">HPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="mi">0</span> <span class="n">HPUs</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">rank_zero</span><span class="p">:</span><span class="n">HPU</span> <span class="n">available</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="p">:</span> <span class="mi">0</span> <span class="n">HPUs</span>
</pre></div>
</div>
<p>We are now ready to train the model. We will train the model for 10
epochs. On a machine with a NVIDIA GeForce RTX 3080 Ti GPU (2021), this
takes about 2 minutes.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span> <span class="n">Missing</span> <span class="n">logger</span> <span class="n">folder</span><span class="p">:</span> <span class="n">outputs</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">demo_trial</span>
<span class="n">WARNING</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">fabric</span><span class="o">.</span><span class="n">loggers</span><span class="o">.</span><span class="n">csv_logs</span><span class="p">:</span><span class="n">Missing</span> <span class="n">logger</span> <span class="n">folder</span><span class="p">:</span> <span class="n">outputs</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">demo_trial</span>
<span class="n">INFO</span><span class="p">:</span>
  <span class="o">|</span> <span class="n">Name</span>     <span class="o">|</span> <span class="n">Type</span>    <span class="o">|</span> <span class="n">Params</span>
<span class="o">-------------------------------------</span>
<span class="mi">0</span> <span class="o">|</span> <span class="n">layer1</span>   <span class="o">|</span> <span class="n">Linear</span>  <span class="o">|</span> <span class="mf">1.6</span> <span class="n">K</span>
<span class="mi">1</span> <span class="o">|</span> <span class="n">layer2</span>   <span class="o">|</span> <span class="n">Linear</span>  <span class="o">|</span> <span class="mf">1.1</span> <span class="n">K</span>
<span class="mi">2</span> <span class="o">|</span> <span class="n">layer3</span>   <span class="o">|</span> <span class="n">Linear</span>  <span class="o">|</span> <span class="mi">66</span>
<span class="mi">3</span> <span class="o">|</span> <span class="n">r2_score</span> <span class="o">|</span> <span class="n">R2Score</span> <span class="o">|</span> <span class="mi">0</span>
<span class="o">-------------------------------------</span>
<span class="mf">2.7</span> <span class="n">K</span>     <span class="n">Trainable</span> <span class="n">params</span>
<span class="mi">0</span>         <span class="n">Non</span><span class="o">-</span><span class="n">trainable</span> <span class="n">params</span>
<span class="mf">2.7</span> <span class="n">K</span>     <span class="n">Total</span> <span class="n">params</span>
<span class="mf">0.011</span>     <span class="n">Total</span> <span class="n">estimated</span> <span class="n">model</span> <span class="n">params</span> <span class="n">size</span> <span class="p">(</span><span class="n">MB</span><span class="p">)</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">lightning</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">model_summary</span><span class="p">:</span>
  <span class="o">|</span> <span class="n">Name</span>     <span class="o">|</span> <span class="n">Type</span>    <span class="o">|</span> <span class="n">Params</span>
<span class="o">-------------------------------------</span>
<span class="mi">0</span> <span class="o">|</span> <span class="n">layer1</span>   <span class="o">|</span> <span class="n">Linear</span>  <span class="o">|</span> <span class="mf">1.6</span> <span class="n">K</span>
<span class="mi">1</span> <span class="o">|</span> <span class="n">layer2</span>   <span class="o">|</span> <span class="n">Linear</span>  <span class="o">|</span> <span class="mf">1.1</span> <span class="n">K</span>
<span class="mi">2</span> <span class="o">|</span> <span class="n">layer3</span>   <span class="o">|</span> <span class="n">Linear</span>  <span class="o">|</span> <span class="mi">66</span>
<span class="mi">3</span> <span class="o">|</span> <span class="n">r2_score</span> <span class="o">|</span> <span class="n">R2Score</span> <span class="o">|</span> <span class="mi">0</span>
<span class="o">-------------------------------------</span>
<span class="mf">2.7</span> <span class="n">K</span>     <span class="n">Trainable</span> <span class="n">params</span>
<span class="mi">0</span>         <span class="n">Non</span><span class="o">-</span><span class="n">trainable</span> <span class="n">params</span>
<span class="mf">2.7</span> <span class="n">K</span>     <span class="n">Total</span> <span class="n">params</span>
<span class="mf">0.011</span>     <span class="n">Total</span> <span class="n">estimated</span> <span class="n">model</span> <span class="n">params</span> <span class="n">size</span> <span class="p">(</span><span class="n">MB</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">INFO: <cite>Trainer.fit</cite> stopped: <cite>max_epochs=10</cite> reached.
<a class="reference external" href="INFO:lightning.pytorch.utilities.rank_zero">INFO:lightning.pytorch.utilities.rank_zero</a>:<cite>Trainer.fit</cite> stopped: <cite>max_epochs=10</cite> reached.</pre>
<p>Let’s inspect the model’s performance on the training and validation
sets changed over time. On the validation set, we will plot the loss and
<span class="math notranslate nohighlight">\(R^2\)</span> scores at the end of each epoch.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">logs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;demo_trial/version_0/metrics.csv&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training loss&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logs</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Validation loss&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;MSE loss&quot;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
    <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;val_r2_roll&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;midnightblue&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Roll&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
    <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;val_r2_pitch&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;saddlebrown&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pitch&quot;</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;R² score&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_training_metrics.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_training_metrics.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_training_metrics.png?raw=true" />
<p>Satisfied with the performance, we now proceed to evaluate the model on
the testing set and deploy it in closed loop.</p>
</section>
</section>
<section id="deploying-the-model">
<h2>Deploying the model<a class="headerlink" href="#deploying-the-model" title="Link to this heading">¶</a></h2>
<p>While the PyTorch module <code class="docutils literal notranslate"><span class="pre">ThreeLayerMLP</span></code> can give us predictions, it
is not very lean: a number of training-related elements are exposed to
the caller. For example, the <code class="docutils literal notranslate"><span class="pre">forward</span></code> method expects a <em>batch</em> of
data concatenated in a specific way, and PyTorch will try to load it on
an accelerated hardware automatically if one is found. This is not ideal
for <em>real time</em> deployment — we will only get one input snapshot at a
time and the data is small enough and the steps frequent enough that it
not worth loading/unloading data to the GPU every step. Therefore, as a
next step, we will write a wrapper that provides a minimal interface
that simplifies making single-step predictions natively on the CPU:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HeadStabilizationInferenceWrapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for the head stabilization model to make predictions on</span>
<span class="sd">    observations. Whereas data are collected in large tensors during</span>
<span class="sd">    training, this class provides a &quot;flat&quot; interface for making predictions</span>
<span class="sd">    one observation (i.e., time step) at a time. This is useful for</span>
<span class="sd">    deploying the model in closed loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">scaler_param_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">contact_force_thr</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_path : Path</span>
<span class="sd">            The path to the trained model.</span>
<span class="sd">        scaler_param_path : Path</span>
<span class="sd">            The path to the pickle file containing scaler parameters.</span>
<span class="sd">        contact_force_thr : tuple[float, float, float], optional</span>
<span class="sd">            The threshold values for contact forces that are used to</span>
<span class="sd">            determine the floor contact flags, by default (0.5, 1, 3).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load scaler params</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scaler_param_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">scaler_params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_mean</span> <span class="o">=</span> <span class="n">scaler_params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_std</span> <span class="o">=</span> <span class="n">scaler_params</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span>

        <span class="c1"># Load model</span>
        <span class="c1"># it&#39;s not worth moving data to the GPU, just run it on the CPU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">ThreeLayerMLP</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span>
            <span class="n">model_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contact_force_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">contact_force_thr</span><span class="p">,</span> <span class="o">*</span><span class="n">contact_force_thr</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">joint_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">contact_forces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a prediction given joint angles and contact forces. This is</span>
<span class="sd">        a light wrapper around the model&#39;s forward method and works without</span>
<span class="sd">        batching.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_angles : np.ndarray</span>
<span class="sd">            The joint angles. The shape should be (n_joints,).</span>
<span class="sd">        contact_forces : np.ndarray</span>
<span class="sd">            The contact forces. The shape should be (n_legs * n_segments).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The predicted roll and pitch angles. The shape is (2,).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">joint_angles</span> <span class="o">=</span> <span class="p">(</span><span class="n">joint_angles</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_mean</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_std</span>
        <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">contact_forces</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">contact_forces</span> <span class="o">=</span> <span class="n">contact_forces</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">contact_mask</span> <span class="o">=</span> <span class="n">contact_forces</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_force_thr</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">joint_angles</span><span class="p">,</span> <span class="n">contact_mask</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
        <span class="n">output_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_tensor</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s load the model from the saved checkpoint:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_wrapper</span> <span class="o">=</span> <span class="n">HeadStabilizationInferenceWrapper</span><span class="p">(</span>
    <span class="n">model_path</span><span class="o">=</span><span class="n">checkpoint_callback</span><span class="o">.</span><span class="n">best_model_path</span><span class="p">,</span>
    <span class="n">scaler_param_path</span><span class="o">=</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_joint_angle_scaler_params.pkl&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To deploy the head stabilization model in closed loop, we will write a
<code class="docutils literal notranslate"><span class="pre">run_simulation_closed_loop</span></code> function:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.arena</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseArena</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span>

<span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
<span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run_simulation_closed_loop</span><span class="p">(</span>
    <span class="n">arena</span><span class="p">:</span> <span class="n">BaseArena</span><span class="p">,</span>
    <span class="n">run_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">head_stabilization_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeadStabilizationInferenceWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
        <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
        <span class="n">vision_refresh_rate</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">neck_kp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">head_stabilization_model</span><span class="o">=</span><span class="n">head_stabilization_model</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">HybridTurningController</span><span class="p">(</span><span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span> <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># These are updated at every time step and are used for generating</span>
    <span class="c1"># statistics and plots (except vision_all, which is updated every</span>
    <span class="c1"># time step where the visual input is updated. Visual updates are less</span>
    <span class="c1"># frequent than physics steps).</span>
    <span class="n">head_rotation_hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thorax_rotation_hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">neck_actuation_pred_hist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># model-predicted neck actuation</span>
    <span class="n">neck_actuation_true_hist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ideal neck actuation</span>

    <span class="n">thorax_body</span> <span class="o">=</span> <span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;Thorax&quot;</span><span class="p">)</span>
    <span class="n">head_body</span> <span class="o">=</span> <span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;Head&quot;</span><span class="p">)</span>

    <span class="c1"># Main simulation loop</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_time</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">obs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="n">PhysicsError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Physics error, ending simulation early&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="c1"># Record neck actuation for stats at the end of the simulation</span>
        <span class="k">if</span> <span class="n">head_stabilization_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neck_actuation_pred_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;neck_actuation&quot;</span><span class="p">])</span>
        <span class="n">quat</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">fly</span><span class="o">.</span><span class="n">thorax</span><span class="p">)</span><span class="o">.</span><span class="n">xquat</span>
        <span class="n">quat_inv</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">quat_inv</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
        <span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">quat_to_euler</span><span class="p">(</span><span class="n">quat_inv</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>
        <span class="n">neck_actuation_true_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">]))</span>

        <span class="c1"># Record head and thorax orientation</span>
        <span class="n">thorax_rotation_quat</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">thorax_body</span><span class="p">)</span><span class="o">.</span><span class="n">xquat</span>
        <span class="n">thorax_roll</span><span class="p">,</span> <span class="n">thorax_pitch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">quat_to_euler</span><span class="p">(</span>
            <span class="n">thorax_rotation_quat</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span>
        <span class="p">)</span>
        <span class="n">thorax_rotation_hist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">thorax_roll</span><span class="p">,</span> <span class="n">thorax_pitch</span><span class="p">])</span>
        <span class="n">head_rotation_quat</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">head_body</span><span class="p">)</span><span class="o">.</span><span class="n">xquat</span>
        <span class="n">head_roll</span><span class="p">,</span> <span class="n">head_pitch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">quat_to_euler</span><span class="p">(</span>
            <span class="n">head_rotation_quat</span><span class="p">,</span> <span class="n">ordering</span><span class="o">=</span><span class="s2">&quot;XYZ&quot;</span>
        <span class="p">)</span>
        <span class="n">head_rotation_hist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">head_roll</span><span class="p">,</span> <span class="n">head_pitch</span><span class="p">])</span>

    <span class="c1"># Generate performance stats on head stabilization</span>
    <span class="k">if</span> <span class="n">head_stabilization_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">neck_actuation_true_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">neck_actuation_true_hist</span><span class="p">)</span>
        <span class="n">neck_actuation_pred_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">neck_actuation_pred_hist</span><span class="p">)</span>
        <span class="n">r2_scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># exclude the first 200 frames (transient response)</span>
            <span class="s2">&quot;roll&quot;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span>
                <span class="n">neck_actuation_true_hist</span><span class="p">[</span><span class="mi">200</span><span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">neck_actuation_pred_hist</span><span class="p">[</span><span class="mi">200</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="n">r2_score</span><span class="p">(</span>
                <span class="n">neck_actuation_true_hist</span><span class="p">[</span><span class="mi">200</span><span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">neck_actuation_pred_hist</span><span class="p">[</span><span class="mi">200</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r2_scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">neck_actuation_true_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">neck_actuation_true_hist</span><span class="p">)</span>
        <span class="n">neck_actuation_pred_hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">neck_actuation_true_hist</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;sim&quot;</span><span class="p">:</span> <span class="n">sim</span><span class="p">,</span>
        <span class="s2">&quot;neck_true&quot;</span><span class="p">:</span> <span class="n">neck_actuation_true_hist</span><span class="p">,</span>
        <span class="s2">&quot;neck_pred&quot;</span><span class="p">:</span> <span class="n">neck_actuation_pred_hist</span><span class="p">,</span>
        <span class="s2">&quot;r2_scores&quot;</span><span class="p">:</span> <span class="n">r2_scores</span><span class="p">,</span>
        <span class="s2">&quot;head_rotation_hist&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">head_rotation_hist</span><span class="p">),</span>
        <span class="s2">&quot;thorax_rotation_hist&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thorax_rotation_hist</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>To apply the model-predicted neck actuation signals, we have simply
passed the model as the <code class="docutils literal notranslate"><span class="pre">head_stabilization_model</span></code> parameter to the
<code class="docutils literal notranslate"><span class="pre">Fly</span></code> object. Under the hood, the <code class="docutils literal notranslate"><span class="pre">Fly</span></code> object initializes actuators
for the neck roll and pitch DoFs upon <code class="docutils literal notranslate"><span class="pre">__init__</span></code>. Then, at each
simulation step, the <code class="docutils literal notranslate"><span class="pre">Fly</span></code> class runs the <code class="docutils literal notranslate"><span class="pre">head_stabilization_model</span></code>
and actuates the appropriate DoFs in addition to the user-specified
actions. In code, this is implemented as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Fly</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="o">...</span> <span class="n">head_stabilization_model</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="c1"># Check neck actuation if head stabilization is enabled</span>
        <span class="k">if</span> <span class="n">head_stabilization_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;joint_Head_yaw&quot;</span> <span class="ow">in</span> <span class="n">actuated_joints</span> <span class="ow">or</span> <span class="s2">&quot;joint_Head&quot;</span> <span class="ow">in</span> <span class="n">actuated_joints</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The head joints are actuated by a preset algorithm. &quot;</span>
                    <span class="s2">&quot;However, the head joints are already included in the &quot;</span>
                    <span class="s2">&quot;provided Fly instance. Please remove the head joints from &quot;</span>
                    <span class="s2">&quot;the list of actuated joints.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_neck_actuation</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># tracked only for head stabilization</span>

        <span class="o">...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actuated_joints</span> <span class="o">=</span> <span class="n">actuated_joints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head_stabilization_model</span> <span class="o">=</span> <span class="n">head_stabilization_model</span>

        <span class="o">...</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_stabilization_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">neck_actuators</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">actuator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;actuator_position_</span><span class="si">{</span><span class="n">joint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">joint</span><span class="o">=</span><span class="n">joint</span><span class="p">,</span>
                    <span class="n">kp</span><span class="o">=</span><span class="n">neck_kp</span><span class="p">,</span>
                    <span class="n">ctrlrange</span><span class="o">=</span><span class="s2">&quot;-1000000 1000000&quot;</span><span class="p">,</span>
                    <span class="n">forcelimited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;joint_Head_yaw&quot;</span><span class="p">,</span> <span class="s2">&quot;joint_Head&quot;</span><span class="p">]</span>
            <span class="p">]</span>

    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pre_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="n">joint_action</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s2">&quot;joints&quot;</span><span class="p">]</span>

        <span class="c1"># estimate necessary neck actuation signals for head stabilization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_stabilization_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_observation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">leg_joint_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_observation</span><span class="p">[</span><span class="s2">&quot;joints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">leg_contact_forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_observation</span><span class="p">[</span><span class="s2">&quot;contact_forces&quot;</span><span class="p">]</span>
                <span class="n">neck_actuation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_stabilization_model</span><span class="p">(</span>
                    <span class="n">leg_joint_angles</span><span class="p">,</span> <span class="n">leg_contact_forces</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">neck_actuation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">joint_action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">joint_action</span><span class="p">,</span> <span class="n">neck_actuation</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_neck_actuation</span> <span class="o">=</span> <span class="n">neck_actuation</span>
            <span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actuators</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">neck_actuators</span><span class="p">)</span><span class="o">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">joint_action</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="o">...</span>

        <span class="o">...</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_stabilization_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this is tracked to decide neck actuation for the next step</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;neck_actuation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_neck_actuation</span>

        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">pre_step</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fly</span><span class="o">.</span><span class="n">post_step</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span>
</pre></div>
</div>
<p>Now, we can run the simulation over flat and blocks terrain again:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arena</span> <span class="o">=</span> <span class="n">FlatTerrain</span><span class="p">()</span>
<span class="n">sim_data_flat</span> <span class="o">=</span> <span class="n">run_simulation_closed_loop</span><span class="p">(</span>
    <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">,</span> <span class="n">run_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">head_stabilization_model</span><span class="o">=</span><span class="n">model_wrapper</span>
<span class="p">)</span>

<span class="n">arena</span> <span class="o">=</span> <span class="n">BlocksTerrain</span><span class="p">(</span><span class="n">height_range</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>
<span class="n">sim_data_blocks</span> <span class="o">=</span> <span class="n">run_simulation_closed_loop</span><span class="p">(</span>
    <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">,</span> <span class="n">run_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">head_stabilization_model</span><span class="o">=</span><span class="n">model_wrapper</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10000/10000 [00:16&lt;00:00, 594.56it/s]
100%|██████████| 10000/10000 [00:33&lt;00:00, 299.90it/s]
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R² scores over flat terrain: </span><span class="si">{</span><span class="n">sim_data_flat</span><span class="p">[</span><span class="s1">&#39;r2_scores&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R² scores over blocks terrain: </span><span class="si">{</span><span class="n">sim_data_blocks</span><span class="p">[</span><span class="s1">&#39;r2_scores&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>R² scores over flat terrain: {&#39;roll&#39;: 0.8720892058987814, &#39;pitch&#39;: 0.9293070918490837}
R² scores over blocks terrain: {&#39;roll&#39;: 0.5792754921973917, &#39;pitch&#39;: 0.7106359552091986}
</pre></div>
</div>
<p>Based on these results, we can plot the time series of the
model-predicted neck actuation signals and the ideal neck actuation
signals:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">color_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;roll&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="s2">&quot;midnightblue&quot;</span><span class="p">),</span>
    <span class="s2">&quot;pitch&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;peru&quot;</span><span class="p">,</span> <span class="s2">&quot;saddlebrown&quot;</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">terrain</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Flat&quot;</span><span class="p">,</span> <span class="s2">&quot;Blocks&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">sim_data_flat</span><span class="p">,</span> <span class="n">sim_data_blocks</span><span class="p">]):</span>
    <span class="n">t_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;neck_true&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">1e-4</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;roll&quot;</span><span class="p">,</span> <span class="s2">&quot;pitch&quot;</span><span class="p">]):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_grid</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;neck_true&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Optimal </span><span class="si">{</span><span class="n">dof</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color_config</span><span class="p">[</span><span class="n">dof</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_grid</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;neck_pred&quot;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Optimal </span><span class="si">{</span><span class="n">dof</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color_config</span><span class="p">[</span><span class="n">dof</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terrain</span><span class="si">}</span><span class="s2"> terrain&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Target angle ($^\circ$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">terrain</span> <span class="o">==</span> <span class="s2">&quot;Flat&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">terrain</span> <span class="o">==</span> <span class="s2">&quot;Blocks&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_neck_actuation_sample.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_neck_actuation_sample.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_neck_actuation_sample.png?raw=true" />
<p>Similarly, we can plot the roll and pitch of the head compared to the
thorax over time:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">terrain</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;Flat&quot;</span><span class="p">,</span> <span class="s2">&quot;Blocks&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">sim_data_flat</span><span class="p">,</span> <span class="n">sim_data_blocks</span><span class="p">])</span>
<span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;roll&quot;</span><span class="p">,</span> <span class="s2">&quot;pitch&quot;</span><span class="p">]):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_grid</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;head_rotation_hist&quot;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">]),</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Head&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:red&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t_grid</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;thorax_rotation_hist&quot;</span><span class="p">][:,</span> <span class="n">j</span><span class="p">]),</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Thorax&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dof</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> angle ($^\circ$)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">terrain</span><span class="si">}</span><span class="s2"> terrain&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;head_stabilization_head_vs_thorax.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_head_vs_thorax.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/head_stabilization/head_stabilization_head_vs_thorax.png?raw=true" />
<p>As expected, the rotation of the head has a lower magnitude than that of
the body, even over complex terrain.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="advanced_vision.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Connectome-constrained visual system model</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="path_integration.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Path integration</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Neuroengineering Laboratory, EPFL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NeLy-EPFL/flygym" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Head stabilization</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#collecting-training-data">Collecting training data</a></li>
<li><a class="reference internal" href="#training-an-internal-model-to-control-neck-actuation">Training an internal model to control neck actuation</a><ul>
<li><a class="reference internal" href="#implementing-a-custom-pytorch-dataset">Implementing a custom PyTorch dataset</a></li>
<li><a class="reference internal" href="#defining-an-mlp">Defining an MLP</a></li>
<li><a class="reference internal" href="#training-the-model">Training the model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploying-the-model">Deploying the model</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>