<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DF8S7T56G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DF8S7T56G7');
    </script>
    <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Olfaction basics" href="olfaction_basics.html" /><link rel="prev" title="Encapsulating custom code into Gym environments: A turning controller" href="turning.html" />
        <link rel="prefetch" href="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" as="image" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Vision basics - NeuroMechFly documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">NeuroMechFly documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/banner_small.jpg?raw=true" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">NeuroMechFly documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../neuromechfly.html">The NeuroMechFly Model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gallery/index.html">Gallery</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Gallery</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_3_forces.html">Estimating contact forces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_4_climbing.html">Climbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_8_controller_comparison.html">Controller comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_9_visual_taxis.html">Visual taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_10_odour_taxis.html">Odour Taxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_11_head_stabilization.html">Head stabilization on complex terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_12_multimodal_navigation.html">Multimodal navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_13_plume_navigation.html">Plume navigation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gallery/video_14_fly_follow_fly.html">Fly chasing with a connectome constrained visual system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="gym_basics_and_kinematic_replay.html">Interacting with NeuroMechFly</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpg_controller.html">Controlling locomotion with CPGs</a></li>
<li class="toctree-l2"><a class="reference internal" href="rule_based_controller.html">Rule-based controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_controller.html">Overcome complex terrain with a hybrid controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="turning.html">Encapsulating custom code into Gym environments: A turning controller</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Vision basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="olfaction_basics.html">Olfaction basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="path_integration.html">Path integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_stabilization.html">Head stabilization</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_vision.html">Connectome-constrained visual system model</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced_olfaction.html">Advanced olfaction: Navigating a complex odor plume</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api_ref/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/mdp_specs.html">MDP Task Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/fly.html">Fly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/arena.html">Arena</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/simulation.html">Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/state.html">State</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/vision.html">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/olfaction.html">Olfaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/utils.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/preprogrammed.html">Preprogrammed</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api_ref/examples/index.html">FlyGym Examples</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of FlyGym Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/locomotion.html">Locomotion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/vision.html">Advanced Vision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/olfaction.html">Advanced Olfaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/path_integration.html">Path Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api_ref/examples/head_stabilization.html">Head Stabilization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api_ref/legacy.html">Legacy API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../workshop.html">NeuroMechFly Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../outreach.html">NeuroMechFly Live and Outreach</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/vision_basics.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="vision-basics">
<h1>Vision basics<a class="headerlink" href="#vision-basics" title="Link to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Author:</strong> Sibo Wang-Chen</p>
<p>The code presented in this notebook has been simplified and
restructured for display in a notebook format. A more complete and
better structured implementation can be found in the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/flygym/examples/">examples folder of
the FlyGym repository on
GitHub</a>.</p>
<p>This tutorial is available in <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> format in the
<a class="reference external" href="https://github.com/NeLy-EPFL/flygym/tree/main/notebooks">notebooks folder of the FlyGym repository</a>.</p>
</div>
<p><strong>Summary:</strong> In this tutorial, we will build a simple model to control
the fly to follow a moving sphere. By doing so, we will also demonstrate
how one can create a custom arena.</p>
<p>Animals typically navigate over rugged terrain to reach attractive
objects (e.g. potential mates, food sources) and to avoid repulsive
features (e.g. pheromones from predators) and obstacles. Animals use a
hierarchical controller to achieve these goals: processing higher-order
sensory signals, using them to select the next action, and translating
these decisions into descending commands that drive lower-level motor
systems. We aimed to simulate this sensorimotor hierarchy by adding
vision and olfaction to NeuroMechFly.</p>
<section id="retina-simulation">
<h2>Retina simulation<a class="headerlink" href="#retina-simulation" title="Link to this heading">¶</a></h2>
<p>A fly’s compound eye consists of ∼700–750 individual units called
ommatidia arranged in a hexagonal pattern (see the left panel of the
figure below from the <a class="reference external" href="https://droso4schools.wordpress.com/l4-enzymes/#5">droso4schools
project</a>; see also
<a class="reference external" href="https://azretina.sites.arizona.edu/node/789">this article</a> from the
Arizona Retina Project). To emulate this, we attached a color camera to
each of our model’s compound eyes (top right panel). We then transformed
each camera image into 721 bins, representing ommatidia. Based on
previous studies, we assume a 270° combined azimuth for the fly’s field
of view, with a ∼17° binocular overlap. Visual sensitivity has evolved
to highlight ethologically relevant color spectra at different locations
in the environment. Here, as an initial step toward enabling this
heterogeneity in our model, we implemented yellow- and pale-type
ommatidia—sensitive to the green and blue channels of images rendered by
the physics simulator—randomly assigned at a 7:3 ratio (as reported in
<a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/23293281/">Rister et al, 2013</a>).
Users can substitute the green and blue channel values with the desired
light intensities sensed by yellow- and pale-type ommatidia to achieve
more biorealistic chromatic vision.</p>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision.png?raw=true" />
<p>In NeuroMechFly, the main interface to interact with the fly is the
<a class="reference external" href="https://neuromechfly.org/api_ref/vision.html#retina-simulation">Retina
class</a>.
It is embedded into the <code class="docutils literal notranslate"><span class="pre">NeuroMechFly</span></code> class as its <code class="docutils literal notranslate"><span class="pre">.retina</span></code>
attribute if <code class="docutils literal notranslate"><span class="pre">enable_vision</span></code> is set to True in
<code class="docutils literal notranslate"><span class="pre">NeuroMechFly.sim_params</span></code>. Here, let’s reproduce the top right panel
of the figure above by putting the fly into an arena with three pillars
and simulating the fly’s visual experience.</p>
<p>To start, we do the necessary imports:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gymnasium.utils.env_checker</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_env</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flygym</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fly</span><span class="p">,</span> <span class="n">Camera</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.arena</span><span class="w"> </span><span class="kn">import</span> <span class="n">FlatTerrain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.vision</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObstacleOdorArena</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.locomotion</span><span class="w"> </span><span class="kn">import</span> <span class="n">HybridTurningController</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./outputs/vision_basics&quot;</span><span class="p">)</span>
<span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We have pre-implemented an <code class="docutils literal notranslate"><span class="pre">ObstacleOdorArena</span></code> class with visual
obstacles and an odor source. The details of this class is beyond the
scope of this tutorial, but you can refer to it on the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/blob/main/flygym/examples/obstacle_arena.py">FlyGym github
repository</a>:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We start by creating a simple arena</span>
<span class="n">flat_terrain_arena</span> <span class="o">=</span> <span class="n">FlatTerrain</span><span class="p">()</span>

<span class="c1"># Then, we add visual and olfactory features on top of it</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">ObstacleOdorArena</span><span class="p">(</span>
    <span class="n">terrain</span><span class="o">=</span><span class="n">flat_terrain_arena</span><span class="p">,</span>
    <span class="n">obstacle_positions</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">7.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mf">12.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mf">17.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)]),</span>
    <span class="n">marker_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">obstacle_colors</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
    <span class="n">user_camera_settings</span><span class="o">=</span><span class="p">((</span><span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">65</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">45</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Let’s put the fly in it and simulate 500 timesteps so the fly can stand
on the floor in a stable manner:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
    <span class="n">spawn_pos</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="n">spawn_orientation</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">70</span><span class="p">)),</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">enable_vision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">render_raw_vision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_olfaction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cam_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span><span class="s2">&quot;fixed&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="s2">&quot;euler&quot;</span><span class="p">:(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">65</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;fovy&quot;</span><span class="p">:</span><span class="mi">45</span>
<span class="p">}</span>

<span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span>
    <span class="n">attachment_point</span><span class="o">=</span><span class="n">arena</span><span class="o">.</span><span class="n">root_element</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
    <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;birdeye_cam&quot;</span><span class="p">,</span>
    <span class="n">camera_parameters</span><span class="o">=</span><span class="n">cam_params</span><span class="p">,</span>
    <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">window_size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">608</span><span class="p">),</span>
    <span class="n">fps</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">HybridTurningController</span><span class="p">(</span><span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span> <span class="n">cameras</span><span class="o">=</span><span class="p">[</span><span class="n">cam</span><span class="p">],</span> <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cam</span><span class="o">.</span><span class="n">_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;vision_sim_env.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision_sim_env.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision_sim_env.png?raw=true" />
<p>We can access the intensities sensed by the fly’s ommatidia from the
observation:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape:&quot;</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data type:&quot;</span><span class="p">,</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[[</span><span class="mf">0.9913793</span> <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">1.</span>        <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">1.</span>        <span class="mf">0.</span>       <span class="p">]</span>
  <span class="o">...</span>
  <span class="p">[</span><span class="mf">0.4</span>       <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">0.4</span>       <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">0.4</span>       <span class="mf">0.</span>       <span class="p">]]</span>

 <span class="p">[[</span><span class="mf">0.9913793</span> <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">1.</span>        <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">1.</span>        <span class="mf">0.</span>       <span class="p">]</span>
  <span class="o">...</span>
  <span class="p">[</span><span class="mf">0.4</span>       <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">0.4</span>       <span class="mf">0.</span>       <span class="p">]</span>
  <span class="p">[</span><span class="mf">0.4</span>       <span class="mf">0.</span>       <span class="p">]]]</span>
<span class="n">Shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Data</span> <span class="nb">type</span><span class="p">:</span> <span class="n">float32</span>
</pre></div>
</div>
<p>This gives us a (2, 721, 2) array representing the light intensities
sensed by the ommatidia. The values are normalized to [0, 1]. The first
dimension is for the two eyes (left and right in that order). The second
dimension is for the 721 ommatidia per eye. The third dimension is for
the two color channels (yellow- and pale-type in that order). For each
ommatidia, only one of the two numbers along the last dimension is
nonzero. The yellow- and pale-type ommatidia are split at a 7:3 ratio.
We can verify this below:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonzero_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">])</span>
<span class="n">unique_vals</span><span class="p">,</span> <span class="n">val_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nonzero_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_counts</span> <span class="o">/</span> <span class="n">val_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">([</span><span class="mf">0.70041609</span><span class="p">,</span> <span class="mf">0.29958391</span><span class="p">])</span>
</pre></div>
</div>
<p>But this is array representation is not good for visualization. We can
use the <code class="docutils literal notranslate"><span class="pre">hex_pxls_to_human_readable</span></code> method of the retina to convert
it into a normal [0, 256) 8-bit RGB image that can be plotted. We set
<code class="docutils literal notranslate"><span class="pre">color_8bit</span></code> to True to process the 8-bit color representation more
efficiently and to return the output as an integer ranged from 0 to 255.
We will further take the grayscale image (disregard yellow- vs pale-type
ommatidia) by taking the maximum along the last dimension, i.e. that of
color channels.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vision_left</span> <span class="o">=</span> <span class="n">fly</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">hex_pxls_to_human_readable</span><span class="p">(</span>
    <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">color_8bit</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">vision_left</span> <span class="o">=</span> <span class="n">vision_left</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">vision_right</span> <span class="o">=</span> <span class="n">fly</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">hex_pxls_to_human_readable</span><span class="p">(</span>
    <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">color_8bit</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">vision_right</span> <span class="o">=</span> <span class="n">vision_right</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">vision_left</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Left eye&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">vision_right</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Right eye&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;vision_sim.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision_sim.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision_sim.png?raw=true" />
<p>Since <code class="docutils literal notranslate"><span class="pre">render_raw_vision</span></code> is set to True in the parameters, we can
access the raw RGB vision through the <code class="docutils literal notranslate"><span class="pre">info</span></code> dictionary before pixels
are binned into ommatidia:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;raw_vision&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Left eye&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;raw_vision&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Right eye&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;vision_sim_raw.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision_sim_raw.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/vision_basics/vision_sim_raw.png?raw=true" />
<p>We observe that the ommatidia covering the blue and the green pillars
seem to have a bimodal distribution in intensity. This is because the
ommatidia are stochastically split into yellow- and pale-types, and they
have different sensitivities to different colors.</p>
</section>
<section id="a-dynamic-arena-with-a-moving-sphere">
<h2>A dynamic arena with a moving sphere<a class="headerlink" href="#a-dynamic-arena-with-a-moving-sphere" title="Link to this heading">¶</a></h2>
<p>The next step is to create a custom arena with a moving sphere. To do
this, we will implement a <code class="docutils literal notranslate"><span class="pre">MovingObjArena</span></code> class that inherits from
the <code class="docutils literal notranslate"><span class="pre">flygym.arena.BaseArena</span></code> class. A complete, functioning
implementation of this class is provided under
<code class="docutils literal notranslate"><span class="pre">flygym.examples.vision</span></code> on the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/blob/main/flygym/examples/vision.py">FlyGym
repository</a>.
We start by defining some attributes in its <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MovingObjArena</span><span class="p">(</span><span class="n">BaseArena</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flat terrain with a hovering moving object.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    arena : mjcf.RootElement</span>
<span class="sd">        The arena object that the terrain is built on.</span>
<span class="sd">    ball_pos : tuple[float,float,float]</span>
<span class="sd">        The position of the floating object in the arena.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    size : tuple[int, int]</span>
<span class="sd">        The size of the terrain in (x, y) dimensions.</span>
<span class="sd">    friction : tuple[float, float, float]</span>
<span class="sd">        Sliding, torsional, and rolling friction coefficients, by default</span>
<span class="sd">        (1, 0.005, 0.0001)</span>
<span class="sd">    obj_radius : float</span>
<span class="sd">        Radius of the spherical floating object in mm.</span>
<span class="sd">    obj_spawn_pos : tuple[float,float,float]</span>
<span class="sd">        Initial position of the object, by default (0, 2, 1).</span>
<span class="sd">    move_direction : str</span>
<span class="sd">        Which way the ball moves toward first. Can be &quot;left&quot;, &quot;right&quot;, or</span>
<span class="sd">        &quot;random&quot;.</span>
<span class="sd">    move_speed : float</span>
<span class="sd">        Speed of the moving object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
        <span class="n">friction</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">),</span>
        <span class="n">obj_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">init_ball_pos</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">move_speed</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">move_direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_ball_pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">init_ball_pos</span><span class="p">,</span> <span class="n">obj_radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_ball_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">friction</span> <span class="o">=</span> <span class="n">friction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_speed</span> <span class="o">=</span> <span class="n">move_speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_direction</span> <span class="o">=</span> <span class="n">move_direction</span>
        <span class="k">if</span> <span class="n">move_direction</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_mult</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">move_direction</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_mult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">move_direction</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid move_direction&quot;</span><span class="p">)</span>

        <span class="o">...</span>
</pre></div>
</div>
<p>Next, we define a <code class="docutils literal notranslate"><span class="pre">root_element</span></code> attribute. The simulated world is
represented as a tree of objects, each attached to a parent. For
example, the eyes of the fly are attached to the head, which is in turn
attached to the thorax — the base of the NeuroMechFly model. Note that
this tree is merely a representation of objects and their relation to
each other; there does not necessarily have to be a visual or anatomical
link between the parent and child objects. For example, the base of the
NeuroMechFly model — the thorax — is attached to the world, but the link
between the thorax and the world is a free joint, meaning that it is
free to move in all 6 degrees of freedom. The root element is the root
of this tree.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="bp">self</span><span class="o">.</span><span class="n">root_element</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">RootElement</span><span class="p">()</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Then, we will add the moving sphere. It will be attached to the root
element:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="c1"># Add ball</span>
<span class="n">obstacle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_element</span><span class="o">.</span><span class="n">asset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="s2">&quot;material&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;obstacle&quot;</span><span class="p">,</span> <span class="n">reflectance</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">root_element</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ball_mocap&quot;</span><span class="p">,</span> <span class="n">mocap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ball_pos</span><span class="p">,</span> <span class="n">gravcomp</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">object_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_element</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;ball_mocap&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">object_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ball&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;sphere&quot;</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">obj_radius</span><span class="p">,</span> <span class="n">obj_radius</span><span class="p">),</span>
    <span class="n">rgba</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">material</span><span class="o">=</span><span class="n">obstacle</span><span class="p">,</span>
<span class="p">)</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Next, let’s define a <code class="docutils literal notranslate"><span class="pre">get_spawn_position</span></code> class. This is applies an
offset to the user-defined fly spawn position. For example, if there is
a stage in your arena that is 1 mm high, and you want to place the fly
on this stage, then you might want to apply a transformation to the
user-specified relative spawn position and return
<code class="docutils literal notranslate"><span class="pre">rel_pos</span> <span class="pre">+</span> <span class="pre">np.array([0,</span> <span class="pre">0,</span> <span class="pre">1])</span></code> as the effective spawn position. In
our case, we have a flat arena, so we will just return the spawn
position and orientation as is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_spawn_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">,</span> <span class="n">rel_angle</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rel_pos</span><span class="p">,</span> <span class="n">rel_angle</span>
</pre></div>
</div>
<p>The arena also has a <code class="docutils literal notranslate"><span class="pre">step</span></code> method. Usually, in static arenas, this is
left empty. However, since we want the sphere to move in our arena, we
need to implement this method so the sphere is moved appropriately every
step of the simulation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">physics</span><span class="p">):</span>
    <span class="n">heading_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mult</span><span class="p">])</span>
    <span class="n">heading_vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">heading_vec</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ball_pos</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_speed</span> <span class="o">*</span> <span class="n">heading_vec</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_body</span><span class="p">)</span><span class="o">.</span><span class="n">mocap_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_pos</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">+=</span> <span class="n">dt</span>
</pre></div>
</div>
<p>Finally, let’s implement a <code class="docutils literal notranslate"><span class="pre">reset</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">physics</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_direction</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ball_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_ball_pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">physics</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_body</span><span class="p">)</span><span class="o">.</span><span class="n">mocap_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_pos</span>
</pre></div>
</div>
</section>
<section id="visual-feature-preprocessing">
<h2>Visual feature preprocessing<a class="headerlink" href="#visual-feature-preprocessing" title="Link to this heading">¶</a></h2>
<p>We will preprocess the visual feature by computing the x-y position of
the object on the retina along with its size relative to the whole
retinal image. We do this by applying binary thresholding to the image
and calculating its size and center of mass. This is a good example to
once again showcase the benefit of encapsulating preprogrammed logic
into the Markov Decision Process (implemented as a Gym environment). If
you haven’t, read the tutorial on <a class="reference external" href="https://neuromechfly.org/tutorials/turning.html">building a turning
controller</a> to see
how this is done.</p>
<p>Recall that in the <code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code>, we implemented the
purple arrow in the following figure, encapsulating the CPG network and
the sensory feedback-based correction rules:</p>
<img alt="https://github.com/NeLy-EPFL/_media/blob/main/flygym/mdp.png?raw=true" src="https://github.com/NeLy-EPFL/_media/blob/main/flygym/mdp.png?raw=true" />
<p>Here, we will build yet another layer on top of
<code class="docutils literal notranslate"><span class="pre">HybridTurningController</span></code>, implementing the aforementioned sensory
preprocessing logic (cyan arrow) and encapsulating it inside the new
MDP. As before, a complete, functioning implementation of this class is
provided under <code class="docutils literal notranslate"><span class="pre">flygym.examples.vision</span></code> on the <a class="reference external" href="https://github.com/NeLy-EPFL/flygym/blob/main/flygym/examples/vision.py">FlyGym
repository</a>.</p>
<p>We start by defining an <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method. This time, we will specify
the threshold used in the binary thresholding step. Any pixel darker
than this number will be considered part of the black sphere. We will
also define a decision interval <span class="math notranslate nohighlight">\(\tau\)</span>: the turning signal is
recomputed every <span class="math notranslate nohighlight">\(\tau\)</span> seconds. We will compute the center of
mass (COM) of all ommatidia so that later when we need to compute the
COM of the object (a masked subset of pixels), we can simply take the
average of the COMs of the selected pixels. Finally, we will override
the definition of the observation space with a 6-dimensional one (x, y
positions of the object per side, plus the relative size of the object
per side).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VisualTaxis</span><span class="p">(</span><span class="n">HybridTurningController</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">decision_interval</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj_threshold</span> <span class="o">=</span> <span class="n">obj_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decision_interval</span> <span class="o">=</span> <span class="n">decision_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_substeps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decision_interval</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visual_inputs_hist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">num_ommatidia_per_eye</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">num_ommatidia_per_eye</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">ommatidia_id_map</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observation_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,))</span>
</pre></div>
</div>
<p>Next, let’s implement the visual preprocessing logic discussed above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_process_visual_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_obs</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ommatidia_readings</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">raw_obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">]):</span>
        <span class="n">is_obj</span> <span class="o">=</span> <span class="n">ommatidia_readings</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_threshold</span>
        <span class="n">is_obj_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coms</span><span class="p">[</span><span class="n">is_obj</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_obj_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_obj_coords</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_obj_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">nrows</span>  <span class="c1"># normalize y_center</span>
    <span class="n">features</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">ncols</span>  <span class="c1"># normalize x_center</span>
    <span class="n">features</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retina</span><span class="o">.</span><span class="n">num_ommatidia_per_eye</span>  <span class="c1"># normalize area</span>
    <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">step</span></code> method, we will replace the raw observation with the
output of the <code class="docutils literal notranslate"><span class="pre">_process_visual_observation</span></code> method. We will also
record the retina images every time the simulation renders a frame for
the recorded video. This way, we can visualize the retina images along
with the recorded video later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_signal</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_substeps</span><span class="p">):</span>
        <span class="n">raw_obs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">control_signal</span><span class="p">)</span>
        <span class="n">render_res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">render_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># record visual inputs too because they will be played in the video</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visual_inputs_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_obs</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">visual_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_visual_observation</span><span class="p">(</span><span class="n">raw_obs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visual_features</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Finally, we implement the <code class="docutils literal notranslate"><span class="pre">reset</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">raw_obs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_visual_observation</span><span class="p">(</span><span class="n">raw_obs</span><span class="p">),</span> <span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="implementing-a-object-tracking-controller">
<h2>Implementing a object tracking controller<a class="headerlink" href="#implementing-a-object-tracking-controller" title="Link to this heading">¶</a></h2>
<p>Now that we have implemented the arena and the new Gym environment, we
just need to define the actual controller logic that outputs the 2D
descending representation based on the extracted visual features. As a
proof-of-concept, we have hand-tuned the following relationship:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}\delta_i = \begin{cases}
\min(\max(k a_i + b, \delta_\text{min}), \delta_\text{max})   &amp; \text{if } A_i &gt; A_\text{thr} \\
1  &amp; \text{otherwise}
\end{cases}\end{split}\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\delta_i\)</span> is the descending modulation signal on side
<span class="math notranslate nohighlight">\(i\)</span>; <span class="math notranslate nohighlight">\(a_i\)</span> is the azimuth of the object expressed as the
deviation from the anterior edge of the eye’s field of view, normalized
by the horizontal field of view of the retina; <span class="math notranslate nohighlight">\(A_i\)</span> is the
relative size of the object on the arena; <span class="math notranslate nohighlight">\(k=-3\)</span>, <span class="math notranslate nohighlight">\(b=1\)</span> are
parameters describing the response curve; <span class="math notranslate nohighlight">\(\delta_\text{min}=0.2\)</span>,
<span class="math notranslate nohighlight">\(\delta_\text{max}=1\)</span> describe the range of the descending signal;
<span class="math notranslate nohighlight">\(A_\text{thr} = 1\%\)</span> is the threshold below which the object is
considered unseen from the eye.</p>
<p>Before we implement this in the main simulation loop, let’s instantiate
our arena and Gym environment:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.examples.vision</span><span class="w"> </span><span class="kn">import</span> <span class="n">MovingObjArena</span><span class="p">,</span> <span class="n">VisualTaxis</span>

<span class="n">obj_threshold</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">decision_interval</span> <span class="o">=</span> <span class="mf">0.025</span>
<span class="n">contact_sensor_placements</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leg</span><span class="si">}{</span><span class="n">segment</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;LF&quot;</span><span class="p">,</span> <span class="s2">&quot;LM&quot;</span><span class="p">,</span> <span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RF&quot;</span><span class="p">,</span> <span class="s2">&quot;RM&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Tibia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus1&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus2&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus3&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus4&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarsus5&quot;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">arena</span> <span class="o">=</span> <span class="n">MovingObjArena</span><span class="p">()</span>
<span class="n">fly</span> <span class="o">=</span> <span class="n">Fly</span><span class="p">(</span>
    <span class="n">contact_sensor_placements</span><span class="o">=</span><span class="n">contact_sensor_placements</span><span class="p">,</span>
    <span class="n">enable_adhesion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enable_vision</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="p">(</span><span class="n">attachment_point</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">worldbody</span><span class="p">,</span>
    <span class="n">camera_name</span><span class="o">=</span><span class="s2">&quot;camera_top_zoomout&quot;</span><span class="p">,</span>
    <span class="n">targeted_fly_names</span><span class="o">=</span><span class="n">fly</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">play_speed</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">VisualTaxis</span><span class="p">(</span>
    <span class="n">fly</span><span class="o">=</span><span class="n">fly</span><span class="p">,</span>
    <span class="n">camera</span><span class="o">=</span><span class="n">cam</span><span class="p">,</span>
    <span class="n">obj_threshold</span><span class="o">=</span><span class="n">obj_threshold</span><span class="p">,</span>
    <span class="n">decision_interval</span><span class="o">=</span><span class="n">decision_interval</span><span class="p">,</span>
    <span class="n">arena</span><span class="o">=</span><span class="n">arena</span><span class="p">,</span>
    <span class="n">intrinsic_freqs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">9</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>As before, let’s check if this environment complies with the Gym
interface. Despite a few warnings on design choices, no errors should be
raised.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_env</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
</pre></div>
</div>
<pre class="literal-block">.../gymnasium/utils/env_checker.py:247: UserWarning: [33mWARN: For Box action spaces, we recommend using a symmetric and normalized space (range=[-1, 1] or [0, 1]). See <a class="reference external" href="https://stable-baselines3.readthedocs.io/en/master/guide/rl_tips.html">https://stable-baselines3.readthedocs.io/en/master/guide/rl_tips.html</a> for more information.[0m
  logger.warn(
.../gymnasium/utils/env_checker.py:125: UserWarning: [33mWARN: The default seed argument in reset should be <cite>None</cite>, otherwise the environment will by default always be deterministic. Actual default: 0[0m
  logger.warn(
.../gymnasium/utils/passive_env_checker.py:175: UserWarning: [33mWARN: The default seed argument in <cite>Env.reset</cite> should be <cite>None</cite>, otherwise the environment will by default always be deterministic. Actual default: seed=0[0m
  logger.warn(
.../gymnasium/utils/env_checker.py:321: UserWarning: [33mWARN: Not able to test alternative render modes due to the environment not having a spec. Try instantialising the environment through gymnasium.make[0m
  logger.warn(</pre>
<p>Now, we implement the main simulation loop:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calc_ipsilateral_speed</span><span class="p">(</span><span class="n">deviation</span><span class="p">,</span> <span class="n">is_found</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_found</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">deviation</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>


<span class="n">num_substeps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">decision_interval</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

<span class="n">obs_hist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">deviations_hist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">control_signal_hist</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">obs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">140</span><span class="p">):</span>
    <span class="n">left_deviation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">right_deviation</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">left_found</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span>
    <span class="n">right_found</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.01</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">left_found</span><span class="p">:</span>
        <span class="n">left_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">right_found</span><span class="p">:</span>
        <span class="n">right_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">control_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">calc_ipsilateral_speed</span><span class="p">(</span><span class="n">left_deviation</span><span class="p">,</span> <span class="n">left_found</span><span class="p">),</span>
            <span class="n">calc_ipsilateral_speed</span><span class="p">(</span><span class="n">right_deviation</span><span class="p">,</span> <span class="n">right_found</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">obs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">control_signal</span><span class="p">)</span>
    <span class="n">obs_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">deviations_hist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">left_deviation</span><span class="p">,</span> <span class="n">right_deviation</span><span class="p">])</span>
    <span class="n">control_signal_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control_signal</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>100%|██████████| 140/140 [02:05&lt;00:00,  1.11it/s]
</pre></div>
</div>
<p>To inspect the recorded video:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cam</span><span class="o">.</span><span class="n">save_video</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;object_following.mp4&quot;</span><span class="p">)</span>
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/vision_basics/object_following.mp4" controls="controls" style="max-width: 400px;"></video><p>We can use the <code class="docutils literal notranslate"><span class="pre">save_video_with_vision_insets</span></code> utility function to
regenerate this video, but with insets at the bottom illustrating the
visual experience of the fly:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flygym.vision.visualize</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_video_with_vision_insets</span>

<span class="n">save_video_with_vision_insets</span><span class="p">(</span>
    <span class="n">sim</span><span class="p">,</span>
    <span class="n">cam</span><span class="p">,</span>
    <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;object_following_with_retina_images.mp4&quot;</span><span class="p">,</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">visual_inputs_hist</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<video src="https://raw.githubusercontent.com/NeLy-EPFL/_media/main/flygym/vision_basics/object_following_with_retina_images.mp4" controls="controls" style="max-width: 400px;"></video></section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="olfaction_basics.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Olfaction basics</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="turning.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Encapsulating custom code into Gym environments: A turning controller</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; Neuroengineering Laboratory, EPFL
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/NeLy-EPFL/flygym" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Vision basics</a><ul>
<li><a class="reference internal" href="#retina-simulation">Retina simulation</a></li>
<li><a class="reference internal" href="#a-dynamic-arena-with-a-moving-sphere">A dynamic arena with a moving sphere</a></li>
<li><a class="reference internal" href="#visual-feature-preprocessing">Visual feature preprocessing</a></li>
<li><a class="reference internal" href="#implementing-a-object-tracking-controller">Implementing a object tracking controller</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>